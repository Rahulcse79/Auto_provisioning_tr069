var e,t,n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(){if(t)return e;function n(e,t,n,r,s,o){return{tag:e,key:t,attrs:n,children:r,text:s,dom:o,domSize:void 0,state:void 0,events:void 0,instance:void 0}}return t=1,n.normalize=function(e){return Array.isArray(e)?n("[",void 0,void 0,n.normalizeChildren(e),void 0,void 0):null==e||"boolean"==typeof e?null:"object"==typeof e?e:n("#",void 0,void 0,String(e),void 0,void 0)},n.normalizeChildren=function(e){var t=[];if(e.length){for(var r=null!=e[0]&&null!=e[0].key,s=1;s<e.length;s++)if((null!=e[s]&&null!=e[s].key)!==r)throw new TypeError(!r||null==e[s]&&"boolean"!=typeof e[s]?"In fragments, vnodes must either all have keys or none have keys.":"In fragments, vnodes must either all have keys or none have keys. You may wish to consider using an explicit keyed empty fragment, m.fragment({key: ...}), instead of a hole.");for(s=0;s<e.length;s++)t[s]=n.normalize(e[s])}return t},e=n}var s=r(),o=function(){var e,t=arguments[this],n=this+1;if(null==t?t={}:("object"!=typeof t||null!=t.tag||Array.isArray(t))&&(t={},n=this),arguments.length===n+1)e=arguments[n],Array.isArray(e)||(e=[e]);else for(e=[];n<arguments.length;)e.push(arguments[n++]);return s("",t.key,t,e)},i={}.hasOwnProperty,a=r(),l=o,c=i,u=/(?:(^|#|\.)([^#\.\[\]]+))|(\[(.+?)(?:\s*=\s*("|'|)((?:\\["'\]]|.)*?)\5)?\])/g,f={};function d(e){for(var t in e)if(c.call(e,t))return!1;return!0}function h(e){for(var t,n="div",r=[],s={};t=u.exec(e);){var o=t[1],i=t[2];if(""===o&&""!==i)n=i;else if("#"===o)s.id=i;else if("."===o)r.push(i);else if("["===t[3][0]){var a=t[6];a&&(a=a.replace(/\\(["'])/g,"$1").replace(/\\\\/g,"\\")),"class"===t[4]?r.push(a):s[t[4]]=""===a?a:a||!0}}return r.length>0&&(s.className=r.join(" ")),f[e]={tag:n,attrs:s}}function p(e,t){var n=t.attrs,r=c.call(n,"class"),s=r?n.class:n.className;if(t.tag=e.tag,t.attrs={},!d(e.attrs)&&!d(n)){var o={};for(var i in n)c.call(n,i)&&(o[i]=n[i]);n=o}for(var i in e.attrs)c.call(e.attrs,i)&&"className"!==i&&!c.call(n,i)&&(n[i]=e.attrs[i]);for(var i in null==s&&null==e.attrs.className||(n.className=null!=s?null!=e.attrs.className?String(e.attrs.className)+" "+String(s):s:null!=e.attrs.className?e.attrs.className:null),r&&(n.class=null),n)if(c.call(n,i)&&"key"!==i){t.attrs=n;break}return t}var m=function(e){if(null==e||"string"!=typeof e&&"function"!=typeof e&&"function"!=typeof e.view)throw Error("The selector must be either a string or a component.");var t=l.apply(1,arguments);return"string"==typeof e&&(t.children=a.normalizeChildren(t.children),"["!==e)?p(f[e]||h(e),t):(t.tag=e,t)},g=r(),v=r(),w=o,y=m;y.trust=function(e){return null==e&&(e=""),g("<",void 0,void 0,e,void 0,void 0)},y.fragment=function(){var e=w.apply(0,arguments);return e.tag="[",e.children=v.normalizeChildren(e.children),e};var b,A,x=y,S={exports:{}};function C(){if(A)return b;A=1;var e=function(t){if(!(this instanceof e))throw new Error("Promise must be called with 'new'.");if("function"!=typeof t)throw new TypeError("executor must be a function.");var n=this,r=[],s=[],o=c(r,!0),i=c(s,!1),a=n._instance={resolvers:r,rejectors:s},l="function"==typeof setImmediate?setImmediate:setTimeout;function c(e,t){return function o(c){var f;try{if(!t||null==c||"object"!=typeof c&&"function"!=typeof c||"function"!=typeof(f=c.then))l((function(){t||0!==e.length||console.error("Possible unhandled promise rejection:",c);for(var n=0;n<e.length;n++)e[n](c);r.length=0,s.length=0,a.state=t,a.retry=function(){o(c)}}));else{if(c===n)throw new TypeError("Promise can't be resolved with itself.");u(f.bind(c))}}catch(e){i(e)}}}function u(e){var t=0;function n(e){return function(n){t++>0||e(n)}}var r=n(i);try{e(n(o),r)}catch(e){r(e)}}u(t)};return e.prototype.then=function(t,n){var r,s,o=this._instance;function i(e,t,n,i){t.push((function(t){if("function"!=typeof e)n(t);else try{r(e(t))}catch(e){s&&s(e)}})),"function"==typeof o.retry&&i===o.state&&o.retry()}var a=new e((function(e,t){r=e,s=t}));return i(t,o.resolvers,r,!0),i(n,o.rejectors,s,!1),a},e.prototype.catch=function(e){return this.then(null,e)},e.prototype.finally=function(t){return this.then((function(n){return e.resolve(t()).then((function(){return n}))}),(function(n){return e.resolve(t()).then((function(){return e.reject(n)}))}))},e.resolve=function(t){return t instanceof e?t:new e((function(e){e(t)}))},e.reject=function(t){return new e((function(e,n){n(t)}))},e.all=function(t){return new e((function(e,n){var r=t.length,s=0,o=[];if(0===t.length)e([]);else for(var i=0;i<t.length;i++)!function(i){function a(t){s++,o[i]=t,s===r&&e(o)}null==t[i]||"object"!=typeof t[i]&&"function"!=typeof t[i]||"function"!=typeof t[i].then?a(t[i]):t[i].then(a,n)}(i)}))},e.race=function(t){return new e((function(e,n){for(var r=0;r<t.length;r++)t[r].then(e,n)}))},b=e}var E=C();"undefined"!=typeof window?(void 0===window.Promise?window.Promise=E:window.Promise.prototype.finally||(window.Promise.prototype.finally=E.prototype.finally),S.exports=window.Promise):void 0!==n?(void 0===n.Promise?n.Promise=E:n.Promise.prototype.finally||(n.Promise.prototype.finally=E.prototype.finally),S.exports=n.Promise):S.exports=E;var k,O,$,N,P,D,_=r(),j=function(e){var t,n=e&&e.document,r={svg:"http://www.w3.org/2000/svg",math:"http://www.w3.org/1998/Math/MathML"};function s(e){return e.attrs&&e.attrs.xmlns||r[e.tag]}function o(e,t){if(e.state!==t)throw new Error("'vnode.state' must not be modified.")}function i(e){var t=e.state;try{return this.apply(t,arguments)}finally{o(e,t)}}function a(){try{return n.activeElement}catch(e){return null}}function l(e,t,n,r,s,o,i){for(var a=n;a<r;a++){var l=t[a];null!=l&&c(e,l,s,i,o)}}function c(e,t,r,o,a){var u=t.tag;if("string"==typeof u)switch(t.state={},null!=t.attrs&&R(t.attrs,t,r),u){case"#":!function(e,t,r){t.dom=n.createTextNode(t.children),y(e,t.dom,r)}(e,t,a);break;case"<":f(e,t,o,a);break;case"[":!function(e,t,r,s,o){var i=n.createDocumentFragment();if(null!=t.children){var a=t.children;l(i,a,0,a.length,r,null,s)}t.dom=i.firstChild,t.domSize=i.childNodes.length,y(e,i,o)}(e,t,r,o,a);break;default:!function(e,t,r,o,i){var a=t.tag,c=t.attrs,u=c&&c.is,f=(o=s(t)||o)?u?n.createElementNS(o,a,{is:u}):n.createElementNS(o,a):u?n.createElement(a,{is:u}):n.createElement(a);t.dom=f,null!=c&&function(e,t,n){"input"===e.tag&&null!=t.type&&e.dom.setAttribute("type",t.type);var r=null!=t&&"input"===e.tag&&"file"===t.type;for(var s in t)k(e,s,null,t[s],n,r)}(t,c,o);if(y(e,f,i),!b(t)&&null!=t.children){var d=t.children;l(f,d,0,d.length,r,null,o),"select"===t.tag&&null!=c&&function(e,t){if("value"in t)if(null===t.value)-1!==e.dom.selectedIndex&&(e.dom.value=null);else{var n=""+t.value;e.dom.value===n&&-1!==e.dom.selectedIndex||(e.dom.value=n)}"selectedIndex"in t&&k(e,"selectedIndex",null,t.selectedIndex,void 0)}(t,c)}}(e,t,r,o,a)}else!function(e,t,n,r,s){(function(e,t){var n;if("function"==typeof e.tag.view){if(e.state=Object.create(e.tag),null!=(n=e.state.view).$$reentrantLock$$)return;n.$$reentrantLock$$=!0}else{if(e.state=void 0,null!=(n=e.tag).$$reentrantLock$$)return;n.$$reentrantLock$$=!0,e.state=null!=e.tag.prototype&&"function"==typeof e.tag.prototype.view?new e.tag(e):e.tag(e)}R(e.state,e,t),null!=e.attrs&&R(e.attrs,e,t);if(e.instance=_.normalize(i.call(e.state.view,e)),e.instance===e)throw Error("A view cannot return the vnode it received as argument");n.$$reentrantLock$$=null})(t,n),null!=t.instance?(c(e,t.instance,n,r,s),t.dom=t.instance.dom,t.domSize=null!=t.dom?t.instance.domSize:0):t.domSize=0}(e,t,r,o,a)}var u={caption:"table",thead:"table",tbody:"table",tfoot:"table",tr:"tbody",th:"tr",td:"tr",colgroup:"table",col:"colgroup"};function f(e,t,r,s){var o=t.children.match(/^\s*?<(\w+)/im)||[],i=n.createElement(u[o[1]]||"div");"http://www.w3.org/2000/svg"===r?(i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg">'+t.children+"</svg>",i=i.firstChild):i.innerHTML=t.children,t.dom=i.firstChild,t.domSize=i.childNodes.length,t.instance=[];for(var a,l=n.createDocumentFragment();a=i.firstChild;)t.instance.push(a),l.appendChild(a);y(e,l,s)}function d(e,t,n,r,s,o){if(t!==n&&(null!=t||null!=n))if(null==t||0===t.length)l(e,n,0,n.length,r,s,o);else if(null==n||0===n.length)A(e,t,0,t.length);else{var i=null!=t[0]&&null!=t[0].key,a=null!=n[0]&&null!=n[0].key,u=0,f=0;if(!i)for(;f<t.length&&null==t[f];)f++;if(!a)for(;u<n.length&&null==n[u];)u++;if(i!==a)A(e,t,f,t.length),l(e,n,u,n.length,r,s,o);else if(a){for(var d,w,y,b,S,C=t.length-1,E=n.length-1;C>=f&&E>=u&&(y=t[C],b=n[E],y.key===b.key);)y!==b&&h(e,y,b,r,s,o),null!=b.dom&&(s=b.dom),C--,E--;for(;C>=f&&E>=u&&(d=t[f],w=n[u],d.key===w.key);)f++,u++,d!==w&&h(e,d,w,r,g(t,f,s),o);for(;C>=f&&E>=u&&u!==E&&d.key===b.key&&y.key===w.key;)v(e,y,S=g(t,f,s)),y!==w&&h(e,y,w,r,S,o),++u<=--E&&v(e,d,s),d!==b&&h(e,d,b,r,s,o),null!=b.dom&&(s=b.dom),f++,y=t[--C],b=n[E],d=t[f],w=n[u];for(;C>=f&&E>=u&&y.key===b.key;)y!==b&&h(e,y,b,r,s,o),null!=b.dom&&(s=b.dom),E--,y=t[--C],b=n[E];if(u>E)A(e,t,f,C+1);else if(f>C)l(e,n,u,E+1,r,s,o);else{var k,O,$=s,N=E-u+1,P=new Array(N),D=0,_=0,j=2147483647,I=0;for(_=0;_<N;_++)P[_]=-1;for(_=E;_>=u;_--){null==k&&(k=p(t,f,C+1));var z=k[(b=n[_]).key];null!=z&&(j=z<j?z:-1,P[_-u]=z,y=t[z],t[z]=null,y!==b&&h(e,y,b,r,s,o),null!=b.dom&&(s=b.dom),I++)}if(s=$,I!==C-f+1&&A(e,t,f,C+1),0===I)l(e,n,u,E+1,r,s,o);else if(-1===j)for(O=function(e){var t=[0],n=0,r=0,s=0,o=m.length=e.length;for(s=0;s<o;s++)m[s]=e[s];for(s=0;s<o;++s)if(-1!==e[s]){var i=t[t.length-1];if(e[i]<e[s])m[s]=i,t.push(s);else{for(n=0,r=t.length-1;n<r;){var a=(n>>>1)+(r>>>1)+(n&r&1);e[t[a]]<e[s]?n=a+1:r=a}e[s]<e[t[n]]&&(n>0&&(m[s]=t[n-1]),t[n]=s)}}n=t.length,r=t[n-1];for(;n-- >0;)t[n]=r,r=m[r];return m.length=0,t}(P),D=O.length-1,_=E;_>=u;_--)w=n[_],-1===P[_-u]?c(e,w,r,o,s):O[D]===_-u?D--:v(e,w,s),null!=w.dom&&(s=n[_].dom);else for(_=E;_>=u;_--)w=n[_],-1===P[_-u]&&c(e,w,r,o,s),null!=w.dom&&(s=n[_].dom)}}else{var M=t.length<n.length?t.length:n.length;for(u=u<f?u:f;u<M;u++)(d=t[u])===(w=n[u])||null==d&&null==w||(null==d?c(e,w,r,o,g(t,u+1,s)):null==w?x(e,d):h(e,d,w,r,g(t,u+1,s),o));t.length>M&&A(e,t,u,t.length),n.length>M&&l(e,n,u,n.length,r,s,o)}}}function h(e,t,n,r,o,a){var l=t.tag;if(l===n.tag){if(n.state=t.state,n.events=t.events,function(e,t){do{var n;if(null!=e.attrs&&"function"==typeof e.attrs.onbeforeupdate)if(void 0!==(n=i.call(e.attrs.onbeforeupdate,e,t))&&!n)break;if("string"!=typeof e.tag&&"function"==typeof e.state.onbeforeupdate)if(void 0!==(n=i.call(e.state.onbeforeupdate,e,t))&&!n)break;return!1}while(0);return e.dom=t.dom,e.domSize=t.domSize,e.instance=t.instance,e.attrs=t.attrs,e.children=t.children,e.text=t.text,!0}(n,t))return;if("string"==typeof l)switch(null!=n.attrs&&T(n.attrs,n,r),l){case"#":!function(e,t){e.children.toString()!==t.children.toString()&&(e.dom.nodeValue=t.children);t.dom=e.dom}(t,n);break;case"<":!function(e,t,n,r,s){t.children!==n.children?(S(e,t),f(e,n,r,s)):(n.dom=t.dom,n.domSize=t.domSize,n.instance=t.instance)}(e,t,n,a,o);break;case"[":!function(e,t,n,r,s,o){d(e,t.children,n.children,r,s,o);var i=0,a=n.children;if(n.dom=null,null!=a){for(var l=0;l<a.length;l++){var c=a[l];null!=c&&null!=c.dom&&(null==n.dom&&(n.dom=c.dom),i+=c.domSize||1)}1!==i&&(n.domSize=i)}}(e,t,n,r,o,a);break;default:!function(e,t,n,r){var o=t.dom=e.dom;r=s(t)||r,"textarea"===t.tag&&null==t.attrs&&(t.attrs={});(function(e,t,n,r){t&&t===n&&console.warn("Don't reuse attrs object, use new object for every redraw, this will throw in next major");if(null!=n){"input"===e.tag&&null!=n.type&&e.dom.setAttribute("type",n.type);var s="input"===e.tag&&"file"===n.type;for(var o in n)k(e,o,t&&t[o],n[o],r,s)}var i;if(null!=t)for(var o in t)null==(i=t[o])||null!=n&&null!=n[o]||O(e,o,i,r)})(t,e.attrs,t.attrs,r),b(t)||d(o,e.children,t.children,n,null,r)}(t,n,r,a)}else!function(e,t,n,r,s,o){if(n.instance=_.normalize(i.call(n.state.view,n)),n.instance===n)throw Error("A view cannot return the vnode it received as argument");T(n.state,n,r),null!=n.attrs&&T(n.attrs,n,r);null!=n.instance?(null==t.instance?c(e,n.instance,r,o,s):h(e,t.instance,n.instance,r,s,o),n.dom=n.instance.dom,n.domSize=n.instance.domSize):null!=t.instance?(x(e,t.instance),n.dom=void 0,n.domSize=0):(n.dom=t.dom,n.domSize=t.domSize)}(e,t,n,r,o,a)}else x(e,t),c(e,n,r,a,o)}function p(e,t,n){for(var r=Object.create(null);t<n;t++){var s=e[t];if(null!=s){var o=s.key;null!=o&&(r[o]=t)}}return r}var m=[];function g(e,t,n){for(;t<e.length;t++)if(null!=e[t]&&null!=e[t].dom)return e[t].dom;return n}function v(e,t,r){var s=n.createDocumentFragment();w(e,s,t),y(e,s,r)}function w(e,t,n){for(;null!=n.dom&&n.dom.parentNode===e;){if("string"!=typeof n.tag){if(null!=(n=n.instance))continue}else if("<"===n.tag)for(var r=0;r<n.instance.length;r++)t.appendChild(n.instance[r]);else if("["!==n.tag)t.appendChild(n.dom);else if(1===n.children.length){if(null!=(n=n.children[0]))continue}else for(r=0;r<n.children.length;r++){var s=n.children[r];null!=s&&w(e,t,s)}break}}function y(e,t,n){null!=n?e.insertBefore(t,n):e.appendChild(t)}function b(e){if(null==e.attrs||null==e.attrs.contenteditable&&null==e.attrs.contentEditable)return!1;var t=e.children;if(null!=t&&1===t.length&&"<"===t[0].tag){var n=t[0].children;e.dom.innerHTML!==n&&(e.dom.innerHTML=n)}else if(null!=t&&0!==t.length)throw new Error("Child node of a contenteditable must be trusted.");return!0}function A(e,t,n,r){for(var s=n;s<r;s++){var o=t[s];null!=o&&x(e,o)}}function x(e,t){var n,r,s,a=0,l=t.state;"string"!=typeof t.tag&&"function"==typeof t.state.onbeforeremove&&(null!=(s=i.call(t.state.onbeforeremove,t))&&"function"==typeof s.then&&(a=1,n=s));t.attrs&&"function"==typeof t.attrs.onbeforeremove&&(null!=(s=i.call(t.attrs.onbeforeremove,t))&&"function"==typeof s.then&&(a|=2,r=s));if(o(t,l),a){if(null!=n){var c=function(){1&a&&((a&=2)||u())};n.then(c,c)}if(null!=r){c=function(){2&a&&((a&=1)||u())};r.then(c,c)}}else E(t),C(e,t);function u(){o(t,l),E(t),C(e,t)}}function S(e,t){for(var n=0;n<t.instance.length;n++)e.removeChild(t.instance[n])}function C(e,t){for(;null!=t.dom&&t.dom.parentNode===e;){if("string"!=typeof t.tag){if(null!=(t=t.instance))continue}else if("<"===t.tag)S(e,t);else{if("["!==t.tag&&(e.removeChild(t.dom),!Array.isArray(t.children)))break;if(1===t.children.length){if(null!=(t=t.children[0]))continue}else for(var n=0;n<t.children.length;n++){var r=t.children[n];null!=r&&C(e,r)}}break}}function E(e){if("string"!=typeof e.tag&&"function"==typeof e.state.onremove&&i.call(e.state.onremove,e),e.attrs&&"function"==typeof e.attrs.onremove&&i.call(e.attrs.onremove,e),"string"!=typeof e.tag)null!=e.instance&&E(e.instance);else{var t=e.children;if(Array.isArray(t))for(var n=0;n<t.length;n++){var r=t[n];null!=r&&E(r)}}}function k(e,t,r,s,o,i){if(!("key"===t||"is"===t||null==s||$(t)||r===s&&!function(e,t){return"value"===t||"checked"===t||"selectedIndex"===t||"selected"===t&&e.dom===a()||"option"===e.tag&&e.dom.parentNode===n.activeElement}(e,t)&&"object"!=typeof s||"type"===t&&"input"===e.tag)){if("o"===t[0]&&"n"===t[1])return L(e,t,s);if("xlink:"===t.slice(0,6))e.dom.setAttributeNS("http://www.w3.org/1999/xlink",t.slice(6),s);else if("style"===t)z(e.dom,r,s);else if(N(e,t,o)){if("value"===t){if(("input"===e.tag||"textarea"===e.tag)&&e.dom.value===""+s&&(i||e.dom===a()))return;if("select"===e.tag&&null!==r&&e.dom.value===""+s)return;if("option"===e.tag&&null!==r&&e.dom.value===""+s)return;if(i&&""+s!="")return void console.error("`value` is read-only on file inputs!")}e.dom[t]=s}else"boolean"==typeof s?s?e.dom.setAttribute(t,""):e.dom.removeAttribute(t):e.dom.setAttribute("className"===t?"class":t,s)}}function O(e,t,n,r){if("key"!==t&&"is"!==t&&null!=n&&!$(t))if("o"===t[0]&&"n"===t[1])L(e,t,void 0);else if("style"===t)z(e.dom,n,null);else if(!N(e,t,r)||"className"===t||"title"===t||"value"===t&&("option"===e.tag||"select"===e.tag&&-1===e.dom.selectedIndex&&e.dom===a())||"input"===e.tag&&"type"===t){var s=t.indexOf(":");-1!==s&&(t=t.slice(s+1)),!1!==n&&e.dom.removeAttribute("className"===t?"class":t)}else e.dom[t]=null}function $(e){return"oninit"===e||"oncreate"===e||"onupdate"===e||"onremove"===e||"onbeforeremove"===e||"onbeforeupdate"===e}function N(e,t,n){return void 0===n&&(e.tag.indexOf("-")>-1||null!=e.attrs&&e.attrs.is||"href"!==t&&"list"!==t&&"form"!==t&&"width"!==t&&"height"!==t)&&t in e.dom}var P,D=/[A-Z]/g;function j(e){return"-"+e.toLowerCase()}function I(e){return"-"===e[0]&&"-"===e[1]?e:"cssFloat"===e?"float":e.replace(D,j)}function z(e,t,n){if(t===n);else if(null==n)e.style.cssText="";else if("object"!=typeof n)e.style.cssText=n;else if(null==t||"object"!=typeof t)for(var r in e.style.cssText="",n){null!=(s=n[r])&&e.style.setProperty(I(r),String(s))}else{for(var r in n){var s;null!=(s=n[r])&&(s=String(s))!==String(t[r])&&e.style.setProperty(I(r),s)}for(var r in t)null!=t[r]&&null==n[r]&&e.style.removeProperty(I(r))}}function M(){this._=t}function L(e,n,r){if(null!=e.events){if(e.events._=t,e.events[n]===r)return;null==r||"function"!=typeof r&&"object"!=typeof r?(null!=e.events[n]&&e.dom.removeEventListener(n.slice(2),e.events,!1),e.events[n]=void 0):(null==e.events[n]&&e.dom.addEventListener(n.slice(2),e.events,!1),e.events[n]=r)}else null==r||"function"!=typeof r&&"object"!=typeof r||(e.events=new M,e.dom.addEventListener(n.slice(2),e.events,!1),e.events[n]=r)}function R(e,t,n){"function"==typeof e.oninit&&i.call(e.oninit,t),"function"==typeof e.oncreate&&n.push(i.bind(e.oncreate,t))}function T(e,t,n){"function"==typeof e.onupdate&&n.push(i.bind(e.onupdate,t))}return M.prototype=Object.create(null),M.prototype.handleEvent=function(e){var t,n=this["on"+e.type];"function"==typeof n?t=n.call(e.currentTarget,e):"function"==typeof n.handleEvent&&n.handleEvent(e),this._&&!1!==e.redraw&&(0,this._)(),!1===t&&(e.preventDefault(),e.stopPropagation())},function(e,n,r){if(!e)throw new TypeError("DOM element being rendered to does not exist.");if(null!=P&&e.contains(P))throw new TypeError("Node is currently being rendered to and thus is locked.");var s=t,o=P,i=[],l=a(),c=e.namespaceURI;P=e,t="function"==typeof r?r:void 0;try{null==e.vnodes&&(e.textContent=""),n=_.normalizeChildren(Array.isArray(n)?n:[n]),d(e,e.vnodes,n,i,null,"http://www.w3.org/1999/xhtml"===c?void 0:c),e.vnodes=n,null!=l&&a()!==l&&"function"==typeof l.focus&&l.focus();for(var u=0;u<i.length;u++)i[u]()}finally{t=s,P=o}}}("undefined"!=typeof window?window:null),I=r(),z=function(e,t,n){var r=[],s=!1,o=-1;function i(){for(o=0;o<r.length;o+=2)try{e(r[o],I(r[o+1]),a)}catch(e){n.error(e)}o=-1}function a(){s||(s=!0,t((function(){s=!1,i()})))}return a.sync=i,{mount:function(t,n){if(null!=n&&null==n.view&&"function"!=typeof n)throw new TypeError("m.mount expects a component, not a vnode.");var s=r.indexOf(t);s>=0&&(r.splice(s,2),s<=o&&(o-=2),e(t,[])),null!=n&&(r.push(t,n),e(t,I(n),a))},redraw:a}}(j,"undefined"!=typeof requestAnimationFrame?requestAnimationFrame:null,"undefined"!=typeof console?console:null);function M(){return O?k:(O=1,k=function(e){if("[object Object]"!==Object.prototype.toString.call(e))return"";var t=[];for(var n in e)r(n,e[n]);return t.join("&");function r(e,n){if(Array.isArray(n))for(var s=0;s<n.length;s++)r(e+"["+s+"]",n[s]);else if("[object Object]"===Object.prototype.toString.call(n))for(var s in n)r(e+"["+s+"]",n[s]);else t.push(encodeURIComponent(e)+(null!=n&&""!==n?"="+encodeURIComponent(n):""))}})}function L(){if(N)return $;N=1;var e=i;return $=Object.assign||function(t,n){for(var r in n)e.call(n,r)&&(t[r]=n[r])}}function R(){if(D)return P;D=1;var e=M(),t=L();return P=function(n,r){if(/:([^\/\.-]+)(\.{3})?:/.test(n))throw new SyntaxError("Template parameter names must be separated by either a '/', '-', or '.'.");if(null==r)return n;var s=n.indexOf("?"),o=n.indexOf("#"),i=o<0?n.length:o,a=s<0?i:s,l=n.slice(0,a),c={};t(c,r);var u=l.replace(/:([^\/\.-]+)(\.{3})?/g,(function(e,t,n){return delete c[t],null==r[t]?e:n?r[t]:encodeURIComponent(String(r[t]))})),f=u.indexOf("?"),d=u.indexOf("#"),h=d<0?u.length:d,p=f<0?h:f,m=u.slice(0,p);s>=0&&(m+=n.slice(s,i)),f>=0&&(m+=(s<0?"?":"&")+u.slice(f,h));var g=e(c);return g&&(m+=(s<0&&f<0?"?":"&")+g),o>=0&&(m+=n.slice(o)),d>=0&&(m+=(o<0?"":"&")+u.slice(d)),m},P}var T,U,F,V,W,q,B,J,K,H,Q,Y,Z=R(),G=i,X=S.exports,ee=function(e,t,n){var r=0;function s(e){return new t(e)}function o(e){return function(r,o){"string"!=typeof r?(o=r,r=r.url):null==o&&(o={});var i=new t((function(t,n){e(Z(r,o.params),o,(function(e){if("function"==typeof o.type)if(Array.isArray(e))for(var n=0;n<e.length;n++)e[n]=new o.type(e[n]);else e=new o.type(e);t(e)}),n)}));if(!0===o.background)return i;var a=0;function l(){0==--a&&"function"==typeof n&&n()}return function e(t){var n=t.then;return t.constructor=s,t.then=function(){a++;var r=n.apply(t,arguments);return r.then(l,(function(e){if(l(),0===a)throw e})),e(r)},t}(i)}}function i(e,t){for(var n in e.headers)if(G.call(e.headers,n)&&n.toLowerCase()===t)return!0;return!1}return s.prototype=t.prototype,s.__proto__=t,{request:o((function(t,n,r,s){var o,a=null!=n.method?n.method.toUpperCase():"GET",l=n.body,c=(null==n.serialize||n.serialize===JSON.serialize)&&!(l instanceof e.FormData||l instanceof e.URLSearchParams),u=n.responseType||("function"==typeof n.extract?"":"json"),f=new e.XMLHttpRequest,d=!1,h=!1,p=f,m=f.abort;for(var g in f.abort=function(){d=!0,m.call(this)},f.open(a,t,!1!==n.async,"string"==typeof n.user?n.user:void 0,"string"==typeof n.password?n.password:void 0),c&&null!=l&&!i(n,"content-type")&&f.setRequestHeader("Content-Type","application/json; charset=utf-8"),"function"==typeof n.deserialize||i(n,"accept")||f.setRequestHeader("Accept","application/json, text/*"),n.withCredentials&&(f.withCredentials=n.withCredentials),n.timeout&&(f.timeout=n.timeout),f.responseType=u,n.headers)G.call(n.headers,g)&&f.setRequestHeader(g,n.headers[g]);f.onreadystatechange=function(e){if(!d&&4===e.target.readyState)try{var o,i=e.target.status>=200&&e.target.status<300||304===e.target.status||/^file:\/\//i.test(t),a=e.target.response;if("json"===u){if(!e.target.responseType&&"function"!=typeof n.extract)try{a=JSON.parse(e.target.responseText)}catch(e){a=null}}else u&&"text"!==u||null==a&&(a=e.target.responseText);if("function"==typeof n.extract?(a=n.extract(e.target,n),i=!0):"function"==typeof n.deserialize&&(a=n.deserialize(a)),i)r(a);else{var l=function(){try{o=e.target.responseText}catch(e){o=a}var t=new Error(o);t.code=e.target.status,t.response=a,s(t)};0===f.status?setTimeout((function(){h||l()})):l()}}catch(e){s(e)}},f.ontimeout=function(e){h=!0;var t=new Error("Request timed out");t.code=e.target.status,s(t)},"function"==typeof n.config&&(f=n.config(f,n,t)||f)!==p&&(o=f.abort,f.abort=function(){d=!0,o.call(this)}),null==l?f.send():"function"==typeof n.serialize?f.send(n.serialize(l)):l instanceof e.FormData||l instanceof e.URLSearchParams?f.send(l):f.send(JSON.stringify(l))})),jsonp:o((function(t,n,s,o){var i=n.callbackName||"_mithril_"+Math.round(1e16*Math.random())+"_"+r++,a=e.document.createElement("script");e[i]=function(t){delete e[i],a.parentNode.removeChild(a),s(t)},a.onerror=function(){delete e[i],a.parentNode.removeChild(a),o(new Error("JSONP request failed"))},a.src=t+(t.indexOf("?")<0?"?":"&")+encodeURIComponent(n.callbackKey||"callback")+"="+encodeURIComponent(i),e.document.documentElement.appendChild(a)}))}}("undefined"!=typeof window?window:null,X,z.redraw);function te(){if(U)return T;function e(e){try{return decodeURIComponent(e)}catch(t){return e}}return U=1,T=function(t){if(""===t||null==t)return{};"?"===t.charAt(0)&&(t=t.slice(1));for(var n=t.split("&"),r={},s={},o=0;o<n.length;o++){var i=n[o].split("="),a=e(i[0]),l=2===i.length?e(i[1]):"";"true"===l?l=!0:"false"===l&&(l=!1);var c=a.split(/\]\[?|\[/),u=s;a.indexOf("[")>-1&&c.pop();for(var f=0;f<c.length;f++){var d=c[f],h=c[f+1],p=""==h||!isNaN(parseInt(h,10));if(""===d)null==r[a=c.slice(0,f).join()]&&(r[a]=Array.isArray(u)?u.length:0),d=r[a]++;else if("__proto__"===d)break;if(f===c.length-1)u[d]=l;else{var m=Object.getOwnPropertyDescriptor(u,d);null!=m&&(m=m.value),null==m&&(u[d]=m=p?[]:{}),u=m}}}return s},T}function ne(){if(V)return F;V=1;var e=te();return F=function(t){var n=t.indexOf("?"),r=t.indexOf("#"),s=r<0?t.length:r,o=n<0?s:n,i=t.slice(0,o).replace(/\/{2,}/g,"/");return i?("/"!==i[0]&&(i="/"+i),i.length>1&&"/"===i[i.length-1]&&(i=i.slice(0,-1))):i="/",{path:i,params:n<0?{}:e(t.slice(n+1,s))}}}function re(){if(q)return W;q=1;var e=ne();return W=function(t){var n=e(t),r=Object.keys(n.params),s=[],o=new RegExp("^"+n.path.replace(/:([^\/.-]+)(\.{3}|\.(?!\.)|-)?|[\\^$*+.()|\[\]{}]/g,(function(e,t,n){return null==t?"\\"+e:(s.push({k:t,r:"..."===n}),"..."===n?"(.*)":"."===n?"([^/]+)\\.":"([^/]+)"+(n||""))}))+"$");return function(e){for(var t=0;t<r.length;t++)if(n.params[r[t]]!==e.params[r[t]])return!1;if(!s.length)return o.test(e.path);var i=o.exec(e.path);if(null==i)return!1;for(t=0;t<s.length;t++)e.params[s[t].k]=s[t].r?i[t+1]:decodeURIComponent(i[t+1]);return!0}},W}function se(){if(J)return B;J=1;var e=i,t=new RegExp("^(?:key|oninit|oncreate|onbeforeupdate|onupdate|onbeforeremove|onremove)$");return B=function(n,r){var s={};if(null!=r)for(var o in n)e.call(n,o)&&!t.test(o)&&r.indexOf(o)<0&&(s[o]=n[o]);else for(var o in n)e.call(n,o)&&!t.test(o)&&(s[o]=n[o]);return s}}var oe=x,ie=ee,ae=z,le=function(){return oe.apply(this,arguments)};le.m=oe,le.trust=oe.trust,le.fragment=oe.fragment,le.Fragment="[",le.mount=ae.mount,le.route=function(){if(Y)return Q;Y=1;var e=z;return Q=function(){if(H)return K;H=1;var e=r(),t=m,n=S.exports,s=R(),o=ne(),i=re(),a=L(),l=se(),c={};function u(e){try{return decodeURIComponent(e)}catch(t){return e}}return K=function(r,f){var d,h,p,m,g,v,w=null==r?null:"function"==typeof r.setImmediate?r.setImmediate:r.setTimeout,y=n.resolve(),b=!1,A=!1,x=0,S=c,C={onbeforeupdate:function(){return!(!(x=x?2:1)||c===S)},onremove:function(){r.removeEventListener("popstate",O,!1),r.removeEventListener("hashchange",k,!1)},view:function(){if(x&&c!==S){var t=[e(p,m.key,m)];return S&&(t=S.render(t[0])),t}}},E=N.SKIP={};function k(){b=!1;var e=r.location.hash;"#"!==N.prefix[0]&&(e=r.location.search+e,"?"!==N.prefix[0]&&"/"!==(e=r.location.pathname+e)[0]&&(e="/"+e));var t=e.concat().replace(/(?:%[a-f89][a-f0-9])+/gim,u).slice(N.prefix.length),n=o(t);function s(e){console.error(e),$(h,null,{replace:!0})}a(n.params,r.history.state),function e(r){for(;r<d.length;r++)if(d[r].check(n)){var o=d[r].component,i=d[r].route,a=o,l=v=function(s){if(l===v){if(s===E)return e(r+1);p=null==s||"function"!=typeof s.view&&"function"!=typeof s?"div":s,m=n.params,g=t,v=null,S=o.render?o:null,2===x?f.redraw():(x=2,f.redraw.sync())}};return void(o.view||"function"==typeof o?(o={},l(a)):o.onmatch?y.then((function(){return o.onmatch(n.params,t,i)})).then(l,t===h?null:s):l("div"))}if(t===h)throw new Error("Could not resolve default route "+h+".");$(h,null,{replace:!0})}(0)}function O(){b||(b=!0,w(k))}function $(e,t,n){if(e=s(e,t),A){O();var o=n?n.state:null,i=n?n.title:null;n&&n.replace?r.history.replaceState(o,i,N.prefix+e):r.history.pushState(o,i,N.prefix+e)}else r.location.href=N.prefix+e}function N(e,t,n){if(!e)throw new TypeError("DOM element being rendered to does not exist.");if(d=Object.keys(n).map((function(e){if("/"!==e[0])throw new SyntaxError("Routes must start with a '/'.");if(/:([^\/\.-]+)(\.{3})?:/.test(e))throw new SyntaxError("Route parameter names must be separated with either '/', '.', or '-'.");return{route:e,component:n[e],check:i(e)}})),h=t,null!=t){var s=o(t);if(!d.some((function(e){return e.check(s)})))throw new ReferenceError("Default route doesn't match any known routes.")}"function"==typeof r.history.pushState?r.addEventListener("popstate",O,!1):"#"===N.prefix[0]&&r.addEventListener("hashchange",k,!1),A=!0,f.mount(e,C),k()}return N.set=function(e,t,n){null!=v&&((n=n||{}).replace=!0),v=null,$(e,t,n)},N.get=function(){return g},N.prefix="#!",N.Link={view:function(e){var n,r,o,i=t(e.attrs.selector||"a",l(e.attrs,["options","params","selector","onclick"]),e.children);return(i.attrs.disabled=Boolean(i.attrs.disabled))?(i.attrs.href=null,i.attrs["aria-disabled"]="true"):(n=e.attrs.options,r=e.attrs.onclick,o=s(i.attrs.href,e.attrs.params),i.attrs.href=N.prefix+o,i.attrs.onclick=function(e){var t;"function"==typeof r?t=r.call(e.currentTarget,e):null==r||"object"!=typeof r||"function"==typeof r.handleEvent&&r.handleEvent(e),!1===t||e.defaultPrevented||0!==e.button&&0!==e.which&&1!==e.which||e.currentTarget.target&&"_self"!==e.currentTarget.target||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||(e.preventDefault(),e.redraw=!1,N.set(o,null,n))}),i}},N.param=function(e){return m&&null!=e?m[e]:m},N},K}()("undefined"!=typeof window?window:null,e),Q}(),le.render=j,le.redraw=ae.redraw,le.request=ie.request,le.jsonp=ie.jsonp,le.parseQueryString=te(),le.buildQueryString=M(),le.parsePathname=ne(),le.buildPathname=R(),le.vnode=r(),le.PromisePolyfill=C(),le.censor=se();const ce=le,ue=()=>({view:e=>{const t={[e.attrs.page]:"active"},n=[];window.authorizer.hasAccess("devices",1)&&n.push(ce("li",{class:t.overview},ce("a",{href:"#!/overview",title:"Overview"},ce("i.material-icons","dashboard")))),window.authorizer.hasAccess("devices",2)&&n.push(ce("li",{class:t.devices},ce("a",{href:"#!/devices",title:"Devices"},ce("i.material-icons","devices")))),window.authorizer.hasAccess("faults",2)&&n.push(ce("li",{class:t.faults},ce("a",{href:"#!/faults",title:"Faults"},ce("i.material-icons","report_problem"))));const r=["presets","provisions","virtualParameters","files"];for(const e of r)if(window.authorizer.hasAccess(e,2)){n.push(ce("li",{class:t.admin},ce("a",{href:"#!/admin",title:"Admin"},ce("i.material-icons","admin_panel_settings"))));break}return ce("nav",ce("ul",n))}});function fe(e){if(!(this instanceof fe))return new fe(e);this._=e}var de=fe.prototype;function he(e,t){for(var n=0;n<e;n++)t(n)}function pe(e,t,n){return function(e,t){he(t.length,(function(n){e(t[n],n,t)}))}((function(n,r,s){t=e(t,n,r,s)}),n),t}function me(e,t){return pe((function(t,n,r,s){return t.concat([e(n,r,s)])}),[],t)}function ge(e){var t=pe((function(e,t,n,r){return e.concat(n===r.length-1?Buffer.from([t,0]).readUInt16BE(0):r.readUInt16BE(n))}),[],e);return Buffer.from(me((function(e){return(e<<1&65535)>>8}),t))}function ve(e){return e[0]>>7}function we(){return"undefined"!=typeof Buffer}function ye(){if(!we())throw new Error("Buffer global does not exist; please use webpack if you need to parse Buffers in the browser.")}function be(e){ye();var t=pe((function(e,t){return e+t}),0,e);if(t%8!=0)throw new Error("The bits ["+e.join(", ")+"] add up to "+t+" which is not an even number of bytes; the total should be divisible by 8");var n,r=t/8,s=(n=function(e){return e>48},pe((function(e,t){return e||(n(t)?t:e)}),null,e));if(s)throw new Error(s+" bit range requested exceeds 48 bit (6 byte) Number max.");return new fe((function(t,n){var s=r+n;return s>t.length?_e(n,r.toString()+" bytes"):De(s,pe((function(e,t){var n=function(e,t){var n={v:0,buf:t};return he(e,(function(){n={v:n.v<<1|ve(n.buf),buf:ge(n.buf)}})),n}(t,e.buf);return{coll:e.coll.concat(n.v),buf:n.buf}}),{coll:[],buf:t.slice(n,s)},e).coll)}))}function Ae(e,t){return new fe((function(n,r){return ye(),r+t>n.length?_e(r,t+" bytes for "+e):De(r+t,n.slice(r,r+t))}))}function xe(e,t){if("number"!=typeof(n=t)||Math.floor(n)!==n||t<0||t>6)throw new Error(e+" requires integer length in range [0, 6].");var n}function Se(e){return xe("uintBE",e),Ae("uintBE("+e+")",e).map((function(t){return t.readUIntBE(0,e)}))}function Ce(e){return xe("uintLE",e),Ae("uintLE("+e+")",e).map((function(t){return t.readUIntLE(0,e)}))}function Ee(e){return xe("intBE",e),Ae("intBE("+e+")",e).map((function(t){return t.readIntBE(0,e)}))}function ke(e){return xe("intLE",e),Ae("intLE("+e+")",e).map((function(t){return t.readIntLE(0,e)}))}function Oe(e){return Array.prototype.slice.call(e)}function $e(e){return e instanceof fe}function Ne(e){return"[object Array]"==={}.toString.call(e)}function Pe(e){return we()&&Buffer.isBuffer(e)}function De(e,t){return{status:!0,index:e,value:t,furthest:-1,expected:[]}}function _e(e,t){return Ne(t)||(t=[t]),{status:!1,index:-1,value:null,furthest:e,expected:t}}function je(e,t){if(!t)return e;if(e.furthest>t.furthest)return e;var n=e.furthest===t.furthest?function(e,t){if(function(){if(void 0!==fe._supportsSet)return fe._supportsSet;var e="undefined"!=typeof Set;return fe._supportsSet=e,e}()&&Array.from){for(var n=new Set(e),r=0;r<t.length;r++)n.add(t[r]);var s=Array.from(n);return s.sort(),s}for(var o={},i=0;i<e.length;i++)o[e[i]]=!0;for(var a=0;a<t.length;a++)o[t[a]]=!0;var l=[];for(var c in o)({}).hasOwnProperty.call(o,c)&&l.push(c);return l.sort(),l}(e.expected,t.expected):t.expected;return{status:e.status,index:e.index,value:e.value,furthest:t.furthest,expected:n}}var Ie={};function ze(e,t){if(Pe(e))return{offset:t,line:-1,column:-1};e in Ie||(Ie[e]={});for(var n=Ie[e],r=0,s=0,o=0,i=t;i>=0;){if(i in n){r=n[i].line,0===o&&(o=n[i].lineStart);break}("\n"===e.charAt(i)||"\r"===e.charAt(i)&&"\n"!==e.charAt(i+1))&&(s++,0===o&&(o=i+1)),i--}var a=r+s,l=t-o;return n[t]={line:a,lineStart:o},{offset:t,line:a+1,column:l+1}}function Me(e){if(!$e(e))throw new Error("not a parser: "+e)}function Le(e,t){return"string"==typeof e?e.charAt(t):e[t]}function Re(e){if("number"!=typeof e)throw new Error("not a number: "+e)}function Te(e){if(!(e instanceof RegExp))throw new Error("not a regexp: "+e);for(var t=Ke(e),n=0;n<t.length;n++){var r=t.charAt(n);if("i"!==r&&"m"!==r&&"u"!==r&&"s"!==r)throw new Error('unsupported regexp flag "'+r+'": '+e)}}function Ue(e){if("function"!=typeof e)throw new Error("not a function: "+e)}function Fe(e){if("string"!=typeof e)throw new Error("not a string: "+e)}function Ve(e,t){return new Array(t+1).join(e)}function We(e,t,n){var r=t-e.length;return r<=0?e:Ve(n,r)+e}function qe(e,t,n,r){return{from:e-t>0?e-t:0,to:e+n>r?r:e+n}}function Be(e,t){var n,r,s,o,i,a=t.index,l=a.offset,c=1;if(l===e.length)return"Got the end of the input";if(Pe(e)){var u=l-l%8,f=l-u,d=qe(u,40,40,e.length),h=function(e,t){var n=e.length,r=[],s=0;if(n<=t)return[e.slice()];for(var o=0;o<n;o++)r[s]||r.push([]),r[s].push(e[o]),(o+1)%t==0&&s++;return r}(e.slice(d.from,d.to).toJSON().data,8),p=me((function(e){return me((function(e){return We(e.toString(16),2,"0")}),e)}),h);o=function(e){return 0===e.from&&1===e.to?{from:e.from,to:e.to}:{from:e.from/8,to:Math.floor(e.to/8)}}(d),r=u/8,n=3*f,f>=4&&(n+=1),c=2,s=me((function(e){return e.length<=4?e.join(" "):e.slice(0,4).join(" ")+"  "+e.slice(4).join(" ")}),p),(i=(8*(o.to>0?o.to-1:o.to)).toString(16).length)<2&&(i=2)}else{var m=e.split(/\r\n|[\n\r\u2028\u2029]/);n=a.column-1,r=a.line-1,o=qe(r,2,3,m.length),s=m.slice(o.from,o.to),i=o.to.toString().length}var g=r-o.from;Pe(e)&&(i=(8*(o.to>0?o.to-1:o.to)).toString(16).length)<2&&(i=2);var v=pe((function(t,r,s){var a,l=s===g,u=l?"> ":"  ";return a=Pe(e)?We((8*(o.from+s)).toString(16),i,"0"):We((o.from+s+1).toString(),i," "),[].concat(t,[u+a+" | "+r],l?["  "+Ve(" ",i)+" | "+We("",n," ")+Ve("^",c)]:[])}),[],s);return v.join("\n")}function Je(e,t){return["\n","-- PARSING FAILED "+Ve("-",50),"\n\n",Be(e,t),"\n\n",(n=t.expected,1===n.length?"Expected:\n\n"+n[0]:"Expected one of the following: \n\n"+n.join(", ")),"\n"].join("");var n}function Ke(e){return void 0!==e.flags?e.flags:[e.global?"g":"",e.ignoreCase?"i":"",e.multiline?"m":"",e.unicode?"u":"",e.sticky?"y":""].join("")}function He(e){return RegExp("^(?:"+e.source+")",Ke(e))}function Qe(){for(var e=[].slice.call(arguments),t=e.length,n=0;n<t;n+=1)Me(e[n]);return fe((function(n,r){for(var s,o=new Array(t),i=0;i<t;i+=1){if(!(s=je(e[i]._(n,r),s)).status)return s;o[i]=s.value,r=s.index}return je(De(r,o),s)}))}function Ye(){var e=[].slice.call(arguments);if(0===e.length)throw new Error("seqMap needs at least one argument");var t=e.pop();return Ue(t),Qe.apply(null,e).map((function(e){return t.apply(null,e)}))}function Ze(){var e=[].slice.call(arguments),t=e.length;if(0===t)return rt("zero alternates");for(var n=0;n<t;n+=1)Me(e[n]);return fe((function(t,n){for(var r,s=0;s<e.length;s+=1)if((r=je(e[s]._(t,n),r)).status)return r;return r}))}function Ge(e,t){return Xe(e,t).or(nt([]))}function Xe(e,t){return Me(e),Me(t),Ye(e,t.then(e).many(),(function(e,t){return[e].concat(t)}))}function et(e){Fe(e);var t="'"+e+"'";return fe((function(n,r){var s=r+e.length,o=n.slice(r,s);return o===e?De(s,o):_e(r,t)}))}function tt(e,t){Te(e),arguments.length>=2?Re(t):t=0;var n=He(e),r=""+e;return fe((function(e,s){var o=n.exec(e.slice(s));if(o){if(0<=t&&t<=o.length){var i=o[0],a=o[t];return De(s+i.length,a)}return _e(s,"valid match group (0 to "+o.length+") in "+r)}return _e(s,r)}))}function nt(e){return fe((function(t,n){return De(n,e)}))}function rt(e){return fe((function(t,n){return _e(n,e)}))}function st(e){if($e(e))return fe((function(t,n){var r=e._(t,n);return r.index=n,r.value="",r}));if("string"==typeof e)return st(et(e));if(e instanceof RegExp)return st(tt(e));throw new Error("not a string, regexp, or parser: "+e)}function ot(e){return Me(e),fe((function(t,n){var r=e._(t,n),s=t.slice(n,r.index);return r.status?_e(n,'not "'+s+'"'):De(n,null)}))}function it(e){return Ue(e),fe((function(t,n){var r=Le(t,n);return n<t.length&&e(r)?De(n+1,r):_e(n,"a character/byte matching "+e)}))}function at(e,t){arguments.length<2&&(t=e,e=void 0);var n=fe((function(e,r){return n._=t()._,n._(e,r)}));return e?n.desc(e):n}function lt(){return rt("fantasy-land/empty")}de.parse=function(e){if("string"!=typeof e&&!Pe(e))throw new Error(".parse must be called with a string or Buffer as its argument");var t,n=this.skip(dt)._(e,0);return t=n.status?{status:!0,value:n.value}:{status:!1,index:ze(e,n.furthest),expected:n.expected},delete Ie[e],t},de.tryParse=function(e){var t=this.parse(e);if(t.status)return t.value;var n=Je(e,t),r=new Error(n);throw r.type="ParsimmonError",r.result=t,r},de.assert=function(e,t){return this.chain((function(n){return e(n)?nt(n):rt(t)}))},de.or=function(e){return Ze(this,e)},de.trim=function(e){return this.wrap(e,e)},de.wrap=function(e,t){return Ye(e,this,t,(function(e,t){return t}))},de.thru=function(e){return e(this)},de.then=function(e){return Me(e),Qe(this,e).map((function(e){return e[1]}))},de.many=function(){var e=this;return fe((function(t,n){for(var r=[],s=void 0;;){if(!(s=je(e._(t,n),s)).status)return je(De(n,r),s);if(n===s.index)throw new Error("infinite loop detected in .many() parser --- calling .many() on a parser which can accept zero characters is usually the cause");n=s.index,r.push(s.value)}}))},de.tieWith=function(e){return Fe(e),this.map((function(t){if(function(e){if(!Ne(e))throw new Error("not an array: "+e)}(t),t.length){Fe(t[0]);for(var n=t[0],r=1;r<t.length;r++)Fe(t[r]),n+=e+t[r];return n}return""}))},de.tie=function(){return this.tieWith("")},de.times=function(e,t){var n=this;return arguments.length<2&&(t=e),Re(e),Re(t),fe((function(r,s){for(var o=[],i=void 0,a=void 0,l=0;l<e;l+=1){if(a=je(i=n._(r,s),a),!i.status)return a;s=i.index,o.push(i.value)}for(;l<t&&(a=je(i=n._(r,s),a),i.status);l+=1)s=i.index,o.push(i.value);return je(De(s,o),a)}))},de.result=function(e){return this.map((function(){return e}))},de.atMost=function(e){return this.times(0,e)},de.atLeast=function(e){return Ye(this.times(e),this.many(),(function(e,t){return e.concat(t)}))},de.map=function(e){Ue(e);var t=this;return fe((function(n,r){var s=t._(n,r);return s.status?je(De(s.index,e(s.value)),s):s}))},de.contramap=function(e){Ue(e);var t=this;return fe((function(n,r){var s=t.parse(e(n.slice(r)));return s.status?De(r+n.length,s.value):s}))},de.promap=function(e,t){return Ue(e),Ue(t),this.contramap(e).map(t)},de.skip=function(e){return Qe(this,e).map((function(e){return e[0]}))},de.mark=function(){return Ye(ct,this,ct,(function(e,t,n){return{start:e,value:t,end:n}}))},de.node=function(e){return Ye(ct,this,ct,(function(t,n,r){return{name:e,value:n,start:t,end:r}}))},de.sepBy=function(e){return Ge(this,e)},de.sepBy1=function(e){return Xe(this,e)},de.lookahead=function(e){return this.skip(st(e))},de.notFollowedBy=function(e){return this.skip(ot(e))},de.desc=function(e){Ne(e)||(e=[e]);var t=this;return fe((function(n,r){var s=t._(n,r);return s.status||(s.expected=e),s}))},de.fallback=function(e){return this.or(nt(e))},de.ap=function(e){return Ye(e,this,(function(e,t){return e(t)}))},de.chain=function(e){var t=this;return fe((function(n,r){var s=t._(n,r);return s.status?je(e(s.value)._(n,s.index),s):s}))},de.concat=de.or,de.empty=lt,de.of=nt,de["fantasy-land/ap"]=de.ap,de["fantasy-land/chain"]=de.chain,de["fantasy-land/concat"]=de.concat,de["fantasy-land/empty"]=de.empty,de["fantasy-land/of"]=de.of,de["fantasy-land/map"]=de.map;var ct=fe((function(e,t){return De(t,ze(e,t))})),ut=fe((function(e,t){return t>=e.length?_e(t,"any character/byte"):De(t+1,Le(e,t))})),ft=fe((function(e,t){return De(e.length,e.slice(t))})),dt=fe((function(e,t){return t<e.length?_e(t,"EOF"):De(t,null)})),ht=tt(/[0-9]/).desc("a digit"),pt=tt(/[0-9]*/).desc("optional digits"),mt=tt(/[a-z]/i).desc("a letter"),gt=tt(/[a-z]*/i).desc("optional letters"),vt=tt(/\s*/).desc("optional whitespace"),wt=tt(/\s+/).desc("whitespace"),yt=et("\r"),bt=et("\n"),At=et("\r\n"),xt=Ze(At,bt,yt).desc("newline"),St=Ze(xt,dt);fe.all=ft,fe.alt=Ze,fe.any=ut,fe.cr=yt,fe.createLanguage=function(e){var t={};for(var n in e)({}).hasOwnProperty.call(e,n)&&function(n){t[n]=at((function(){return e[n](t)}))}(n);return t},fe.crlf=At,fe.custom=function(e){return fe(e(De,_e))},fe.digit=ht,fe.digits=pt,fe.empty=lt,fe.end=St,fe.eof=dt,fe.fail=rt,fe.formatError=Je,fe.index=ct,fe.isParser=$e,fe.lazy=at,fe.letter=mt,fe.letters=gt,fe.lf=bt,fe.lookahead=st,fe.makeFailure=_e,fe.makeSuccess=De,fe.newline=xt,fe.noneOf=function(e){return it((function(t){return e.indexOf(t)<0})).desc("none of '"+e+"'")},fe.notFollowedBy=ot,fe.of=nt,fe.oneOf=function(e){for(var t=e.split(""),n=0;n<t.length;n++)t[n]="'"+t[n]+"'";return it((function(t){return e.indexOf(t)>=0})).desc(t)},fe.optWhitespace=vt,fe.Parser=fe,fe.range=function(e,t){return it((function(n){return e<=n&&n<=t})).desc(e+"-"+t)},fe.regex=tt,fe.regexp=tt,fe.sepBy=Ge,fe.sepBy1=Xe,fe.seq=Qe,fe.seqMap=Ye,fe.seqObj=function(){for(var e={},t=0,n=Oe(arguments),r=n.length,s=0;s<r;s+=1){var o=n[s];if(!$e(o)){if(Ne(o)){var i=2===o.length&&"string"==typeof o[0]&&$e(o[1]);if(i){var a=o[0];if(Object.prototype.hasOwnProperty.call(e,a))throw new Error("seqObj: duplicate key "+a);e[a]=!0,t++;continue}}throw new Error("seqObj arguments must be parsers or [string, parser] array pairs.")}}if(0===t)throw new Error("seqObj expects at least one named parser, found zero");return fe((function(e,t){for(var s,o={},i=0;i<r;i+=1){var a,l;if(Ne(n[i])?(a=n[i][0],l=n[i][1]):(a=null,l=n[i]),!(s=je(l._(e,t),s)).status)return s;a&&(o[a]=s.value),t=s.index}return je(De(t,o),s)}))},fe.string=et,fe.succeed=nt,fe.takeWhile=function(e){return Ue(e),fe((function(t,n){for(var r=n;r<t.length&&e(Le(t,r));)r++;return De(r,t.slice(n,r))}))},fe.test=it,fe.whitespace=wt,fe["fantasy-land/empty"]=lt,fe["fantasy-land/of"]=nt,fe.Binary={bitSeq:be,bitSeqObj:function(e){ye();var t={},n=0,r=me((function(e){if(Ne(e)){var r=e;if(2!==r.length)throw new Error("["+r.join(", ")+"] should be length 2, got length "+r.length);if(Fe(r[0]),Re(r[1]),Object.prototype.hasOwnProperty.call(t,r[0]))throw new Error("duplicate key in bitSeqObj: "+r[0]);return t[r[0]]=!0,n++,r}return Re(e),[null,e]}),e);if(n<1)throw new Error("bitSeqObj expects at least one named pair, got ["+e.join(", ")+"]");var s=me((function(e){return e[0]}),r);return be(me((function(e){return e[1]}),r)).map((function(e){return pe((function(e,t){return null!==t[0]&&(e[t[0]]=t[1]),e}),{},me((function(t,n){return[t,e[n]]}),s))}))},byte:function(e){if(ye(),Re(e),e>255)throw new Error("Value specified to byte constructor ("+e+"=0x"+e.toString(16)+") is larger in value than a single byte.");var t=(e>15?"0x":"0x0")+e.toString(16);return fe((function(n,r){var s=Le(n,r);return s===e?De(r+1,s):_e(r,t)}))},buffer:function(e){return Ae("buffer",e).map((function(e){return Buffer.from(e)}))},encodedString:function(e,t){return Ae("string",t).map((function(t){return t.toString(e)}))},uintBE:Se,uint8BE:Se(1),uint16BE:Se(2),uint32BE:Se(4),uintLE:Ce,uint8LE:Ce(1),uint16LE:Ce(2),uint32LE:Ce(4),intBE:Ee,int8BE:Ee(1),int16BE:Ee(2),int32BE:Ee(4),intLE:ke,int8LE:ke(1),int16LE:ke(2),int32LE:ke(4),floatBE:Ae("floatBE",4).map((function(e){return e.readFloatBE(0)})),floatLE:Ae("floatLE",4).map((function(e){return e.readFloatLE(0)})),doubleBE:Ae("doubleBE",8).map((function(e){return e.readDoubleBE(0)})),doubleLE:Ae("doubleLE",8).map((function(e){return e.readDoubleLE(0)}))};const Ct=fe;function Et(e){const t={b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};return e.replace(/\\(u[0-9a-fA-F]{4}|[^u])/g,((e,n)=>{const r=n.charAt(0),s=n.slice(1);return"u"===r?String.fromCharCode(parseInt(s,16)):t.hasOwnProperty(r)?t[r]:r}))}function kt(e,t){if(!Array.isArray(e))return t(e);let n;for(let r=1;r<e.length;++r){const s=kt(e[r],t);s!==e[r]&&(n=n||e.slice(),n[r]=s)}return t(n||e)}function Ot(e,t){return Ct.seqMap(t,Ct.seq(e,t).many(),((e,t)=>t.reduce(((e,t)=>{const[n,r]=t;return Array.isArray(e)&&n===e[0]?e.concat([r]):[n,e,r]}),e)))}const $t=Ct.createLanguage({ComparisonOperator:function(){return Ct.alt(Ct.string(">="),Ct.string("<>"),Ct.string("<="),Ct.string("="),Ct.string(">"),Ct.string("<")).skip(Ct.optWhitespace)},LikeOperator:function(){return Ct.alt(Ct.regexp(/like/i).result("LIKE").desc("LIKE"),Ct.regexp(/not\s+like/i).result("NOT LIKE").desc("NOT LIKE")).notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace)},IsNullOperator:function(){return Ct.alt(Ct.regexp(/is\s+null/i).result("IS NULL").desc("IS NULL"),Ct.regexp(/is\s+not\s+null/i).result("IS NOT NULL").desc("IS NOT NULL")).notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace)},NotOperator:function(){return Ct.regexp(/not/i).result("NOT").notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace).desc("NOT")},AndOperator:function(){return Ct.regexp(/and/i).result("AND").notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace).desc("AND")},OrOperator:function(){return Ct.regexp(/or/i).result("OR").notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace).desc("OR")},Parameter:function(e){return Ct.alt(Ct.regexp(/[a-zA-Z0-9_.*-]+/),e.Expression.wrap(Ct.string("{").skip(Ct.optWhitespace),Ct.string("}"))).atLeast(1).map((e=>["PARAM",e.length>1?["||"].concat(e):e[0]])).skip(Ct.optWhitespace).desc("parameter")},StringValueSql:function(){return Ct.regexp(/'([^']*)'/,1).atLeast(1).skip(Ct.optWhitespace).map((e=>e.join("'"))).desc("string")},StringValueJs:function(){return Ct.regexp(/"((?:\\.|.)*?)"/,1).skip(Ct.optWhitespace).map(Et).desc("string")},NumberValue:function(){return Ct.regexp(/-?(0|[1-9][0-9]*)([.][0-9]+)?([eE][+-]?[0-9]+)?/).notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace).map(Number).desc("number")},BooleanValue:function(){return Ct.alt(Ct.regexp(/true/i).result(!0).desc("TRUE"),Ct.regexp(/false/i).result(!1).desc("FALSE")).notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace)},NullValue:function(){return Ct.regexp(/null/i).notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace).result(null).desc("NULL")},FuncValue:function(e){return Ct.seqMap(Ct.regexp(/([a-zA-Z0-9_]+)/,1).skip(Ct.optWhitespace).desc("function"),e.ExpressionList.wrap(Ct.string("(").skip(Ct.optWhitespace),Ct.string(")").skip(Ct.optWhitespace)),((e,t)=>["FUNC",e.toUpperCase()].concat(t)))},WhenPair:function(e){return Ct.seq(Ct.regexp(/when/i).notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace).desc("WHEN").then(e.Expression),Ct.regexp(/then/i).notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace).desc("THEN").then(e.Expression))},CaseStatement:function(e){return Ct.seqMap(Ct.regexp(/case/i).result("CASE").notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace).desc("CASE"),e.WhenPair.many(),Ct.regexp(/else/i).notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/)).skip(Ct.optWhitespace).desc("ELSE").then(e.Expression).map((e=>[[!0,e]])).fallback(null).skip(Ct.regex(/end/i).notFollowedBy(Ct.regexp(/[a-zA-Z0-9_]/))).skip(Ct.optWhitespace),((...e)=>e.flat(2)))},Value:function(e){return Ct.alt(e.NullValue,e.BooleanValue,e.NumberValue,e.StringValueSql,e.StringValueJs,e.FuncValue,e.CaseStatement)},ValueExpression:function(e){return Ot(Ct.string("||").skip(Ct.optWhitespace),Ot(Ct.alt(Ct.string("+"),Ct.string("-")).skip(Ct.optWhitespace),Ot(Ct.alt(Ct.string("*"),Ct.string("/"),Ct.string("%")).skip(Ct.optWhitespace),Ct.alt(e.Value,e.Parameter,e.Expression.wrap(Ct.string("(").skip(Ct.optWhitespace),Ct.string(")").skip(Ct.optWhitespace))))))},Comparison:function(e){return Ct.alt(Ct.seqMap(e.ValueExpression,e.IsNullOperator,((e,t)=>[t,e])),Ct.seqMap(e.ValueExpression,e.ComparisonOperator,e.ValueExpression,((e,t,n)=>[t,e,n])),Ct.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression.skip(Ct.regexp(/escape/i).result("ESCAPE").skip(Ct.whitespace).desc("ESCAPE")),e.ValueExpression,((e,t,n,r)=>[t,e,n,r])),Ct.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression,((e,t,n)=>[t,e,n])))},ExpressionList:function(e){return e.Expression.sepBy(Ct.string(",").skip(Ct.optWhitespace))},Expression:function(e){return Ot(e.OrOperator,Ot(e.AndOperator,(t=e.NotOperator,n=e.Comparison.or(e.ValueExpression),Ct.seq(t,n).or(n)))).trim(Ct.optWhitespace);var t,n}});function Nt(e){return e?$t.Expression.tryParse(e):null}function Pt(e,t=0){if(!Array.isArray(e))return JSON.stringify(e);const n={OR:10,AND:11,NOT:12,"=":20,"<>":20,">":20,">=":20,"<":20,"<=":20,LIKE:20,"NOT LIKE":20,"IS NULL":20,"IS NOT NULL":20,"||":30,"+":31,"-":31,"*":32,"/":32,"%":32},r=e[0].toUpperCase();function s(e){return n[r]<=t?`(${e})`:e}if("FUNC"===r)return s(`${e[1]}(${e.slice(2).map((e=>Pt(e))).join(", ")})`);if("PARAM"===r)return"string"==typeof e[1]?s(e[1]):Array.isArray(e[1])&&"||"===e[1][0]?s(e[1].slice(1).map((e=>"string"==typeof e?e:`{${Pt(e)}}`)).join("")):s(`{${Pt(e[1])}}`);if("IS NULL"===r||"IS NOT NULL"===r)return s(`${Pt(e[1],n[r])} ${r}`);if("LIKE"===r||"NOT LIKE"===r)return e[3]?s(`${Pt(e[1],n[r])} ${r} ${Pt(e[2],n[r])} ESCAPE ${Pt(e[3],n[r])}`):s(`${Pt(e[1],n[r])} ${r} ${Pt(e[2],n[r])}`);if("CASE"===r){const t=["CASE"];for(let n=1;n<e.length-1;n+=2){if(!Array.isArray(e[n])&&e[n]){null!=e[n+1]&&t.push("ELSE",Pt(e[n+1]));break}t.push("WHEN",Pt(e[n]),"THEN",Pt(e[n+1]))}return t.push("END"),t.join(" ")}if(r in n){const t=e.slice(1).map(((t,r)=>Pt(t,n[e[0]]+Math.min(r-1,0))));return s("NOT"===r?`${r} ${t[0]}`:t.join(` ${r} `))}throw new Error(`Unrecognized operator ${e[0]}`)}function Dt(e,t){const n=e.split("");for(let e=0;e<n.length;++e){const r=n[e];if(r===t)n[e]=n[e+1]||"",n[e+1]="";else if("_"===r)n[e]="\\_";else if("%"===r)for(n[e]="\\%";"%"===n[e+1];)n[++e]=""}return n.filter((e=>e))}const _t=Array.isArray,jt=new WeakMap,It={};function zt(e,t){let n=!0;for(;n;){n=!1;for(let r=2;r<e.length;++r){const s=t(e[r-1],e[r],r-2);s!==It&&(n=!0,(e=e.slice()).splice(r-1,2,s))}}return 2===e.length?e[1]:e}function Mt(e,t="",n=""){const r={"-":"\\-","/":"\\/","\\":"\\/","^":"\\^",$:"\\$","*":"\\*","+":"\\+","?":"\\?",".":"\\.","(":"\\(",")":"\\)","|":"\\|","[":"\\[","]":"\\]","{":"\\{","}":"\\}","\\%":".*","\\_":"."};let s=Dt(e,t);if(!s.length)return new RegExp("^$",n);s=s.map((e=>r[e]||e)),s[0]=".*"===s[0]?"":"^"+s[0];const o=s.length-1;return s[o]=[".*",""].includes(s[o])?"":s[o]+"$",new RegExp(s.join(""),n)}function Lt(e,t){return"boolean"==typeof e&&(e=+e),"boolean"==typeof t&&(t=+t),typeof e!=typeof t?"string"==typeof e?1:-1:e>t?1:e<t?-1:0}function Rt(e){switch(typeof e){case"number":return e;case"boolean":return+e;case"string":return parseFloat(e)||0}}function Tt(e){switch(typeof e){case"string":return e;case"number":return e.toString();case"boolean":return(+e).toString()}}function Ut(e){if(!Array.isArray(e))return e;if("CASE"===e[0]){for(let t=1;t<e.length;t+=2){if(Array.isArray(e[t]))return e;if(e[t])return e[t+1]}return null}if("FUNC"===e[0]){if("COALESCE"===e[1]){const t=[];for(let n=2;n<e.length;++n){const r=e[n];if(null!=r&&(t.push(r),!Array.isArray(r)))break}return t.length?1===t.length?t[0]:["FUNC","COALESCE",...t]:null}if("UPPER"===e[1]){if(null==e[2])return null;if(!_t(e[2]))return Tt(e[2]).toUpperCase()}else if("LOWER"===e[1]){if(null==e[2])return null;if(!_t(e[2]))return Tt(e[2]).toLowerCase()}else if("ROUND"===e[1]){const t=e[2],n=e.length>3?e[3]:0;if(null==t||null==n)return null;if(!_t(t)&&!_t(n)){const e=10**n,r=t*e*(1+Number.EPSILON);return Math.round(r)/e}}}else if("PARAM"===e[0]){if(null==e[1])return null}else{if("AND"===e[0]){for(let t=1;t<e.length;++t)if(!Array.isArray(e[t])&&null!=e[t]&&!e[t])return!1;const t=[];for(let n=1;n<e.length;++n){const r=e[n];if(null==r)return null;Array.isArray(r)&&("AND"===r[0]?t.push(...r.slice(1)):t.push(r))}return!t.length||(1===t.length&&t.push(!0),["AND",...t])}if("OR"===e[0]){const t=[];for(let n=1;n<e.length;++n){const r=e[n];if(Array.isArray(r))"OR"===r[0]?t.push(...r.slice(1)):t.push(r);else if(r)return!0}return t.length?(1===t.length&&t.push(!1),["OR",...t]):!!e.some((e=>null==e))&&null}if("NOT"===e[0]){if(null==e[1])return null;if(!_t(e[1]))return!e[1];if("NOT"===e[1][0])return e[1][1]}else{if("IS NULL"===e[0])return _t(e[1])?e:null==e[1];if("IS NOT NULL"===e[0])return _t(e[1])?e:null!=e[1];if("LIKE"===e[0]){if(_t(e[1])||_t(e[2])||_t(e[3]))return e;if(null==e[1]||null==e[2]||e.length>=4&&null==e[3])return null;let t=jt.get(e);return t||(t=Mt(e[2],e[3]),jt.set(e,t)),t.test(e[1])}if("NOT LIKE"===e[0]){if(_t(e[1])||_t(e[2])||_t(e[3]))return e;if(null==e[1]||null==e[2]||e.length>=4&&null==e[3])return null;let t=jt.get(e);return t||(t=Mt(e[2],e[3]),jt.set(e,t)),!t.test(e[1])}if("="===e[0])return null==e[1]||null==e[2]?null:_t(e[1])||_t(e[2])?e:0===Lt(e[1],e[2]);if("<>"===e[0])return null==e[1]||null==e[2]?null:_t(e[1])||_t(e[2])?e:0!==Lt(e[1],e[2]);if(">"===e[0])return null==e[1]||null==e[2]?null:_t(e[1])||_t(e[2])?e:Lt(e[1],e[2])>0;if(">="===e[0])return null==e[1]||null==e[2]?null:_t(e[1])||_t(e[2])?e:Lt(e[1],e[2])>=0;if("<"===e[0])return null==e[1]||null==e[2]?null:_t(e[1])||_t(e[2])?e:Lt(e[1],e[2])<0;if("<="===e[0])return null==e[1]||null==e[2]?null:_t(e[1])||_t(e[2])?e:Lt(e[1],e[2])<=0;if("*"===e[0])return zt(e,((e,t)=>null==e||null==t?null:_t(e)||_t(t)?It:Rt(e)*Rt(t)));if("/"===e[0])return zt(e,((e,t,n)=>{if(null==e||null==t)return null;if(_t(e)||_t(t))return It;const r=Rt(e),s=Rt(t);return 0!==n?r*s:0===s?null:r/s}));if("+"===e[0])return zt(e,((e,t)=>null==e||null==t?null:_t(e)||_t(t)?It:Rt(e)+Rt(t)));if("-"===e[0])return zt(e,((e,t,n)=>null==e||null==t?null:_t(e)||_t(t)?It:0===n?Rt(e)-Rt(t):Rt(e)+Rt(t)));if("%"===e[0])return zt(e,((e,t,n)=>{if(null==e||null==t)return null;if(_t(e)||_t(t)||0!==n)return It;const r=Rt(e),s=Math.trunc(Rt(t));return 0===s?null:r%s}));if("||"===e[0])return zt(e,((e,t)=>null==e||null==t?null:_t(e)||_t(t)?It:Tt(e)+Tt(t)))}}return e}function Ft(e,t,n,r){return kt(e,(e=>{if(r&&(e=r(e)),!_t(e))return e;if("FUNC"===e[0]&&"NOW"===e[1]){if(n)return n}else if("PARAM"===e[0]){if(null==e[1])return null;if(t&&!_t(e[1])){let n;return n="function"==typeof t?t(e[1]):t[e[1]],null==n?null:("object"==typeof n&&(n=n.value?n.value[0]:null),n)}}return Ut(e)}))}function Vt(e,t){if(null!=e&&!e)return!1;if(null!=t&&!t)return!1;if(!Array.isArray(e)&&!Array.isArray(t))return null!=e&&null!=t||null;if(!Array.isArray(t)&&"AND"===e[0])return e;if(!Array.isArray(e)&&"AND"===t[0])return t;const n=["AND"];return Array.isArray(e)&&"AND"===e[0]?n.push(...e.slice(1)):n.push(e),Array.isArray(t)&&"AND"===t[0]?n.push(...t.slice(1)):n.push(t),n}function Wt(e,t){if(!Array.isArray(e)&&e)return!0;if(!Array.isArray(t)&&t)return!0;if(!Array.isArray(e)&&!Array.isArray(t))return(null==e||null==t)&&null;if(!Array.isArray(t)&&"OR"===e[0])return e;if(!Array.isArray(e)&&"OR"===t[0])return t;const n=["OR"];return Array.isArray(e)&&"OR"===e[0]?n.push(...e.slice(1)):n.push(e),Array.isArray(t)&&"OR"===t[0]?n.push(...t.slice(1)):n.push(t),n}let qt=new Map,Bt=new Map;const Jt=new WeakMap;function Kt(e){if(null===e)return"null";if(void 0===e)return"undefined";const t=typeof e;if("number"===t||"boolean"===t||"string"===t)return`${t}:${e}`;if("function"!==t&&"object"!==t)throw new Error(`Cannot memoize ${t} arguments`);let n=Jt.get(e);if(!n){n=`${t}:${Math.trunc(Math.random()*Number.MAX_SAFE_INTEGER).toString(36)}`,Jt.set(e,n)}return n}function Ht(e){const t=Kt(e);return(...n)=>{const r=JSON.stringify(n.map(Kt))+t;if(qt.has(r))return qt.get(r);let s;return Bt.has(r)?qt.set(r,s=Bt.get(r)):(qt.set(r,s=e(...n)),s instanceof Promise&&s.catch((()=>{qt.delete(r),Bt.delete(r)}))),s}}const Qt=setInterval((()=>{Bt=qt,qt=new Map}),12e4);Qt.unref&&Qt.unref();const Yt=new Set;function Zt(e,t,n){const r={type:e,message:t,timestamp:Date.now(),actions:n};return Yt.add(r),ce.redraw(),n||setTimeout((()=>{Gt(r)}),4e3),r}function Gt(e){Yt.delete(e),ce.redraw()}const Xt=window.clientConfig,en=window.configSnapshot,tn=window.genieacsVersion;function nn(e,t){return e&t}function rn(e,t){return e|t}function sn(e,t){return e^t}function on(e){return~e}function an(e,t){return e<<t}function ln(e,t){return e>>t}function cn(e){return Number(e)}function un(e,t){return e===t}function fn(e,t){return e!==t}function dn(e,t){return e>=t}function hn(e,t){return BigInt.asIntN(e,t)}const pn=BigInt,mn=pn(0),gn=pn(1),vn=on(mn),wn=pn(32),yn=[];for(let e=0;e<=512;++e){const t=an(gn,pn(e));yn.push(t)}const bn=yn.filter(((e,t)=>t%2==0)).reduce(((e,t)=>rn(e,t)));function An(e){const t=[];let n=0;for(;fn(e,mn);){let r=cn(hn(32,e));e=ln(e,wn);let s=Math.clz32(r);for(;s<32;){const e=31-s;t.push(n+e),r^=1<<e,s=Math.clz32(r)}n+=32}return t}function xn(e){const t=1431655765,n=[];let r=0;for(;fn(e,mn);){let s=cn(hn(32,e));s=s&t|s>>1&t,e=ln(e,wn);let o=Math.clz32(s);for(;o<32;){const e=31-o;n.push(r+e),s^=1<<e,o=Math.clz32(s)}r+=32}return n}function Sn(e,t){const n=new Map;for(const r of t){const t=r-r%2;if(n.has(t))continue;const s=new Set;for(const t of e)(t.set.has(r)||t.set.has(r+1))&&s.add(t);s.size&&n.set(t,s)}if(n.size<=1)return[e];for(const t of e){let r=-1;for(const[s,o]of n)if(o.has(t))if(-1!==r){if(n.set(r,new Set([...n.get(r),...o])),n.delete(s),1===n.size)return[e]}else r=s}return[...n.values()].map((e=>[...e]))}function Cn(e){return rn(an(nn(e,bn),gn),nn(ln(e,gn),bn))}function En(e,t=512){let n=0;for(;n<t&&fn(e,mn);++n)e=nn(e,e-gn);return n}class kn{constructor(e,t,n){this._bigint=e,this._set=t,this._hash=n}get bigint(){return this._bigint}get set(){return this._set}get hash(){return this._hash}raise(e){if(!this._set.has(e))return this;const t=sn(this._bigint,yn[e]),n=new Set(this._set);n.delete(e);const r=this._hash^1<<e;return new kn(t,n,r)}covers(e){return this.set.size<=e.set.size&&un(nn(this.bigint,e.bigint),this.bigint)}static parse(e){const t=e.split("");let n=mn,r=0;const s=new Set;for(const[e,o]of t.entries()){if("-"===o)continue;const t=2*e;if("0"===o)n=rn(n,yn[t]),s.add(t),r^=1<<t;else if("1"===o)n=rn(n,yn[t+1]),s.add(t+1),r^=2<<t;else{if("/"!==o)throw new Error("Invalid cube string");n=rn(n,yn[t]),s.add(t),n=rn(n,yn[t+1]),s.add(t+1),r^=3<<t}}return new kn(n,s,r)}toString(){let e=this.bigint.toString(2);e.length%2&&(e="0"+e);return e.match(/.{2}/g).reverse().map((e=>"00"===e?"-":"01"===e?"0":"10"===e?"1":"/")).join("")}static from(e){let t=mn,n=0;const r=new Set;for(const s of e)r.add(s),n^=1<<s,t=rn(t,yn[s]);return new kn(t,r,n)}static fromBigInt(e){let t=0;const n=new Set;let r=0,s=e;for(;fn(s,mn);){let e=cn(hn(32,s));t^=e,s=ln(s,wn);let o=Math.clz32(e);for(;o<32;){const t=31-o;n.add(r+t),e^=1<<t,o=Math.clz32(e)}r+=32}return new kn(e,n,t)}}class On{constructor(e,t,n){this._cubes=e,this._count=t,this._bigint=n}static from(e){const t=[];let n=mn;const r=[];for(const s of e){n=rn(n,s.bigint),t.push(s);for(const e of s.set){for(;r.length<=e+1-e%2;)r.push(0);++r[e]}}return new On(t,r,n)}get bigint(){return this._bigint}get cubes(){return this._cubes}count(e){return this._count[e]}filter(e){const t=this._count.slice();let n=this._bigint;const r=this._cubes.filter((r=>{if(e(r))return!0;for(const e of r.set)--t[e]||(n=sn(n,yn[e]));return!1}));return new On(r,t,n)}pop(){const e=this._cubes.pop();if(e){for(const t of e.set)--this._count[t]||(this._bigint=sn(this._bigint,yn[t]));return e}}push(e){const t=this._cubes.push(e);for(const t of e.set)++this._count[t];return this._bigint=rn(this._bigint,e.bigint),t}unshift(e){const t=this._cubes.unshift(e);for(const t of e.set)++this._count[t];return this._bigint=rn(this._bigint,e.bigint),t}}function $n(e,t=mn,n=nn(e.bigint,on(rn(t,Cn(t))))){let r=!1,s=!1;do{if(r=!1,e=e.filter((e=>{if(fn(nn(t,e.bigint),mn))return!1;const o=nn(e.bigint,n),i=En(o,2);return 1===i?(r=!0,t=rn(t,o),n=un(nn(bn,o),mn)?sn(n,ln(o,gn)):sn(n,an(o,gn)),!1):(0===i&&(s=!0),!0)})),s)return!0}while(r);if(e.cubes.length<=1)return!1;let o=-1,i=0,a=0,l=0;const c=xn(n=nn(e.bigint,n)),u=new Set;for(const r of c){const s=e.count(r),c=e.count(r+1),f=s+c;if(s&&c){if(f>=i){const e=Math.min(s,c);(f>i||e>a)&&(o=r,i=f,a=e)}}else{if(f===e.cubes.length)return!1;u.add(r),t=rn(t,yn[s?r:r+1]),n=sn(n,yn[s?r+1:r])}l=Math.max(l,f)}if(-1===o)return!1;if(3*l<e.cubes.length&&c.length-u.size>8){const r=Sn(e.cubes,c.filter((e=>!u.has(e))));if(r.length>1){for(const e of r)if(!$n(On.from(e),t,n))return!1;return!0}}return!!$n(e,rn(t,yn[o]),sn(n,yn[o+1]))&&$n(e,rn(t,yn[o+1]),sn(n,yn[o]))}function Nn(e,t=mn,n=e.bigint){let r=!1,s=!1;do{if(r=!1,e=e.filter((e=>{if(fn(nn(t,e.bigint),mn))return!1;const o=nn(e.bigint,n),i=En(o,2);return 1===i?(r=!0,t=rn(t,o),n=un(nn(bn,o),mn)?sn(n,ln(o,gn)):sn(n,an(o,gn)),!1):(0===i&&(s=!0),!0)})),s)return[]}while(r);if(!e.cubes.length)return[kn.fromBigInt(Cn(t))];n=nn(e.bigint,n);const o=[];if(1===e.cubes.length){const e=Cn(t);for(const t of An(n))o.push(kn.fromBigInt(rn(e,yn[1^t])));return o}let i=-1,a=0,l=0,c=0;const u=xn(n),f=new Set;for(const r of u){const s=e.count(r),u=e.count(r+1),d=s+u;if(s&&u){if(d>=a){const e=Math.min(s,u);(d>a||e>l)&&(i=r,a=d,l=e)}}else d===e.cubes.length&&(f.add(r),o.push(kn.fromBigInt(Cn(rn(t,yn[s?r:r+1])))),n=sn(n,yn[s?r:r+1]));c=Math.max(c,d)}if(3*c<e.cubes.length&&u.length-f.size>8){const r=Sn(e.cubes,u.filter((e=>!f.has(e))));if(r.length>1){let e=Nn(On.from(r.pop()),t,n);for(const s of r){if(!e.length)return o;const r=Nn(On.from(s),t,n),i=[];for(const t of e)for(const e of r)i.push(kn.fromBigInt(rn(t.bigint,e.bigint)));e=i}return[...o,...e]}}if(-1===i)return Pn(e,o,t,n),o;const d=Nn(e,rn(t,yn[i]),sn(n,yn[i+1]));let h=Nn(e,rn(t,yn[i+1]),sn(n,yn[i]));const p=3<<i,m=rn(yn[i],yn[i+1]),g=new Set;e:for(const[e,t]of d.entries()){const n=t.hash^p;for(const r of h)if(r.hash===n&&un(sn(t.bigint,r.bigint),m)){d[e]=kn.fromBigInt(nn(t.bigint,r.bigint)),g.add(r);continue e}}return g.size&&(h=h.filter((e=>!g.has(e)))),[...o,...d,...h]}function Pn(e,t,n,r){let s=!1,o=!1,i=512,a=mn;do{if(i=512,a=mn,s=!1,e=e.filter((e=>{if(fn(nn(n,e.bigint),mn))return!1;const t=nn(e.bigint,r),l=En(t,i);return 1===l?(s=!0,n=rn(n,t),!1):(l<i&&(a=t,i=l),0===l&&(o=!0),!0)})),o)return}while(s);if(!e.cubes.length)return void t.push(kn.fromBigInt(Cn(n)));const l=An(a);if(1===e.cubes.length){const e=Cn(n);for(const n of l)t.push(kn.fromBigInt(rn(e,yn[1^n])));return}let c=-1,u=0;for(const t of l){const n=e.count(t);n>u&&(c=t,u=n)}Pn(e,t,rn(n,yn[c]),r),Pn(e,t,n,sn(r,yn[c]))}function Dn(e,t){return $n(e,Cn(t.bigint))}function _n(e,t){return e%2-t%2||t-e}function jn(e,t,n,r){const s=Cn(e.bigint);let o=n.map((e=>new Set(An(nn(s,e.bigint)))));o=o.filter((e=>e.size));let i=t.map((t=>new Set(An(nn(e.bigint,sn(e.bigint,t.bigint))))));i=i.filter((e=>e.size));const a=new Set([...e.set].sort(_n)),l=[];for(let e=Math.max(...a);e>=0;--e)l.push(0);for(const e of i)for(const t of e)++l[t];for(;i.length&&o.length;){const t=new Set;for(const e of o)1===e.size&&t.add(e.values().next().value);if(t.size){for(const e of t)a.delete(1^e),o=o.filter((t=>!t.has(e))),i=i.filter((t=>!t.has(1^e)));const n=new Set(a);for(const e of o)for(const t of e)n.delete(1^t);for(const t of n)a.delete(t),e=e.raise(t),i=i.filter((e=>!(e.delete(t)&&!e.size)));if(!o.length||!i.length)break}const n=new Set;for(const e of i)1===e.size&&n.add(e.values().next().value);if(n.size){let t=0,s=-1;for(const o of[...n].sort(_n))l[o]>t&&r(o,e.set)&&(t=l[o],s=o);if(s>=0){a.delete(s),e=e.raise(s),i=i.filter((e=>!(e.delete(s)&&!e.size)));for(const e of o)e.delete(1^s);continue}}let s=0,c=-1;for(const t of a)l[t]>s&&r(t,e.set)&&(s=l[t],c=t);if(c<0){a.clear();break}a.delete(c),e=e.raise(c);for(const e of i)e.delete(c);for(const e of o)e.delete(1^c)}if(o.length){const e=Mn(o);for(const t of e)a.delete(1^t)}for(const t of a)r(t,e.set)&&(e=e.raise(t));return e}function In(e,t,n,r){let s=t.map((t=>new Set(An(nn(e.bigint,sn(e.bigint,t.bigint))))));s=s.filter((e=>e.size));const o=[...e.set],i=[];for(let e=Math.max(...o);e>=0;--e)i.push(0);for(const e of s)for(const t of e)++i[t];for(;o.length;){const t=new Set;for(const e of s)1===e.size&&t.add(e.values().next().value);o.sort(((e,n)=>+t.has(e)-+t.has(n)||i[e]-i[n]||_n(n,e)));const a=[];for(;o.length;){const t=o.pop();if(!r(t,e.set)){a.unshift(t);continue}const i=e.raise(t);if(!Dn(n,i)){s=s.filter((e=>!e.has(t))),o.push(...a);break}e=i;for(const e of s)e.delete(t);s=s.filter((e=>e.size)),o.push(...a.splice(0))}}return e}function zn(e,t,n,r,s){if(!e.length)return e;(e=e.slice()).sort(((e,t)=>e.set.size-t.set.size));const o=e[0];do{let o=e[0];r.has(o)||(o=n?jn(o,e,n,s):In(o,e,On.from([...e,...t]),s)),(e=e.filter((e=>!o.covers(e)))).push(o)}while(e[0].set.size>=o.set.size&&fn(e[0].bigint,o.bigint));return e}function Mn(e){let t=new Set;const n=function(e){const t=new Map,n=e.length;for(let e=0;e<n;++e)t.set(e,new Set);for(let r=0;r<n;++r){const s=e[r],o=t.get(r);for(let i=r+1;i<n;++i){const n=e[i];let a=!1;for(const e of s)if(n.has(e)){a=!0;break}if(!a){const e=t.get(i);o.add(i),e.add(r)}}}const r=Array.from(e.keys());r.sort(((e,n)=>t.get(n).size-t.get(e).size));let s=[],o=0,i=0;return function e(r,a,l){if(i>n)return;if(!a.length&&!l.length){if(++i,r.length>=s.length){const e=r.reduce(((e,n)=>e+t.get(n).size),0);(e>o||r.length>s.length)&&(s=r,o=e,i=0)}return}const c=new Set,u=t.get(a[0]);for(const n of a){if(u.has(n))continue;const o=t.get(n),i=a.filter((e=>o.has(e)&&!c.has(e))),f=l.filter((e=>o.has(e)));if(e([...r,n],i,f),s.length>r.length+a.length)return;l.push(n),c.add(n)}}([],r,[]),s.map((t=>e[t]))}(e);let r=e;for(const s of n){const n=new Map;for(const t of e)for(const e of t)if(s.has(e)){let r=n.get(e);r||n.set(e,r=new Set),r.add(t)}const[o,i]=Array.from(n).reduce(((e,t)=>t[1].size>e[1].size?t:e));r=r.filter((e=>!i.has(e))),t.add(o)}return t=function(e,t){let n=e.map((e=>new Set([...e].filter((e=>t.has(e))))));const r=new Set;for(;;){for(const e of n)if(1===e.size){const[t]=e;r.add(t)}if(n=n.filter((e=>{for(const t of e)if(r.has(t))return!1;return e.size>1})),!n.length)break;const e=new Map;for(const t of n){for(const n of t)e.has(n)||e.set(n,new Set);if(2===t.size){const[n,r]=t,s=e.get(n),o=e.get(r);s.add(r),o.add(n)}}const t=Array.from(e).reduce(((e,t)=>t[1].size<e[1].size?t:e))[0];for(const e of n)e.delete(t)}return r}(e,t),r.length&&(t=new Set([...t,...Mn(r)])),t}function Ln(e,t,n,r){let s=!1,o=!1;const i=[];do{if(s=!1,e=e.filter((e=>{if(fn(nn(n,e.bigint),mn))return!1;const a=nn(e.bigint,r),l=En(a,2);if(1===l&&!t.has(e))return s=!0,n=rn(n,a),r=un(nn(bn,a),mn)?sn(r,ln(a,gn)):sn(r,an(a,gn)),!1;if(0===l){const n=t.get(e);if(null!=n)return i.push(n),!1;o=!0}return!0})),o)return[]}while(s);if(e.cubes.length<=1)return[new Set(i)];let a=-1,l=0,c=0,u=0;const f=xn(r=nn(e.bigint,r)),d=new Set;for(const t of f){const s=e.count(t),o=e.count(t+1),i=s+o;if(s&&o){if(i>=l){const e=Math.min(s,o);(i>l||e>c)&&(a=t,l=i,c=e)}}else d.add(t),n=rn(n,yn[s?t:t+1]),r=sn(r,yn[s?t+1:t]);u=Math.max(u,i)}if(-1===a)return[new Set(i)];if(3*u<e.cubes.length&&f.length-d.size>8){const s=Sn(e.cubes,f.filter((e=>!d.has(e))));if(s.length>1){let e=[new Set(i)];for(const o of s){const s=e;e=Ln(On.from(o),t,n,r);const i=[];for(const t of e)for(const e of s)i.push(new Set([...t,...e]));e=i}return e}}let h=Ln(e,t,rn(n,yn[a]),sn(r,yn[a+1])),p=Ln(e,t,rn(n,yn[a+1]),sn(r,yn[a]));const m=new Set,g=new Set;for(const e of h)for(const t of p)if(e.size<=t.size){let n=!0;for(const r of e)if(!t.has(r)){n=!1;break}n&&g.delete(t)}else{let n=!0;for(const r of t)if(!e.has(r)){n=!1;break}n&&m.delete(e)}return m.size&&(h=h.filter((e=>!m.has(e)))),g.size&&(p=p.filter((e=>!g.has(e)))),[...h,...p].map((e=>new Set([...i,...e])))}function Rn(e,t,n){const r=function(e,t,n){const r=new Map,s=new WeakMap;for(const[t,n]of e.entries())s.set(n,t);const o=On.from([...e,...t,...n]);for(const t of e){const e=Cn(t.bigint),n=Ln(o,s,e,nn(o.bigint,on(rn(t.bigint,e))));for(const e of n){let t=0;for(const n of e)t^=1<<n;const n=r.get(t);if(!n){r.set(t,[e]);continue}let s=!1;e:for(const t of n)if(t.size===e.size){for(const n of t)if(!e.has(n))continue e;s=!0;break}s||n.push(e)}}return[...r.values()].flat()}(e,t,n),s=Mn(r);return e.filter(((e,t)=>s.has(t)))}function Tn(e,t){const[n,r]=function(e,t){const n=On.from([...t,...e]),r=[],s=[];for(let t=0;t<e.length;++t){const e=n.pop();Dn(n,e)?s.push(e):r.push(e),n.unshift(e)}return[r,s]}(e,t),s=function(e,t,n){const r=On.from([...n,...t]);return e.filter((e=>!Dn(r,e)))}(r,n,t),o=Rn(s,n,t);return[...n,...o]}function Un(e,t,n){let r=!1,s=!1;do{if(r=!1,e=e.filter((e=>{if(fn(nn(t,e.bigint),mn))return!1;const o=nn(e.bigint,n),i=En(o,2);return 1===i?(r=!0,t=rn(t,o),n=un(nn(bn,o),mn)?sn(n,ln(o,gn)):sn(n,an(o,gn)),!1):(0===i&&(s=!0),!0)})),s)return vn}while(r);if(e.cubes.length<=1)return t;let o=-1,i=0,a=0,l=0;const c=xn(n=nn(e.bigint,n));for(const t of c){const n=e.count(t),r=e.count(t+1),s=n+r;if(n&&r&&s>=i){const e=Math.min(n,r);(s>i||e>a)&&(o=t,i=s,a=e)}l=Math.max(l,s)}if(-1===o)return t;if(3*l<e.cubes.length&&c.length>8){const r=Sn(e.cubes,c);let s=vn;if(r.length>1){for(const e of r)s=nn(s,Un(On.from(e),t,n));return s}}return nn(Un(e,rn(t,yn[o]),sn(n,yn[o+1])),Un(e,rn(t,yn[o+1]),sn(n,yn[o])))}function Fn(e,t,n){!function(e){if(e.length<=1)return;const t=e.reduce(((e,t)=>t.set.size<=e.set.size?t:e));e.sort(((e,n)=>{const r=En(nn(e.bigint,t.bigint)),s=e.set.size-r+(t.set.size-r),o=En(nn(n.bigint,t.bigint));return s-(n.set.size-o+(t.set.size-o))}))}(e=e.slice());for(let r=e.length;r>0;--r){const r=e.shift(),s=Cn(r.bigint),o=rn(r.bigint,s),i=[...e,...t].filter((e=>un(nn(s,e.bigint),mn))),a=Un(On.from(i),s,on(o));dn(a,mn)&&(un(a,s)?(e.push(r),n.add(r)):e.push(kn.fromBigInt(Cn(a))))}return e}function Vn(e,t,n,r){const s=function(e,t){const n=[];for(let r=e.length;r>0;--r){const r=e.shift(),s=Cn(r.bigint),o=rn(r.bigint,s),i=[...e,...t].filter((e=>un(nn(s,e.bigint),mn))),a=Un(On.from(i),s,on(o));fn(a,s)&&dn(a,mn)&&n.push(kn.fromBigInt(Cn(a))),e.push(r)}return n}(e,t),o=[],i=r?null:On.from([...e,...t]);for(let e=s.length;e>0;--e){const e=s.shift(),t=r?jn(e,s,r,n):In(e,s,i,n);for(const e of s)t.covers(e)&&o.push(t);s.push(e)}return o.length?Tn([...e,...o],t):e}function Wn(e){return e.reduce(((e,t)=>e+t.set.size),0)}function qn(e,t,n,r=(()=>!0)){if(!e.length)return e;const s=new WeakSet,o=function(e,t){const n=[...t,...e],r=[];for(let t=0;t<e.length;++t){const e=n.pop(),t=Cn(e.bigint),s=[];for(const e of n){const n=nn(t,e.bigint),r=En(n,2);0===r?s.push(e):1===r&&s.push(kn.fromBigInt(sn(e.bigint,n)))}$n(On.from(s),t)||r.push(e),n.unshift(e)}return r}(e=Tn(e=zn(e,t,n,s,r),t),t);o.length&&(e=e.filter((e=>!o.includes(e))),t=[...t,...o]);let i=512*e.length;for(;;){let o=Fn(e,t,s);o=zn(o,t,n,s,r),o=Tn(o,t);let a=Wn(o);if(a<=i&&(e=o),a>=i&&(o=Vn(e,t,r,n),a=Wn(o),a<=i&&(e=o),a>=i))break;i=a}return[...o,...e]}function Bn(e){return e.map((e=>kn.from(e)))}function Jn(e){return e.map((e=>[...e.set]))}function Kn(e){return Jn(Nn(On.from(Bn(e))))}function Hn(e,t){return e+t}function Qn(e,t){return e*t}function Yn(e,t){return e/t}function Zn(e,t){return e%t}function Gn(e){return Number(e)}function Xn(e,t){return e!==t}function er(e,t){return e<t}const tr=BigInt,nr=tr(0),rr=tr(1),sr=tr(2),or=tr(-1);class ir{constructor(e){this.map=new Map,e?(this.map.set(e,1),this.sortedKeys=[e]):this.sortedKeys=[]}reciprocal(){const e=new ir;e.sortedKeys=this.sortedKeys,e.map=new Map;for(const[t,n]of this.map)e.map.set(t,0-n);return e}static multiply(e,t){const n=new ir;n.sortedKeys=e.sortedKeys.slice(),n.map=new Map(e.map);for(const[e,r]of t.map){const t=n.map.get(e);if(t){const s=r+t;s?n.map.set(e,s):(n.map.delete(e),n.sortedKeys=n.sortedKeys.filter((t=>t!==e)))}else n.map.set(e,r),n.sortedKeys.push(e)}return n.sortedKeys.sort(((e,t)=>e.length!==t.length?t.length-e.length:e>t?1:e<t?-1:0)),n}static compare(e,t){if(e.sortedKeys.length!==t.sortedKeys.length)return t.sortedKeys.length-e.sortedKeys.length;for(let n=0;n<e.sortedKeys.length;++n){const r=e.sortedKeys[n],s=e.map.get(r),o=t.sortedKeys[n],i=t.map.get(o);if(s!==i)return i-s;if(r.length>o.length)return-1;if(r.length<o.length)return 1;if(r>o)return 1;if(r<o)return-1}return 0}}function ar(e,t){for(;Xn(t,nr);){const n=t;t=Zn(e,t),e=n}return e}class lr{constructor(e){this.terms=e}static simplifyTerms(e){const t=e.slice().sort(((e,t)=>ir.compare(e.indeterminates,t.indeterminates)));for(let e=1;e<t.length;++e){const n=t[e-1],r=t[e];if(0===ir.compare(n.indeterminates,r.indeterminates)){const s=Hn(Qn(n.coefficientNumerator,r.coefficientDenominator),Qn(r.coefficientNumerator,n.coefficientDenominator)),o=Qn(n.coefficientDenominator,r.coefficientDenominator),i=ar(s,o);t[e]={indeterminates:r.indeterminates,coefficientNumerator:Yn(s,i),coefficientDenominator:Yn(o,i)},t[e-1]={indeterminates:n.indeterminates,coefficientNumerator:nr,coefficientDenominator:n.coefficientDenominator}}}return t.filter((e=>Xn(e.coefficientNumerator,nr)))}static fromIndeterminate(e){const t=new ir(JSON.stringify(e));return new lr([{indeterminates:t,coefficientNumerator:rr,coefficientDenominator:rr}])}static fromConstant(e){const[t,n]=Math.abs(e).toString(2).split(".",2);let r=tr("0b"+t);e<0&&(r=Qn(r,or));let s=rr;var o,i;n&&(o=sr,i=tr(n.length),s=o**i,r=Hn(Qn(r,s),tr("0b"+n)));const a=[{indeterminates:new ir,coefficientNumerator:r,coefficientDenominator:s}];return new lr(a)}negation(){const e=this.terms.map((e=>({indeterminates:e.indeterminates,coefficientNumerator:Qn(e.coefficientNumerator,or),coefficientDenominator:e.coefficientDenominator})));return new lr(e)}reciprocal(){const e=this.terms.map((e=>({indeterminates:e.indeterminates.reciprocal(),coefficientNumerator:e.coefficientDenominator,coefficientDenominator:e.coefficientNumerator})));return new lr(e)}constant(){const e=this.terms.filter((e=>!e.indeterminates.sortedKeys.length));return new lr(e)}add(e){return new lr(lr.simplifyTerms(this.terms.concat(e.terms)))}subtract(e){return this.add(e.negation())}multiply(e){const t=[];for(const n of this.terms)for(const r of e.terms){const e=Qn(n.coefficientNumerator,r.coefficientNumerator),s=Qn(n.coefficientDenominator,r.coefficientDenominator),o=ar(e,s);t.push({indeterminates:ir.multiply(n.indeterminates,r.indeterminates),coefficientNumerator:Yn(e,o),coefficientDenominator:Yn(s,o)})}return new lr(lr.simplifyTerms(t))}divide(e){return this.multiply(e.reciprocal())}toString(){const e=[];for(const t of this.terms){const n=Gn(t.coefficientNumerator)/Gn(t.coefficientDenominator),r=[];if(t.indeterminates.sortedKeys.length){for(const e of t.indeterminates.sortedKeys){const n=t.indeterminates.map.get(e);for(let t=Math.abs(n);t>0;--t)n>0?r.push(e):r.push(`["/",1,${e}]`)}1!==n&&r.push(n.toString()),r.length>1?e.push(`["*",${r.join(",")}]`):e.push(r[0])}else e.push(n.toString())}return e.length?1===e.length?e[0]:`["+",${e.join(",")}]`:"0"}}const cr=lr.fromConstant(0),ur=lr.fromConstant(1),fr={"=":"=","<>":"<>",">":"<",">=":"<=","<":">","<=":">="};function dr(e){if(!Array.isArray(e))return e;const t=e[0];if("FUNC"===t&&"COALESCE"===e[1]){const t=["CASE"];for(let n=2;n<e.length;++n)t.push(dr(["IS NOT NULL",e[n]]),e[n]);return dr(t)}if("CASE"===t){const t=[];for(let n=1;n<e.length;n+=2){let r=e[n];if(r instanceof lr&&(r=JSON.parse(r.toString())),!Array.isArray(r)&&!r)continue;const s=e[n+1];if(Array.isArray(s)&&"CASE"===s[0]){for(let e=1;e<s.length;e+=2)t.push([Vt(r,s[e]),s[e+1]]);if(t.push([r,null]),!Array.isArray(r)&&r)break}else t.push([r,s])}for(;null==t[t.length-1][1];)t.pop();return["CASE",...t.flat()]}const n=new Map;for(const[t,r]of e.entries()){if(!Array.isArray(r))continue;if("CASE"!==r[0])continue;const e=[];for(let t=1;t<r.length;t+=2)e.push([r[t],r[t+1]]);e.push([!0,null]),n.set(t,e)}if(n.size){let t=[[!0,e]];for(const[e,r]of n){const n=[];for(const[s,o]of r)if(n.push(...t.map((t=>{const n=t[1].slice();return n[e]=o,[Vt(s,t[0]),n]}))),!Array.isArray(s)&&s)break;t=n}for(const e of t)e[1]=dr(e[1]);if(!0===t[0][0])return t[0][1];for(;null==t[t.length-1][1];)t.pop();return["CASE",...t.flat()]}function r(e){return null==e?null:e instanceof lr?e:"number"==typeof e?lr.fromConstant(e):"string"==typeof e?lr.fromConstant(parseFloat(e)||0):"boolean"==typeof e?lr.fromConstant(+e):lr.fromIndeterminate(e)}if("+"===t){const t=[];for(let n=1;n<e.length;++n){const s=r(e[n]);if(null==s)return null;t.push(s)}return t.reduce(((e,t)=>e.add(t)),cr)}if("*"===t){const t=[];for(let n=1;n<e.length;++n){const s=r(e[n]);if(null==s)return null;t.push(s)}return t.reduce(((e,t)=>e.multiply(t)),ur)}if("-"===t){const t=[];for(let n=1;n<e.length;++n){const s=r(e[n]);if(null==s)return null;t.push(s)}return t.reduce(((e,t)=>e.subtract(t)))}if("/"===t){const t=[];for(let n=1;n<e.length;++n){const s=r(e[n]);if(null==s)return null;t.push(s)}return t.reduce(((e,t)=>e.divide(t)))}if(["=","<>",">",">=","<","<="].includes(t)){if(null==e[1]||null==e[2])return null;let n,r;if(e[1]instanceof lr?n=e[1]:"number"==typeof e[1]&&(n=lr.fromConstant(e[1])),e[2]instanceof lr?r=e[2]:"number"==typeof e[2]&&(r=lr.fromConstant(e[2])),n||r)if(n||(n=lr.fromIndeterminate(e[1])),r||(r=lr.fromIndeterminate(e[2])),n=n.subtract(r),r=n.constant().negation(),n=n.add(r),n.terms.length){let s=1;const o=n.terms[0].coefficientNumerator,i=n.terms[0].coefficientDenominator;(er(o,nr)||er(i,nr))&&(s*=-1);const a=new lr([{indeterminates:new ir,coefficientNumerator:i,coefficientDenominator:o}]);n=n.multiply(a),r=r.multiply(a);const l=n.terms[0].indeterminates.sortedKeys;let c=n.terms[0].indeterminates.map.get(l[0])<0?-1:0;for(const e of n.terms)for(const t of e.indeterminates.map.values())c+=t;c<0&&(s*=-1,n=n.reciprocal(),r=r.reciprocal()),e=s<0?[fr[t],n,r]:[t,n,r]}else{if(e=[t,JSON.parse(n.toString()),JSON.parse(r.toString())],"="===t)return e[1]===e[2];if("<>"===t)return e[1]!==e[2];if(">"===t)return e[1]>e[2];if(">="===t)return e[1]>=e[2];if("<"===t)return e[1]<e[2];if("<="===t)return e[1]<=e[2]}}return e=Ut(e=e.map((e=>e instanceof lr?JSON.parse(e.toString()):e)))}function hr(e){return(e=kt(e,dr))instanceof lr?e=JSON.parse(e.toString()):Array.isArray(e)&&"CASE"===e[0]&&(e=e.map((e=>e instanceof lr?JSON.parse(e.toString()):e))),e}class pr{constructor(){this.variables=new Map,this.clauses=new Map}getVar(e){const t=e.toString();let n=this.variables.get(t);return null==n&&(n=this.variables.size,this.variables.set(t,n),this.clauses.set(n,e)),n}getClause(e){return this.clauses.get(e)}canRaise(e,t){return!0}sanitizeMinterms(e){return e}minimize(e,t=[]){e=this.sanitizeMinterms(e);const n=this.canRaise.bind(this);return function(e,t=[],n={}){const r=Bn(e),s=Bn(t);return Jn(qn(r,s,n.computeOffSet?Nn(On.from([...r,...s])):void 0,n.canRaise))}(e,[...this.getDcSet(e),...t],{canRaise:n})}}function*mr(e){if(!Array.isArray(e))return;const t=e[0];if("IS NULL"!==t&&"IS NOT NULL"!==t){if("FUNC"===t){if("NOW"===e[1])return;if("LOWER"===e[1]||"UPPER"===e[1])yield*mr(e[2]);else if("ROUND"===e[1]){for(const t of e.slice(2,4))yield*mr(t);return}}else if("PARAM"!==t){for(const t of e.slice(1))yield*mr(t);return}yield e}}class gr{expression(){if(void 0!==this._expression)return this._expression;const e=yr(),t=this.true(e),n=e.minimize(t);return this._expression=e.toExpression(n),this._expression}isBoolean(){return!0}isNullable(e){return this._isNullable||(this._isNullable=new Set([...this.getNullables()].map((e=>e.toString())))),this._isNullable.has(e.toString())}*getNullables(){const e=this.expression();for(const t of mr(e))t===e?yield new gr.IsNull(this):yield new gr.IsNull(new gr.Exp(t))}toString(){return JSON.stringify(this.expression())}}function vr(e,t){const n=new Map;for(const r of e){const e=t(r);let s=n.get(e);s||n.set(e,s=[]),s.push(r)}return n.entries()}!function(e){class t extends e{constructor(e){super(),this.operand=e}true(e){return this.operand.false(e)}false(e){return this.operand.true(e)}null(e){return this.operand.null(e)}}e.Not=t;class n extends e{constructor(e){super(),this.operands=e}true(e){const t=[];for(const n of this.operands){const r=n.true(e);if(1===r.length&&!r[0].length)return[[]];t.push(...r)}return t}false(e){const t=[],r=[...this.operands];for(const s of r){if(s instanceof n){r.push(...s.operands);continue}const o=s.false(e);if(!o.length)return[];t.push(o)}return t.length?1===t.length?t[0]:Kn(t.map((e=>Kn(e))).flat()):[[]]}null(e){const t=[],r=[...this.operands];for(const s of r){if(s instanceof n){r.push(...s.operands);continue}const o=s.true(e);if(1===o.length&&!o[0].length)return[];t.push(...o)}const s=[];for(const n of r){const r=n.null(e);if(1===r.length&&!r[0].length&&!t.length)return[[]];s.push(...r)}return t.length?Kn([...Kn(s),...t]):s}}e.Or=n;class r extends e{constructor(e){super(),this.operands=e}true(e){const t=[],n=[...this.operands];for(const s of n){if(s instanceof r){n.push(...s.operands);continue}const o=s.true(e);if(!o.length)return[];(1!==o.length||o[0].length)&&t.push(o)}return t.length?1===t.length?t[0]:Kn(t.map((e=>Kn(e))).flat()):[[]]}false(e){const t=[];for(const n of this.operands){const r=n.false(e);if(1===r.length&&!r[0].length)return[[]];t.push(...r)}return t}null(e){const t=[],n=[...this.operands];for(const s of n){if(s instanceof r){n.push(...s.operands);continue}const o=s.false(e);if(1===o.length&&!o[0].length)return[];t.push(...o)}const s=[];for(const r of n){const n=r.null(e);if(1===n.length&&!n[0].length&&!t.length)return[[]];s.push(...n)}return t.length?Kn([...Kn(s),...t]):s}}e.And=r;e.Case=class extends e{constructor(e){super(),this.clauses=e}true(e){const t=[],n=[];for(let r=0;r<this.clauses.length;r+=2){const s=this.clauses[r].true(e),o=this.clauses[r+1].true(e);t.push(...Kn([...n,...Kn(s),...Kn(o)])),r<this.clauses.length-2&&n.push(...Kn([...this.clauses[r].false(e),...this.clauses[r].null(e)]))}return t}false(e){const t=[],n=[];for(let r=0;r<this.clauses.length;r+=2){const s=this.clauses[r].true(e),o=this.clauses[r+1].false(e);t.push(...Kn([...n,...Kn(s),...Kn(o)])),r<this.clauses.length-2&&n.push(...Kn([...this.clauses[r].false(e),...this.clauses[r].null(e)]))}return t}null(e){const t=[],n=[];for(let r=0;r<this.clauses.length;r+=2){const s=this.clauses[r].true(e),o=this.clauses[r+1].null(e);t.push(...Kn([...n,...Kn(s),...Kn(o)])),n.push(...Kn([...this.clauses[r].false(e),...this.clauses[r].null(e)]))}return t.push(...Kn([...n])),t}expression(){if(null!=this._expression)return this._expression;if(this.isBoolean())return this._expression=new e.Not(new e.Not(this)).expression(),this._expression;const t=yr(),n=[];for(let e=0;e<this.clauses.length;e+=2){let r=this.clauses[e].true(t);const s=this.clauses[e+1].expression();if(n.length&&JSON.stringify(s)===JSON.stringify(n[n.length-1].then)&&r.push(...n.pop().when),r=t.minimize(r,n.flatMap((e=>e.when))),r.length&&(n.push({when:r,then:s}),1===r.length&&!r[0].length))break}for(;null==n[n.length-1].then;)n.pop();return n.length?(this._expression=["CASE",...n.flatMap((e=>[t.toExpression(e.when),e.then]))],this._expression):null}isBoolean(){for(let e=1;e<this.clauses.length;e+=2)if(!this.clauses[e].isBoolean())return!1;return!0}};e.IsNull=class extends e{constructor(e){super(),this.operand=e,this._boolean=new t(new t(this))}true(e){return this.operand.null(e)}false(e){return Kn(this.true(e))}null(){return[]}isBoolean(){return!0}*getNullables(){}expression(){const e=[...this.operand.getNullables()];return 1===e.length&&e[0].operand===this.operand?["IS NULL",this.operand.expression()]:super.expression()}};class s extends e{constructor(e){super(),this.exp=e}true(e){return Array.isArray(this.exp)?e.getMinterms(this,!0):this.exp?[[]]:[]}false(e){return Array.isArray(this.exp)?e.getMinterms(this,!1):this.exp||null==this.exp?[]:[[]]}null(e){return Array.isArray(this.exp)?e.getMinterms(this,null):null==this.exp?[[]]:[]}expression(){return this.exp}isBoolean(){return!0===this.exp||!1===this.exp||null==this.exp}}e.Exp=s;e.Compare=class extends e{constructor(e,t,n){super(),this.lhs=e,this.op=t,this.rhs=n}true(e){return e.getMinterms(this,!0)}false(e){return e.getMinterms(this,!1)}null(e){return this.lhs.null(e)}*getNullables(){yield*this.lhs.getNullables()}isBoolean(){return!0}expression(){return[this.op,this.lhs.expression(),this.rhs]}};e.Like=class extends e{constructor(e,t,n){super(),this.rhs=t,this.esc=n;const r=e.expression();let o=!0,i=!1;if(Array.isArray(r)&&"FUNC"===r[0]){const n=r[1];if("UPPER"===n||"LOWER"===n){("UPPER"===n?t.toUpperCase():t.toLowerCase())===t?o=!1:i=!0,e=new s(r[2])}}this.lhs=e,this.pattern=Dt(t,n),this.caseSensitive=o,this.contradiction=i}true(e){return e.getMinterms(this,!0)}false(e){return e.getMinterms(this,!1)}null(e){return this.lhs.null(e)}isBoolean(){return!0}isNullable(e){return this.lhs.isNullable(e)}getNullables(){return this.lhs.getNullables()}expression(){let e=this.lhs.expression();return this.contradiction?e=this.rhs===this.rhs.toLocaleUpperCase()?["FUNC","LOWER",e]:["FUNC","UPPER",e]:this.caseSensitive||(e=this.rhs===this.rhs.toLocaleUpperCase()?["FUNC","UPPER",e]:["FUNC","LOWER",e]),["LIKE",e,this.rhs,...this.esc?[this.esc]:[]]}},e.fromExpression=function(t){return kt(t,(t=>{if(!Array.isArray(t))return new e.Exp(t);let n,r=t[0],o=!0;if("NOT LIKE"===r?r="LIKE":"IS NOT NULL"===r?r="IS NULL":"<>"===r?r="=":">="===r?r="<":"<="===r?r=">":o=!1,"IS NULL"===r)n=new e.IsNull(t[1]);else if("NOT"===r)n=new e.Not(t[1]);else if("OR"===r)n=new e.Or(t.slice(1));else if("AND"===r)n=new e.And(t.slice(1));else if("CASE"===r)n=new e.Case(t.slice(1));else if("LIKE"===r){const r=t[2]instanceof s?t[2].expression():null,o=t[3]instanceof s?t[3].expression():null;"string"==typeof r&&"string"==typeof o?n=new e.Like(t[1],r,o):"string"==typeof r&&null==o&&(n=new e.Like(t[1],r))}else if(">"===r||"<"===r||"="===r){const o=t[2]instanceof s?t[2].expression():null;["boolean","number","string"].includes(typeof o)&&(n=new e.Compare(t[1],r,o))}if(!n){const s=t.slice(1).map((e=>e.expression()));n=new e.Exp([r,...s])}return o&&(n=new e.Not(n)),n}))}}(gr||(gr={}));class wr extends pr{constructor(){super()}getMinterms(e,t){const n=this.getVar(e);return!0===t?[[n<<2^3]]:!1===t?[[n<<2^1]]:[[n<<2,n<<2^2]]}getDcSet(e){const t=[],n=new Set([...e.flat()].map((e=>e>>2))),r=[...n].map((e=>this.getClause(e))),s=r.filter((e=>e instanceof gr.Compare));for(const[,e]of vr(s,(e=>JSON.stringify(e.lhs)))){const r=e[0].lhs,s=[...new Set(e.map((e=>e.rhs)))].sort(((e,t)=>{const n=typeof e,r=typeof t;return n===r?e>t?1:-1:"string"===n?1:"string"===r?-1:+e-+t}));for(const[e,o]of s.entries()){const i=this.getVar(new gr.Compare(r,"=",o)),a=this.getVar(new gr.Compare(r,">",o)),l=this.getVar(new gr.Compare(r,"<",o));t.push([i<<2^3,a<<2^3]),t.push([l<<2^3,a<<2^3]),t.push([l<<2^3,i<<2^3]),t.push([l<<2^1,i<<2^1,a<<2^1]);const c=[l,i,a].filter((e=>!n.has(e)));1===c.length&&n.add(c[0]);for(let n=0;n<e;n++){const e=this.getVar(new gr.Compare(r,"=",s[n])),o=this.getVar(new gr.Compare(r,">",s[n])),c=this.getVar(new gr.Compare(r,"<",s[n]));t.push([o<<2^1,l<<2^1]),t.push([e<<2^3,l<<2^1]),t.push([c<<2^3,l<<2^1]),t.push([o<<2^1,a<<2^3]),t.push([o<<2^1,i<<2^3]),t.push([e<<2^3,a<<2^3]),t.push([e<<2^3,i<<2^3]),t.push([c<<2^3,a<<2^3]),t.push([c<<2^3,i<<2^3])}}}const o=r.filter((e=>e instanceof gr.Like));for(const[,e]of vr(o,(e=>JSON.stringify(e.lhs))))for(let n=0;n<e.length;++n){const r=e[n];if(r.contradiction)t.push([this.getVar(r)<<2^3]);else for(let s=n+1;s<e.length;++s){const n=e[s];if(n.contradiction)continue;let o=r.pattern,i=n.pattern;r.caseSensitive&&n.caseSensitive||(o=o.map((e=>e.toLowerCase())),i=i.map((e=>e.toLowerCase()))),Ar(o,i)?t.push([this.getVar(r)<<2^3,this.getVar(n)<<2^3]):r.caseSensitive&&!n.caseSensitive||!br(o,i)?n.caseSensitive&&!r.caseSensitive||!br(i,o)||(t.push([this.getVar(r)<<2^3,this.getVar(n)<<2^2]),t.push([this.getVar(r)<<2^0,this.getVar(n)<<2^1])):(t.push([this.getVar(r)<<2^2,this.getVar(n)<<2^3]),t.push([this.getVar(r)<<2^1,this.getVar(n)<<2^0]))}}for(const e of n){const r=this.getClause(e),s=[...r.getNullables()].map((e=>this.getVar(e)));if(s.length){t.push([...s.map((e=>e<<2^2)),e<<2^0,e<<2^2]);for(const r of s)t.push([r<<2^3,e<<2^1]),t.push([r<<2^3,e<<2^3]),n.add(r)}if(r instanceof gr.IsNull){const n=r.operand.toString();'["PARAM","DeviceID.ID"]'!==n&&'["PARAM","_id"]'!==n||t.push([e<<2^3])}}return t.filter((e=>e.every((e=>n.has(e>>2)))))}canRaise(e,t){const n=this.getClause(e>>2);if(n instanceof gr.IsNull){for(const r of t){if(r===e||1&r)continue;if(this.getClause(r>>2).isNullable(n))return!1}return!0}return!(1&e&&t.has(3^e))}sanitizeMinterms(e){const t=[];e:for(const n of e){const e=new Map;for(const t of n)e.set(t>>2,(e.get(t>>2)||0)|1<<(3&t));const r=[],s=[];for(const[t,n]of e){if(10===n)continue e;const e=[...this.clauses.get(t).getNullables()].map((e=>this.getVar(e))),o=t<<2;5===n?1===e.length?r.push(e[0]<<2^3):s.push(e.map((e=>e<<2^3))):1===n?s.push([...e.map((e=>e<<2^3)),3^o]):4===n?s.push([...e.map((e=>e<<2^3)),1^o]):8&n?r.push(3^o):2&n&&r.push(1^o)}let o=[r];for(;s.length;){const e=[],t=s.pop();for(const n of t)e.push(...o.map((e=>[...e,n])));o=e}t.push(...o)}return t}toExpression(e){if(!e.length)return!1;const t=[];for(const n of e){if(!n.length)return!0;const e=[];for(const t of n){let n=this.getClause(t>>>2).expression();if(!(1&t)!=!(2&t)&&(n=["NOT",n]),Array.isArray(n)&&"NOT"===n[0]&&Array.isArray(n[1])){const e=n[1];"IS NULL"===e[0]?n=["IS NOT NULL",...e.slice(1)]:"LIKE"===e[0]?n=["NOT LIKE",...e.slice(1)]:"="===e[0]?n=["<>",...e.slice(1)]:"<>"===e[0]?n=["=",...e.slice(1)]:">"===e[0]?n=["<=",...e.slice(1)]:">="===e[0]?n=["<",...e.slice(1)]:"<"===e[0]?n=[">=",...e.slice(1)]:"<="===e[0]?n=[">",...e.slice(1)]:"NOT"===e[0]&&(n=e[1])}e.push(n)}e.length>1?t.push(["AND",...e]):t.push(e[0])}return t.length>1?["OR",...t]:t[0]}}function yr(){return new wr}function br(e,t){let n=null;for(let r=0,s=0;;++r,++s){for(;r<e.length&&"\\%"===e[r];)n=[r++,s];if(s>=t.length)return r>=e.length;const o=r<e.length?e[r]:null;if(o!==t[s]&&"\\_"!==o){if(!n)return!1;[r,s]=n,++n[1]}}}function Ar(e,t){const n=e.indexOf("\\%"),r=t.indexOf("\\%"),s=e.lastIndexOf("\\%"),o=t.lastIndexOf("\\%"),i=e.slice(0,-1!==n?n:e.length),a=t.slice(0,-1!==r?r:t.length),l=e.slice(-1!==s?s+1:0).reverse(),c=t.slice(-1!==o?o+1:0).reverse();for(let e=0;e<Math.min(i.length,a.length);++e)if(i[e]!==a[e]&&"\\_"!==i[e]&&"\\_"!==a[e])return!0;for(let e=0;e<Math.min(l.length,c.length);++e)if(l[e]!==c[e]&&"\\_"!==l[e]&&"\\_"!==c[e])return!0;return e.length===i.length?t.filter((e=>"\\%"!==e)).length>e.length:t.length===a.length&&e.filter((e=>"\\%"!==e)).length>t.length}function xr(e,t){if(!(t=hr(t)))return[e,!1];const n=gr.fromExpression(t);if(!e){const e=n.expression();return[e,e]}e=hr(e);const r=gr.fromExpression(e),s=new wr,o=n.true(s),i=r.true(s),a=r.null(s),l=r.false(s),c=s.minimize([...i,...o]),u=s.minimize(Kn([...Kn([...a,...l]),...Kn(o)]));return[s.toExpression(c),s.toExpression(u)]}function Sr(e,t){if(!(t=hr(t)))return!0;if(e=hr(e),!Array.isArray(e))return!!e;const n=gr.fromExpression(e),r=gr.fromExpression(t),s=new wr,o=n.true(s),i=r.true(s);return a=[...Kn(i),...s.getDcSet([...i,...o]),...o],$n(On.from(Bn(a)));var a}const Cr=Ht(Pt),Er=Ht(Ft);let kr,Or,$r,Nr=0,Pr=0;const Dr={filter:new WeakMap,bookmark:new WeakMap,limit:new WeakMap,sort:new WeakMap,fulfilled:new WeakMap,fulfilling:new WeakSet,accessed:new WeakMap,value:new WeakMap},_r={};for(const e of["devices","faults","files","presets","provisions","virtualParameters","files","config","users","permissions"])_r[e]={objects:new Map,count:new Map,fetch:new Map,combinedFilter:null};class jr{get fulfilled(){return Dr.accessed.set(this,Date.now()),Dr.fulfilled.get(this)||0}get fulfilling(){return Dr.accessed.set(this,Date.now()),!(Dr.fulfilled.get(this)>=Nr)}get value(){return Dr.accessed.set(this,Date.now()),Dr.value.get(this)}}async function Ir(e){const t=e.extract,n=e.deserialize;return e.extract=(e,r)=>{if("function"==typeof t)return t(e,r);if(304!==e.status&&2!==Math.floor(e.status/100)){if(403===e.status)throw new Error("Not authorized");const t=new Error;throw t.message=0===e.status?"Server is unreachable":`Unexpected response status code ${e.status}`,t.code=e.status,t.response=e.responseText,t}let s;if("function"==typeof n)s=n(e.responseText);else if((e.getResponseHeader("content-type")||"").startsWith("application/json"))try{s=e.responseText?JSON.parse(e.responseText):null}catch(t){throw new Error("Invalid JSON: "+e.responseText.slice(0,80))}else s=e.responseText;return s},ce.request(e)}function zr(e){if(!Array.isArray(e))return e;return Er(e,null,Nr+Pr)}function Mr(e,t){const n=Cr(t);let r=_r[e].count.get(n);return r||(r=new jr,_r[e].count.set(n,r),Dr.filter.set(r,t),r)}function Lr(e,t,n){return Vt(e,Object.entries(t).sort(((e,t)=>Math.abs(t[1])-Math.abs(e[1]))).reverse().reduce(((e,t)=>{const[r,s]=t;if(s<=0){if(null==n[r])return Wt(["IS NOT NULL",["PARAM",r]],Vt(["IS NULL",["PARAM",r]],e));let t=null;return t=Wt(t,[">",["PARAM",r],n[r]]),Wt(t,Vt(["=",["PARAM",r],n[r]],e))}{let t=["IS NULL",["PARAM",r]];return null==n[r]?Vt(t,e):(t=Wt(t,["<",["PARAM",r],n[r]]),Wt(t,Vt(["=",["PARAM",r],n[r]],e)))}}),!0))}function Rr(e,t,n,r){let s=[];for(const n of _r[e].objects.values())Ft(t,n,Nr+Pr)&&s.push(n);return s=s.sort(function(e){const t=Object.entries(e).sort(((e,t)=>Math.abs(t[1])-Math.abs(e[1])));return(e,n)=>{for(const[r,s]of t){let t=e[r],o=n[r];if(null!=t&&"object"==typeof t&&(t=t.value?t.value[0]:null),null!=o&&"object"==typeof o&&(o=o.value?o.value[0]:null),t>o)return s;if(t<o)return-1*s;if(t!==o){const e={null:1,number:2,string:3},n=e[null==t?"null":typeof t]||4,r=e[null==o?"null":typeof o]||4;return Math.max(-1,Math.min(1,n-r))*s}}return 0}}(n)),r&&(s=s.slice(0,r)),s}function Tr(e,t,n={}){const r=Cr(t),s=Object.assign({},n.sort);for(const[e,t]of Object.entries(s))s[e]+=Math.sign(t);const o=n.limit||0;"devices"===e?s["DeviceID.ID"]=s["DeviceID.ID"]||1:s._id=s._id||1;const i=`${r}:${o}:${JSON.stringify(s)}`;let a=_r[e].fetch.get(i);return a||(a=new jr,_r[e].fetch.set(i,a),Dr.filter.set(a,t),Dr.limit.set(a,o),Dr.sort.set(a,s),function(e,t){const n=Dr.limit.get(t);let r=Dr.filter.get(t);r=zr(r);const s=Dr.bookmark.get(t),o=Dr.sort.get(t);!s&&n||(s&&(r=Lr(r,o,s)),Sr(_r[e].combinedFilter,r)&&Dr.fulfilled.set(t,Nr)),Dr.value.set(t,Rr(e,r,o,n))}(e,a),a)}function Ur(){return Nr}function Fr(e){if(e>Nr){Nr=e;for(const e of Object.values(_r))e.combinedFilter=null}}function Vr(){return Pr}function Wr(e,t){for(const n of t)n.status="pending",n.device=e;return Ir({method:"POST",url:`api/devices/${encodeURIComponent(e)}/tasks`,body:t,extract:e=>{if(403===e.status)throw new Error("Not authorized");if(!e.status)throw new Error("Server is unreachable");if(200!==e.status)throw new Error(e.response);const n=e.getResponseHeader("Connection-Request"),r=JSON.parse(e.response);for(const[e,n]of r.entries())t[e]._id=n._id,t[e].status=n.status,t[e].fault=n.fault;return n}})}function qr(e,t){return Ir({method:"POST",url:`api/devices/${encodeURIComponent(e)}/tags`,body:t})}function Br(e,t){return Ir({method:"DELETE",url:`api/${e}/${encodeURIComponent(t)}`})}function Jr(e,t,n){for(const e in n)void 0===n[e]&&(n[e]=null);return Ir({method:"PUT",url:`api/${e}/${encodeURIComponent(t)}`,body:n})}function Kr(e,t){const n=["=",["PARAM","devices"===e?"DeviceID.ID":"_id"],t];return Ir({method:"HEAD",url:`api/${e}/?`+ce.buildQueryString({filter:Cr(n)}),extract:e=>{if(403===e.status)throw new Error("Not authorized");if(!e.status)throw new Error("Server is unreachable");if(200!==e.status)throw new Error(`Unexpected response status code ${e.status}`);return+e.getResponseHeader("x-total-count")},background:!0})}function Hr(e,t){return Array.isArray(e)?Er(e,t,Nr+Pr):e}function Qr(e,t,n){const r={newPassword:t};return n&&(r.authPassword=n),Ir({method:"PUT",url:`api/users/${e}/password`,background:!0,body:r})}function Yr(e){return ce(`svg.icon.icon-${e}`,{key:`icon-${e}`},ce("use",{href:`icons.svg#icon-${e}`}))}setInterval((function(){const e=Date.now();ce.request({url:"status",method:"GET",background:!0,extract:t=>{const n=Date.now();if(200!==t.status)kr||(kr=Zt("warning","Server is unreachable",{}));else{kr&&(Gt(kr),kr=null);try{const r=Math.trunc((e+n)/2),s=Date.parse(t.getResponseHeader("Date"))-r;Math.abs(s-Pr)>5e3&&n-e<1e3&&(Pr=s,console.warn(`System and server clocks are out of sync. Adding ${Pr}ms offset to any client-side time relative calculations.`),Fr(n),ce.redraw())}catch(e){}const r=t.getResponseHeader("x-config-snapshot")!==en,s=t.getResponseHeader("genieacs-version")!==tn;!Or!=!r&&(Or?(Gt(Or),Or=null):Or=Zt("warning","Configuration has been modified, please reload the page",{Reload:()=>{window.location.reload()}})),!$r!=!s&&($r?(Gt($r),$r=null):$r=Zt("warning","Server has been updated, please reload the page",{Reload:()=>{window.location.reload()}}))}}}).catch((e=>{Zt("error",e.message)}))}),3e3);const Zr=new Set,Gr=new Set;function Xr(e){let t=Zr.size;for(const n of e)Zr.has(n)||++t;return t<=100}function es(...e){if(Xr(e))for(const t of e)t.status="queued",Zr.add(t);else Zt("error","Too many tasks in queue")}function ts(e){Zr.delete(e)}function ns(){return Zr}function rs(){Zr.clear()}function ss(){return Gr}function os(e){Zr.size+e.devices.length>100?Zt("error","Too many tasks in queue"):Gr.add(e)}function is(e,t){const n={};if(!Xr(e))return Promise.reject(new Error("Too many tasks in queue"));for(const t of e)n[t.device]=n[t.device]||[],n[t.device].push(t),t.status="queued",Zr.add(t);return new Promise((e=>{let r=1;for(const[s,o]of Object.entries(n))++r,Wr(s,o).then((n=>{for(const e of o)"pending"===e.status?e.status="stale":"done"===e.status&&Zr.delete(e);t(s,null,n,o),0==--r&&e()})).catch((n=>{for(const e of o)e.status="stale";t(s,n,null,o),0==--r&&e()}));0==--r&&e()}))}const as=new WeakSet;function ls(e){return ce("span.parameter",{title:e},`${e}`)}function cs(e,t,n){function r(e){"Enter"===e.key?t():"Escape"===e.key?n():e.redraw=!1}let s;if("xsd:boolean"===e.parameterValues[0][2])s=ce("select",{value:e.parameterValues[0][1].toString(),onchange:t=>{t.redraw=!1,e.parameterValues[0][1]=s.dom.value},onkeydown:r,oncreate:e=>{e.dom.focus()}},[ce("option",{value:"true"},"true"),ce("option",{value:"false"},"false")]);else{const t=e.parameterValues[0][2];let n=e.parameterValues[0][1];"xsd:dateTime"===t&&"number"==typeof n&&(n=new Date(n).toJSON()||n),s=ce("input",{type:["xsd:int","xsd:unsignedInt"].includes(t)?"number":"text",value:n,oninput:t=>{t.redraw=!1,e.parameterValues[0][1]=s.dom.value},onkeydown:r,oncreate:e=>{e.dom.focus(),e.dom.select(),e.dom.parentNode.parentNode.scrollTop=0}})}return[ce("span","Editing ",ls(e.parameterValues[0][0])),s]}function us(e){e.fileName&&e.fileType?as.delete(e):as.add(e);const t=Tr("files",!0);let n="",r="";for(const t of e.devices){const e=t.split("-");""===n?n=e[0]:n!==e[0]&&(n=null),3===e.length&&(""===r?r=e[1]:r!==e[1]&&(r=null))}n&&(n=decodeURIComponent(n)),r&&(r=decodeURIComponent(r));const s=[...new Set(["","1 Firmware Upgrade Image","2 Web Content","3 Vendor Configuration File","4 Tone File","5 Ringer File",...t.value.map((e=>e["metadata.fileType"])).filter((e=>e))])].map((t=>ce("option",{disabled:!t,value:t,selected:(e.fileType||"")===t},t))),o=[""].concat(t.value.filter((e=>!(e["metadata.oui"]&&e["metadata.oui"]!==n||e["metadata.productClass"]&&e["metadata.productClass"]!==r))).map((e=>e._id))).map((t=>ce("option",{disabled:!t,value:t,selected:(e.fileName||"")===t},t)));return["Push ",ce("select",{onchange:n=>{const r=n.target.value;e.fileName=r,e.fileType="";for(const n of t.value)n._id===r&&(e.fileType=n["metadata.fileType"])},disabled:t.fulfilling,style:"width: 350px"},o)," as ",ce("select",{onchange:t=>{e.fileType=t.target.value}},s)]}const fs=()=>({view:e=>{const t=ns(),n=ss();let r,s;const o=function(e){const t=[];for(const n of e){let e;if(n.actions){const t=Object.entries(n.actions).map((([e,t])=>ce("button.primary",{onclick:t},e)));t.length&&(e=ce("div",{style:"float: right"},t))}t.push(ce("div.notification",{class:n.type,style:"position: absolute;opacity: 0",oncreate:e=>{e.dom.style.opacity="1"},onbeforeremove:e=>(e.dom.style.opacity="0",new Promise((e=>{setTimeout((()=>{e()}),500)}))),key:n.timestamp},ce("div",e,n.message)))}return t}(Yt),i=function(e){const t=[];for(const n of e){const r=()=>{e.delete(n);for(const e of n.devices){const t=Object.assign({device:e},n);delete t.devices,es(t)}},s=()=>{e.delete(n)};let o;"setParameterValues"===n.name?o=cs(n,r,s):"download"===n.name&&(o=us(n));const i=ce("button.primary",{title:"Queue task",onclick:r,disabled:as.has(n)},"Queue"),a=ce("button",{title:"Cancel edit",onclick:s},"Cancel");t.push(ce(".staging",o,ce("div.actions",i,a)))}return t}(n),a=function(e){const t=[],n={};for(const t of e)n[t.device]=n[t.device]||[],n[t.device].push(t);for(const[e,s]of Object.entries(n)){t.push(ce("strong",e));for(const e of s){const n=[];"fault"!==e.status&&"stale"!==e.status||n.push(ce("button",{title:"Retry this task",onclick:()=>{es(e)}},Yr("retry"))),n.push(ce("button",{title:"Remove this task",onclick:()=>{ts(e)}},Yr("remove"))),"setParameterValues"===e.name?t.push(ce(`div.${e.status}`,ce("span","Set ",ls(e.parameterValues[0][0])," to '",(r=e.parameterValues[0][1],ce("span.value",{title:r},`${r}`)),"'"),ce(".actions",n))):"refreshObject"===e.name?t.push(ce(`div.${e.status}`,ce("span","Refresh ",ls(e.parameterName)),ce(".actions",n))):"reboot"===e.name?t.push(ce(`div.${e.status}`,"Reboot",ce(".actions",n))):"factoryReset"===e.name?t.push(ce(`div.${e.status}`,"Factory reset",ce(".actions",n))):"addObject"===e.name?t.push(ce(`div.${e.status}`,ce("span","Add ",ls(e.objectName)),ce(".actions",n))):"deleteObject"===e.name?t.push(ce(`div.${e.status}`,ce("span","Delete ",ls(e.objectName)),ce(".actions",n))):"getParameterValues"===e.name?t.push(ce(`div.${e.status}`,`Refresh ${e.parameterNames.length} parameters`,ce(".actions",n))):"download"===e.name?t.push(ce(`div.${e.status}`,`Push file: ${e.fileName} (${e.fileType})`,ce(".actions",n))):t.push(ce(`div.${e.status}`,e.name,ce(".actions",n)))}}var r;return t}(t);function l(){let e=10;for(const t of o)t.dom.style.top=`${e}px`,e+=t.dom.offsetHeight+10}function c(){let t=s.dom.offsetTop+s.dom.offsetHeight;if(i.length)for(const e of i)t=Math.max(t,e.dom.offsetTop+e.dom.offsetHeight);else if(e.state.mouseIn)for(const e of r.children)t=Math.max(t,e.dom.offsetTop+e.dom.offsetHeight);r.dom.style.height=t+"px"}if(i.length+a.length){const n={queued:0,pending:0,fault:0,stale:0};for(const e of t)n[e.status]+=1;const o=ce(".actions",ce("button.primary",{title:"Commit queued tasks",disabled:!n.queued,onclick:()=>{is(Array.from(ns()).filter((e=>"queued"===e.status)),((e,t,n,r)=>{if(t)Zt("error",`${e}: ${t.message}`);else if("OK"===n){for(const t of r){if("stale"===t.status)return void Zt("error",`${e}: No contact from device`);if("fault"===t.status)return void Zt("error",`${e}: Task(s) faulted`)}Zt("success",`${e}: Task(s) committed`)}else Zt("error",`${e}: ${n}`)})).then((()=>{Fr(Date.now())})).catch((e=>{Zt("error",e.message)}))}},"Commit"),ce("button",{title:"Clear tasks",onclick:rs,disabled:!a.length},"Clear"));s=ce(".status",ce("span.queued",{class:n.queued?"active":""},`Queued: ${n.queued}`),ce("span.pending",{class:n.pending?"active":""},`Pending: ${n.pending}`),ce("span.fault",{class:n.fault?"active":""},`Fault: ${n.fault}`),ce("span.stale",{class:n.stale?"active":""},`Stale: ${n.stale}`),o),r=ce(".drawer",{key:"drawer",style:"opacity: 0;height: 0;",oncreate:t=>{e.state.mouseIn=!1,t.dom.style.opacity="1",c()},onmouseover:t=>{e.state.mouseIn=!0,c(),t.redraw=!1},onmouseleave:t=>{e.state.mouseIn=!1,c(),t.redraw=!1},onupdate:c,onbeforeremove:e=>(e.dom.onmouseover=null,e.dom.onmouseleave=null,e.dom.style.opacity="0",e.dom.style.height="0",new Promise((e=>{setTimeout(e,500)})))},s,i.length?i:ce(".queue",a))}return ce("div.drawer-wrapper",r,ce("div.notifications-wrapper",{key:"notifications",style:"position: relative;",onupdate:l,oncreate:l},o))}}),ds=()=>({view:()=>window.username?ce("button.user-menu",ce("a",{title:"Logout",onclick:e=>(e.target.disabled=!0,Ir({method:"POST",url:"logout"}).then((()=>{location.hash="",location.reload()})).catch((t=>{e.target.disabled=!1,Zt("error",t.message)})),!1)},ce("i.material-icons","exit_to_app"))):window.username&&ce("div.user-menu",ce("a",{href:"#!/login?"+ce.buildQueryString({continue:ce.route.get()})},"Log in"))}),hs=()=>({view:e=>{const t={[e.attrs.page]:"active"},n=[];return window.authorizer.hasAccess("presets",1)&&n.push(ce("li",{class:t.presets},ce("a",{href:"#!/admin/presets"},"Presets"))),window.authorizer.hasAccess("provisions",1)&&n.push(ce("li",{class:t.provisions},ce("a",{href:"#!/admin/provisions"},"Provisions"))),window.authorizer.hasAccess("virtualParameters",1)&&n.push(ce("li",{class:t.virtualParameters},ce("a",{href:"#!/admin/virtualParameters"},"Virtual Parameters"))),window.authorizer.hasAccess("files",1)&&n.push(ce("li",{class:t.files},ce("a",{href:"#!/admin/files"},"Files"))),window.authorizer.hasAccess("config",1)&&n.push(ce("li",{class:t.config},ce("a",{href:"#!/admin/config"},"Config"))),window.authorizer.hasAccess("permissions",1)&&n.push(ce("li",{class:t.permissions},ce("a",{href:"#!/admin/permissions"},"Permissions"))),window.authorizer.hasAccess("users",1)&&n.push(ce("li",{class:t.users},ce("a",{href:"#!/admin/users"},"Users"))),ce("nav#side-menu",ce("ul",n))}});let ps=null,ms=null;function gs(e,t=null){ps=e,ms=t}function vs(e,t=!0){return e===ps&&(!(!t&&ms&&!ms())&&(ps=null,ms=null,!0))}document.addEventListener("keydown",(e=>{ps&&"Escape"===e.key&&vs(ps,!1)&&ce.redraw()})),window.addEventListener("popstate",(()=>{vs(ps,!1)&&ce.redraw()}));const ws=new Map;const ys=()=>({view:()=>[...ws.values()],onupdate:()=>{for(const e of ws.keys()){document.querySelector(`[list='${e}']`)||ws.delete(e)}}}),bs=["presets","provisions","virtualParameters","files","config","users","permissions"],As=()=>({view:e=>{let t,n;if(bs.includes(e.attrs.page)){n="admin";const r={};r.page=e.attrs.page,t=ce(hs,r)}const r={};return r.page=n||e.attrs.page,ce("div.totalcontent",[ce("#header",[window.username&&ce("div.logo",ce("img",{src:"logo.png"}),ce("h1.hrline",`${window.username}`)),ce(ue,r),ce(fs),window.username&&ce(ds)]),ce("#content-wrapper",ce("div.contentinsidecontent",t,ce("#content",{class:`page-${e.attrs.page}`},[e.children]))),ps?ce(".overlay-wrapper",{tabindex:0,onclick:()=>{vs(ps,!1)},style:"opacity: 0",oncreate:e=>{e.dom.focus(),e.dom.style.opacity="1"},onbeforeremove:e=>(e.dom.style.opacity="0",new Promise((e=>{setTimeout((()=>{e()}),500)})))},ce(".overlay",{onclick:e=>{e.stopPropagation()}},ps())):null,ce(ys)])}});const xs=Object.freeze({__proto__:null,init:async function(){return ce.request({url:"init"})},component:e=>{let t=e.attrs;const n=new Set;for(const[e,r]of Object.entries(t))r&&n.add(e);return{view:()=>{document.title="Initialization wizard - Coral Application";const e=["users","presets","filters","device","index","overview"].map((e=>(t[e]||n.delete(e),ce("input",{type:"checkbox",checked:n.has(e),disabled:!t[e],style:"display: inline; margin-right: 0.5em;",onclick:t=>{t.target.checked?n.add(e):n.delete(e)}}))));return ce(".wizard-dialog",[ce("h1","Initialization wizard"),ce("p","This wizard will seed the database with a minimal initial configuration to serve as a starting point. Select what you want to initialize and click 'ABRACADABRA!'."),ce("div",ce("label",e[0],"Users, roles and permissions")),ce("div",ce("label",e[1],"Presets and provisions")),ce("div",ce("label",e[2],"Devices predefined search filters")),ce("div",ce("label",e[3],"Device details page")),ce("div",ce("label",e[4],"Devices listing page")),ce("div",ce("label",e[5],"Overview page")),ce("button.primary",{style:"margin: 10px;",disabled:0===n.size,onclick:e=>{e.target.disabled=!0;const r={};for(const e of n)r[e]=!0;ce.request({method:"POST",url:"init",body:r}).then((()=>{setTimeout((()=>{ce.request({url:"init"}).then((n=>{e.target.disabled=!1,t=n,Zt("success","Initialization complete",{"Open Sesame!":()=>{ce.route.set("/login"),window.location.reload()}})})).catch((e=>{Zt("error",e.message)}))}),3e3),r.users&&alert("An administrator user has been created for you. Use admin/admin to log in. Don't forget to change the default password.")})).catch((e=>{Zt("error",e.message)}))}},"ABRACADABRA!")])}}}}),Ss={year:31104e6,month:2592e6,day:864e5,hour:36e5,minute:6e4,second:1e3};const Cs=Ht(((e,t,n)=>{let r=n;e=Ft(e,null,n,(e=>{if(!Array.isArray(e))return e;for(let n=1;n<e.length;++n)if(Array.isArray(e[n])&&"PARAM"===e[n][0]&&!Array.isArray(e[n][1])){let s=null;const o=t[e[n][1]];(null==o?void 0:o.value)&&(s=o.value[0],r=Math.min(r,o.valueTimestamp)),(e=e.slice())[n]=s}return"FUNC"!==e[0]||"DATE_STRING"!==e[1]||Array.isArray(e[2])?e:new Date(e[2]).toLocaleString()}));let s=null,o=null;if(Array.isArray(e)){if("PARAM"===e[0]){const n=t[e[1]];(null==n?void 0:n.value)&&(r=n.valueTimestamp,o=n.value[0],s=e[1],"xsd:dateTime"===n.value[1]&&"number"==typeof o&&(o=new Date(o).toLocaleString()))}}else o=e;return{value:o,timestamp:r,parameter:s}})),Es=()=>({view:e=>{var t;const n=e.attrs.device,{value:r,timestamp:s,parameter:o}=Cs(e.attrs.parameter,n,Ur()+Vr());if(null==r)return null;let i;(null===(t=n[o])||void 0===t?void 0:t.writable)&&(i=Xs("button",{title:"Edit parameter value",onclick:()=>{var e;e={name:"setParameterValues",devices:[n["DeviceID.ID"].value[0]],parameterValues:[[o,n[o].value[0],n[o].value[1]]]},Zr.size+e.devices.length>100?Zt("error","Too many tasks in queue"):Gr.add(e)}},Yr("edit")));const a=Xs("long-text",{text:`${r}`});return Xs("span",{class:"parameter-value",onmouseover:e=>{if(e.redraw=!1,e.target===a.dom){const t=Date.now()+Vr(),n=new Date(s).toLocaleString();e.target.title=`${n} (${function(e){let t="",n=2;for(const[r,s]of Object.entries(Ss))if(e>=s){let o;if(n>1?(o=Math.floor(e/s),e-=o*s):o=Math.round(e/s),t+=o>1?`${o} ${r}s `:`${o} ${r} `,!--n)break}return t+"ago"}(t-s)})`}}},a,i)}}),ks=()=>({view:e=>{const t=e.attrs.device,n=Object.values(e.attrs.parameters).map((e=>{const n=Hr(e.type,t),r=Xs.context({device:t,parameter:e.parameter},n||"parameter",e);return Xs("tr",{oncreate:e=>{e.dom.style.display=r.dom?"":"none"},onupdate:e=>{e.dom.style.display=r.dom?"":"none"}},Xs("th",e.label),Xs("td",r))}));return Xs("loading",{queries:[e.attrs.deviceQuery]},Xs("table.parameter-list",n))}}),Os=()=>({oninit:e=>{const t=e.attrs.parameter;if(!Array.isArray(t)||"PARAM"!==t[0])throw new Error("Object must be a parameter path");e.state.object=t[1],e.state.parameters=Object.values(e.attrs.childParameters)},view:e=>{const t=e.attrs.device,n=Hr(e.state.object,t),r=e.state.parameters;if("string"!=typeof n||!t[n])return null;const s=new Set,o=`${n}.`;for(const e in t)if(e.startsWith(o)){const t=e.indexOf(".",o.length);-1===t?s.add(e):s.add(e.slice(0,t))}const i=Object.values(r).map((e=>Xs("th",e.label))),a=Xs("thead",Xs("tr",i)),l=[];for(const n of s){let s=!("filter"in e.attrs)||e.attrs.filter;if(s=kt(s,(e=>Array.isArray(e)&&"PARAM"===e[0]?["PARAM",["||",n,".",e[1]]]:e)),!Hr(s,t))continue;const o=r.map((e=>{const r=kt(e.parameter,(e=>Array.isArray(e)&&"PARAM"===e[0]?["PARAM",["||",n,".",e[1]]]:e));return Xs("td",Xs.context({device:t,parameter:r},e.type||"parameter",Object.assign({},e,{device:t,parameter:r,label:null})))}));!0===t[n].writable&&o.push(Xs("td",Xs("button",{title:"Delete this instance",onclick:()=>{es({name:"deleteObject",device:t["DeviceID.ID"].value[0],objectName:n})}},Yr("delete-instance")))),l.push(Xs("tr",o))}let c;l.length||l.push(Xs("tr.empty",Xs("td",{colspan:i.length},"No instances"))),!0===t[n].writable&&l.push(Xs("tr",Xs("td",{colspan:i.length}),Xs("td",Xs("button",{title:"Create a new instance",onclick:()=>{es({name:"addObject",device:t["DeviceID.ID"].value[0],objectName:n})}},Yr("add-instance")))));const u=Hr(e.attrs.label,t);return null!=u&&(c=Xs("h2",u)),[c,Xs("loading",{queries:[e.attrs.deviceQuery]},Xs("table.table",a,Xs("tbody",l)))]}}),$s=Xt.ui.overview.charts,Ns=()=>({view:e=>{const t=e.attrs.device,n=Hr(e.attrs.chart,t||{}),r=$s[n];if(!r)return null;for(const e of Object.values(r.slices)){if(Hr(e.filter,t||{})){const t=Xs("svg",{width:"1em",height:"1em",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink"},Xs("circle",{cx:"0.5em",cy:"0.5em",r:"0.4em",fill:e.color}));return Xs("span.overview-dot",t,`${e.label}`)}}return null}}),Ps=Ht(((e,t,n)=>{const r={};for(const[n,s]of Object.entries(e)){const e=kt(s,(e=>{if(Array.isArray(e)&&"FUNC"===e[0]&&"ENCODEURICOMPONENT"===e[1]){const n=Hr(e[2],t);return null==n?null:encodeURIComponent(n)}return e}));r[n]=Hr(e,t)}return r})),Ds=()=>({view:e=>{const t=e.attrs.device;if("filter"in e.attrs&&!Hr(e.attrs.filter,t||{}))return null;const n=Object.values(e.attrs.components).map((e=>{if(Array.isArray(e)&&(e=Hr(e,t||{})),"object"!=typeof e)return`${e}`;const n=Hr(e.type,t||{});return n?Xs(n,e):null}));let r,s=e.attrs.element;return null==s?n:(Array.isArray(s)?s=Hr(s,t||{}):"object"==typeof s&&(null!=s.attributes&&(r=Ps(s.attributes,t||{},Ur())),s=Hr(s.tag,t||{})),Xs(s,r,n))}}),_s=()=>({view:e=>{const t=e.attrs.device;return Xs("button.primary",{title:"Initiate session and refresh basic parameters",onclick:n=>{n.target.disabled=!0;const r=Object.values(e.attrs.parameters).map((e=>Array.isArray(e)&&"PARAM"===e[0]?Hr(e[1],t):null)).filter((e=>!!e));is([{name:"getParameterValues",parameterNames:r,device:t["DeviceID.ID"].value[0]}],((e,t,n,r)=>{if(t)Zt("error",`${e}: ${t.message}`);else{for(const e of r)"stale"===e.status&&ts(e);"OK"!==n?Zt("error",`${e}: ${n}`):"stale"===r[0].status?Zt("error",`${e}: No contact from device`):"fault"===r[0].status?Zt("error",`${e}: Refresh faulted`):Zt("success",`${e}: Summoned`)}})).then((()=>{n.target.disabled=!1,Fr(Date.now())})).catch((e=>{n.target.disabled=!1,Zt("error",e.message)}))}},"Summon")}}),js=new Set(["true","True","TRUE","false","False","FALSE","null","Null","NULL"]);function Is(e){return!/[^\t\n\x20-\x7e\x85\u{a0}-\u{d7ff}\u{e000}-\u{fffd}\u{10000}-\u{10ffff}]/u.test(e)}function zs(e){return e&&Is(e)?/^[\s-?:,[\]{}#&$!|>'"%@`]|: | #|[\n,[\]{}]|\s$/.test(e)?JSON.stringify(e):e:JSON.stringify(e)}function Ms(e,t,n="",r=""){if(null==e)return void t.push(`${n}null`);if("number"==typeof e||"boolean"==typeof e)return void t.push(`${n}${JSON.stringify(e)}`);if(e instanceof Date)return void t.push(`${n}${e.toJSON()}`);if("string"==typeof e)return void function(e,t,n,r){if(/^\s*$/.test(e)||js.has(e)||!Is(e))return void t.push(n+JSON.stringify(e));r||(r="  ");const s=e.split("\n");if(s.length>1){let o="",i="-";if((s.find((e=>e))||"").startsWith(" ")&&(o=`${"  ".length}`),s[s.length-1]||(s.pop(),i=s[s.length-1]?"":"+"),/^\s+$/.test(s[s.length-1]))return void t.push(n+JSON.stringify(e));let a=!1;const l=s.map((e=>{const t=function(e){if(e.length<=80)return[e];if(e.startsWith(" "))return[e];const t=[];let n=0,r=0;for(let s=1;s<e.length-1;++s){if(" "!==e[s])continue;if(" "===e[s+1]){for(s+=2;" "===e[s];)++s;continue}if(s<=n+80){r=s;continue}const o=r>n?r:s;t.push(e.slice(n,o)),n=o+1,r=s}return r>n&&e.length>n+80&&(t.push(e.slice(n,r)),n=r+1),t.push(e.slice(n)),t}(e);return t.length>1&&(a=!0),t}));if(!a)return void t.push(`${n}|${o}${i}`,...s.map((e=>e?r+e:e)));t.push(`${n}>${o}${i}`),t.push(...l[0].map((e=>r+e)));for(let e=1;e<l.length;++e)l[e-1][0]&&!l[e-1][0].startsWith(" ")&&t.push(""),t.push(...l[e].map((e=>r+e)))}else/^[\s-?:,[\]{}#&$!|>'"%@`]|: | #|\s$/.test(e)||parseFloat(e)===+e?t.push(n+JSON.stringify(e)):t.push(n+e)}(e,t,n,r);if(Array.isArray(e)){if(!e.length)return void t.push(n+"[]");if(!n||n.endsWith("- ")){Ms(e[0],t,n+"- ",r+"  "),n=r+"- ",r+="  ";for(let s=1;s<e.length;++s)Ms(e[s],t,n,r)}else{t.push(n),n=r+"- ",r+="  ";for(let s=0;s<e.length;++s)Ms(e[s],t,n,r)}return}const s=Object.entries(e).filter((e=>void 0!==e[1]));if(s.length)if(!n||n.endsWith("- ")){Ms(s[0][1],t,n+`${zs(s[0][0])}: `,r+"  "),n=r,r+="  ";for(let e=1;e<s.length;++e)Ms(s[e][1],t,n+`${zs(s[e][0])}: `,r)}else{t.push(n),n=r,r+="  ";for(let e=0;e<s.length;++e)Ms(s[e][1],t,n+`${zs(s[e][0])}: `,r)}else t.push(n+"{}")}function Ls(e){if(void 0===e)return;const t=[];return Ms(e,t),t.join("\n")+"\n"}const Rs=()=>({view:e=>{const t=e.attrs.device["DeviceID.ID"].value[0],n=Tr("faults",["AND",[">",["PARAM","_id"],`${t}:`],["<",["PARAM","_id"],`${t}:zzzz`]]),r=["Channel","Code","Message","Detail","Retries","Timestamp"].map((e=>Xs("th",e))),s=Xs("thead",Xs("tr",r)),o=[];for(const e of n.value)o.push([Xs("td",e.channel),Xs("td",e.code),Xs("td",Xs("long-text",{text:e.message})),Xs("td",Xs("long-text",{text:Ls(e.detail)})),Xs("td",e.retries),Xs("td",new Date(e.timestamp).toLocaleString()),Xs("td",Xs("button",{title:"Delete fault",onclick:t=>{t.redraw=!1,Br("faults",e._id).then((()=>{Zt("success","Fault deleted"),Fr(Date.now()),Xs.redraw()})).catch((e=>{Zt("error",e.message),Fr(Date.now())}))}},Yr("remove")))]);let i;return i=o.length?Xs("tbody",o.map((e=>Xs("tr",e)))):Xs("tbody",Xs("tr.empty",Xs("td",{colspan:r.length},"No faults"))),Xs("loading",{queries:[n]},Xs("table.table",s,i))}});function Ts(e,t){let n,r=[];return s=>{r.push(s),clearTimeout(n),n=setTimeout((()=>{const t=r;r=[],e(t)}),t)}}const Us=Ht(Nt);const Fs=new WeakMap;const Vs=()=>{let e;const t=Ts((t=>{e=t[t.length-1],Xs.redraw()}),500);return{view:n=>{var r;const s=n.attrs.device,o=Hr(n.attrs.limit,s)||100,i=Xs("input",{type:"text",placeholder:"Search parameters",oninput:e=>{t(e.target.value),e.redraw=!1}}),a=/\.[0-9]+$/;let l;if(e){const t=e.split(" ").filter((e=>e));t.length&&(l=new RegExp(t.map((e=>e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"))).join(".*"),"i"))}const c=[],u=function(e){if(Fs.has(e))return Fs.get(e);const t=[];for(const n of Object.keys(e)){let e=0;for(let t=n.lastIndexOf(".",n.length-2);t>=0;t=n.lastIndexOf(".",t-1))++e;for(;t.length<=e;)t.push([]);t[e].push(n)}return Fs.set(e,t),t}(s);let f=0;for(const e of u){let t=0;for(const n of e){const e=s[n],i=(null===(r=e.value)||void 0===r?void 0:r[0])?`${n} ${e.value[0]}`:n;l&&!l.test(i)||(++t,f<o&&c.push(n))}f+=t}c.sort();const d=c.map((e=>{const t=s[e],n=[],r={key:e};return!1===t.object?n.push(Xs("parameter",Object.assign({device:s,parameter:Us(e)}))):t.object&&t.writable&&(a.test(e)?n.push(Xs("button",{title:"Delete this instance",onclick:()=>{es({name:"deleteObject",device:s["DeviceID.ID"].value[0],objectName:e})}},Yr("delete-instance"))):n.push(Xs("button",{title:"Create a new instance",onclick:()=>{es({name:"addObject",device:s["DeviceID.ID"].value[0],objectName:e})}},Yr("add-instance")))),n.push(Xs("button",{title:"Refresh tree",onclick:()=>{es({name:"getParameterValues",device:s["DeviceID.ID"].value[0],parameterNames:[e]})}},Yr("refresh"))),Xs("tr",r,Xs("td.left",Xs("long-text",{text:e})),Xs("td.right",n))}));return Xs("loading",{queries:[n.attrs.deviceQuery]},Xs(".all-parameters",Xs("a.download-csv",{href:`api/devices/${encodeURIComponent(s["DeviceID.ID"].value[0])}.csv`,download:"",style:"float: right;"},"Download"),i,Xs(".parameter-list",Xs("table",Xs("tbody",d)),Xs("m",`Displaying ${c.length} out of ${f} parameters.`))))}}},Ws=()=>({view:e=>{const t=e.attrs.device,n=[];return n.push(Xs("button.primary",{title:"Reboot device",onclick:()=>{es({name:"reboot",device:t["DeviceID.ID"].value[0]})}},"Reboot")),n.push(Xs("button.critical",{title:"Factory reset device",onclick:()=>{es({name:"factoryReset",device:t["DeviceID.ID"].value[0]})}},"Reset")),n.push(Xs("button.critical",{title:"Push a firmware or a config file",onclick:()=>{os({name:"download",devices:[t["DeviceID.ID"].value[0]]})}},"Push file")),n.push(Xs("button.primary",{title:"Delete device",onclick:()=>{if(!confirm("Deleting this device. Are you sure?"))return;const e=t["DeviceID.ID"].value[0];Br("devices",e).then((()=>{Zt("success",`${e}: Device deleted`),Xs.route.set("/devices")})).catch((e=>{Zt("error",e.message)}))}},"Delete")),Xs(".actions-bar",n)}});function qs(e){return decodeURIComponent(e.replace(/0x(?=[0-9A-Z]{2})/g,"%"))}const Bs=()=>({view:e=>{const t=e.attrs.device;let n=!0;"writable"in e.attrs&&(n=!!Hr(e.attrs.writable,t));const r=[];for(const e of Object.keys(t))e.startsWith("Tags.")&&r.push(qs(e.slice(5)));return r.sort(),n?Xs(".tags",r.map((e=>Xs("span.tag",e,Xs("button",{onclick:n=>{n.target.disabled=!0;const r=t["DeviceID.ID"].value[0];qr(r,{[e]:!1}).then((()=>{n.target.disabled=!1,Zt("success",`${r}: Tags updated`),Fr(Date.now())})).catch((e=>{n.target.disabled=!1,Zt("error",`${r}: ${e.message}`)}))}},Yr("remove"))))),Xs("span.tag.writable",Xs.trust("&nbsp;"),Xs("button",{onclick:e=>{e.target.disabled=!0;const n=t["DeviceID.ID"].value[0],r=prompt("Enter tag to assign to device:");r?qr(n,{[r]:!0}).then((()=>{e.target.disabled=!1,Zt("success",`${n}: Tags updated`),Fr(Date.now())})).catch((t=>{e.target.disabled=!1,Zt("error",`${n}: ${t.message}`)})):e.target.disabled=!1}},Yr("add")))):Xs(".tags",r.map((e=>Xs("span.tag",e))))}}),Js=e=>{let t,n;const r=()=>{if(!n){const t=e.dom;return void(t&&(t.innerHTML=""))}let r="";(function(e){return Ir({url:`api/ping/${encodeURIComponent(e)}`,background:!0})})(n).then((e=>{r=null!=e.avg?`${Math.trunc(e.avg)} ms`:"Unreachable"})).catch((()=>{r="Error!",clearInterval(t)})).finally((()=>{const t=e.dom;t&&(t.innerHTML=`Pinging ${n}: ${r}`)}))};return{onremove:()=>{clearInterval(t)},view:e=>{const s=e.attrs.device;let o,i=s["InternetGatewayDevice.ManagementServer.ConnectionRequestURL"];i||(i=s["Device.ManagementServer.ConnectionRequestURL"]);try{o=new URL(i.value[0]).hostname}catch(e){}return n!==o&&(n=o,clearInterval(t),n&&(r(),t=setInterval(r,3e3))),Xs("div",n?`Pinging ${n}:`:"")}}},Ks=()=>({view:e=>{let t;const n=e.attrs.device;n&&(t=n["DeviceID.ID"].value[0]);const r=Object.values(e.attrs.components).map((t=>{if(Array.isArray(t)&&(t=Hr(t,n||{})),"object"!=typeof t)return`${t}`;const r=Hr(t.type,n||{});if(!r)return null;const s=Object.assign({},e.attrs,t);return Xs(r,s)}));return t?Xs("a",{href:`#!/devices/${encodeURIComponent(t)}`},r):r}}),Hs=()=>({view:e=>{const t=e.attrs.text,n=e.attrs.element||"span";function r(e){e.dom.classList.add("long-text-overflowed"),e.dom.onclick=e=>{gs((()=>ce("textarea.long-text",{value:t,cols:80,rows:24,readonly:"",oncreate:e=>{e.dom.focus(),e.dom.select()}}))),e.stopPropagation(),ce.redraw()}}return ce(n,{oncreate:e=>{e.dom.clientWidth!==e.dom.scrollWidth&&r(e)},onupdate:e=>{e.dom.clientWidth===e.dom.scrollWidth?(e.dom.classList.remove("long-text-overflowed"),e.dom.onclick=null):r(e)},class:"long-text",title:t},t)}}),Qs=()=>{let e,t,n=!1;function r(r){if(!n)return e&&e.parentElement.remove(),t&&t.classList.remove("loading"),e=null,void(t=null);if(t&&t!==r.dom&&t.classList.remove("loading"),t=r.dom,t.classList.add("loading"),!e){const t=document.createElement("div");t.style.position="relative",t.style.pointerEvents="none",e=document.createElement("div"),e.classList.add("loading-overlay"),e.style.position="absolute",t.appendChild(e)}const s=e.parentElement;s.parentElement!==t.parentElement&&t.parentNode.appendChild(s);const o=s.getBoundingClientRect(),i=t.getBoundingClientRect();e.style.width=`${t.scrollWidth}px`,e.style.height=`${t.scrollHeight}px`,e.style.left=i.left-o.left+"px",e.style.top=i.top-o.top+"px"}return{view:e=>{const t=e.attrs.queries;return n=t.some((e=>e.fulfilling)),e.children},oncreate:r,onupdate:r,onremove:()=>{e&&e.parentElement.remove(),t&&t.classList.remove("loading"),e=null,t=null}}},Ys={parameter:Es,"parameter-list":ks,"parameter-table":Os,"overview-dot":Ns,container:Ds,"summon-button":_s,"device-faults":Rs,"all-parameters":Vs,"device-actions":Ws,tags:Bs,ping:Js,"device-link":Ks,"long-text":Hs,loading:Qs},Zs=new WeakMap,Gs=new WeakMap,Xs=new Proxy(ce,{apply:(e,t,n)=>{const r=n[0];return"string"!=typeof r?n[0]=no(r):Ys[r]&&(n[0]=no(Ys[r])),Reflect.apply(e,void 0,n)},get:(e,t)=>"context"===t?eo:Reflect.get(e,t)});function eo(e,...t){const n=Reflect.apply(Xs,void 0,t);return Gs.set(n,e),n}function to(e,t){var n;if(Array.isArray(e))for(const n of e)to(n,t);else if(e&&"object"==typeof e&&e.tag){const r=Object.assign({},t,Gs.get(e));if("string"!=typeof e.tag&&(Gs.set(e,r),e.attrs=Object.assign({},r,e.attrs)),null===(n=e.children)||void 0===n?void 0:n.length)for(const t of e.children)to(t,r)}}function no(e){var t;let n=Zs.get(e);if(!n){if("function"!=typeof e){n=Object.assign({},e);const t=e.view;n.view=function(e){const n=Gs.get(e)||{},r=Reflect.apply(t,this,[e]);return to(r,n),r}}else{if(null===(t=e.prototype)||void 0===t?void 0:t.view)throw new Error("Class components not supported");n=t=>{const n=e(t),r=n.view;return n.view=function(e){const t=Gs.get(e)||{};try{const n=Reflect.apply(r,this,[e]);return to(n,t),n}catch(e){return ce("p.error",{title:"Click to print stack trace to console",onclick:()=>console.error(e)},"Error!")}},n}}Zs.set(e,n)}return n}const ro=()=>({view:e=>{const t=e.attrs.onPasswordChange,n=!e.attrs.noAuth,r=e.attrs.username;r&&(e.state.username=r);const s=[Xs("p",Xs("label",{for:"username"},"User Name"),Xs("input",{name:"username",type:"text",value:e.state.username,disabled:!!r,oninput:t=>{e.state.username=t.target.value},oncreate:e=>{e.dom.focus()}}))];let o={newPassword:"New Password",confirmPassword:"Confirm Password"};n&&(o=Object.assign({authPassword:"Your Password"},o));for(const[t,n]of Object.entries(o))s.push(Xs("p",Xs("label",{for:t},n),Xs("input",{name:t,type:"password",value:e.state[t],oninput:n=>{e.state[t]=n.target.value}})));const i=Xs("button.primary",{type:"submit"},"UPDATE PASSWORD");s.push(Xs(".actions-bar",i));const a=[Xs("h1","Change Password"),Xs("form",{onsubmit:r=>{r.redraw=!1,r.preventDefault(),!e.state.username||!e.state.newPassword||n&&!e.state.authPassword?Zt("error","Please fill all fields"):e.state.newPassword!==e.state.confirmPassword?Zt("error","Password confirm doesn't match new password"):(i.dom.disabled=!0,Qr(e.state.username,e.state.newPassword,e.state.authPassword).then((()=>{Zt("success","Password updated successfully"),t&&t(),i.dom.disabled=!1})).catch((e=>{Zt("error",e.message),i.dom.disabled=!1})))}},s)];return Xs("div.put-form",a)}});const so=Object.freeze({__proto__:null,init:function(e){return Promise.resolve(e)},component:()=>{var e=!1;return window.username&&(e=!0),{view:t=>(window.username&&Xs.route.set(t.attrs.continue||"/"),document.title="Login - Coral Application",!e&&Xs("div",{class:"login-page-new-logo"},!e&&Xs("div",{class:"new-logo"},Xs("img",{src:"logoLight.png"})),Xs("div",{class:"login-form-details"},[Xs("h1","Sign In"),Xs("p.descript","Enter your username and password to sign in"),Xs("form.formdetail",Xs("p",Xs("label",{for:"username"},"User Name"),Xs("input",{name:"username",type:"text",value:t.state.username,oncreate:e=>{e.dom.focus()},oninput:e=>{t.state.username=e.target.value}})),Xs("p",Xs("label",{for:"password"},"Password"),Xs("input",{name:"password",type:"password",value:t.state.password,oninput:e=>{t.state.password=e.target.value}})),Xs("p",Xs("button.primary",{type:"submit",onclick:e=>{var n,r;return e.target.disabled=!0,(n=t.state.username,r=t.state.password,Ir({method:"POST",url:"login",background:!0,body:{username:n,password:r}})).then((()=>{location.reload()})).catch((t=>{Zt("error",t.response||t.message),e.target.disabled=!1})),!1}},"SIGN IN"))),Xs("div",Xs("button.primary",{onclick:()=>{const e=()=>{const t={onPasswordChange:()=>{vs(e),Xs.redraw()}};return Xs(ro,t)};gs(e)}},"CHANGE PASSWORD"))])))}}}),oo=Ht(Pt);const io=()=>({view:e=>function(e){const t=e.slices,n=Array.from(Object.values(e.slices)).reduce(((e,t)=>e+(t.count.value||0)),0),r=[],s=[],o=[];let i,a,l=0,c=100*Math.cos(2*Math.PI*l),u=100*Math.sin(2*Math.PI*l);for(const e of Object.values(t)){const t=n>0?(e.count.value||0)/n:0;if(r.push(Xs(".legend-line",[Xs("span.color",{style:`background-color: ${e.color} !important;`}),`${e.label}: `,Xs("a",{href:`#!/devices/?${Xs.buildQueryString({filter:oo(e.filter)})}`},e.count.value||0),` (${(100*t).toFixed(2)}%)`])),t>0){l+=t,i=100*Math.cos(2*Math.PI*l),a=100*Math.sin(2*Math.PI*l);const n=`M ${c} ${u} A 100 100 0 ${t>.5?1:0} 1 ${i} ${a} L 0 0 z`;c=i,u=a,s.push(Xs("path",{d:n,fill:e.color}));const r=50*Math.cos(2*Math.PI*(l-t/2)),f=50*Math.sin(2*Math.PI*(l-t/2));o.push(Xs("a",{"xlink:href":`#!/devices/?${Xs.buildQueryString({filter:oo(e.filter)})}`},[Xs("path",{d:n,"fill-opacity":0}),Xs("text",{x:r,y:f,"dominant-baseline":"middle","text-anchor":"middle"},`${(100*t).toFixed(2)}%`)]))}}return r.push(Xs("span.legend-total",`Total: ${n}`)),Xs("loading",{queries:Object.values(e.slices).map((e=>e.count))},Xs("div",{class:"pie-chart"},[Xs("svg",{viewBox:"-102 -102 204 204",width:"204px",height:"204px",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink"},s.concat(o)),Xs(".legend",r)]))}(e.attrs.chart)}),ao=Xt.ui.overview.groups||{},lo={};for(const e of Object.values(ao))for(const t of Object.values(e.charts))lo[t]=Xt.ui.overview.charts[t];function co(e){e=Object.assign({},e);for(let[t,n]of Object.entries(e)){e[t]=n=Object.assign({},n),n.slices=Object.assign({},n.slices);for(let[e,t]of Object.entries(n.slices)){const r=t.filter;n.slices[e]=t=Object.assign({},t),t.count=Mr("devices",r)}}return e}const uo=Object.freeze({__proto__:null,init:function(){return window.authorizer.hasAccess("devices",1)?Promise.resolve({charts:co(lo)}):Promise.reject(new Error("You are not authorized to view this page"))},component:()=>({view:e=>{document.title="Overview - Coral Application";const t=[];for(const n of Object.values(ao)){n.label&&t.push(Xs("h1",n.label));const r=[];for(const t of Object.values(n.charts)){const n=e.attrs.charts[t],s=[];n.label&&s.push(Xs("div.overviwpage",Xs("h2",n.label)));const o={};o.chart=n,s.push(Xs(io,o)),r.push(Xs(".overview-chart",s))}t.push(Xs(".overview-chart-group",r))}return t}})});const fo=()=>{let e,t=new Set;const n=Ts((t=>{e(t)}),500);return{view:r=>{const s=r.attrs.attributes,o=r.attrs.data,i=r.attrs.valueCallback,a=r.attrs.total,l=r.attrs.showMoreCallback,c=r.attrs.sortAttributes,u=r.attrs.onSortChange,f=r.attrs.downloadUrl,d=r.attrs.actionsCallback,h=r.attrs.recordActionsCallback,p=new Set;for(const e of o){const n=e._id||e["DeviceID.ID"].value[0];t.has(n)&&p.add(n)}return e=e=>{const t=new Set(Object.keys(c).map((e=>(parseInt(e)+1)*c[e])).filter((e=>e)));for(const n of e)t.delete(n+1)?t.add(-(n+1)):t.delete(-1*(n+1))||t.add(n+1);u(Array.from(t).reverse())},t=p,function(e,t,n,r,s,o,i,a,l,c,u){const f=t||[];let d=[];"function"==typeof c?(d=c(s),Array.isArray(d)||(d=[d])):Array.isArray(c)&&(d=c);const h=[];if(d.length){const e=Xs("input",{type:"checkbox",checked:f.length&&s.size===f.length,onchange:e=>{for(const t of f){const n=t._id||t["DeviceID.ID"].value[0];e.target.checked?s.add(n):s.delete(n)}},disabled:!n});h.push(Xs("th",e))}for(let t=0;t<e.length;t++){const n=e[t].label;if(!o.hasOwnProperty(t)){h.push(Xs("th",n));continue}let r=Yr("sort");(o[t]>0||o[t]<0)&&(r=Yr("sort"));const s=Xs("button",{onclick:e=>{e.redraw=!1,i(t)}},r);h.push(Xs("th",[n,s]))}const p=[];for(const t of f){const n=t._id||t["DeviceID.ID"].value[0],r=[];if(d.length){const e=Xs("input",{type:"checkbox",checked:s.has(n),onchange:e=>{e.target.checked?s.add(n):s.delete(n)},onclick:e=>{e.stopPropagation(),e.redraw=!1}});r.push(Xs("td",e))}for(const n of e){const e={};let s;if("function"==typeof l)s=l(n,t);else if("code"===n.type){const r=t[n.id].split("\n",11);r.length>10&&(r[10]=[""]),null==e.title&&(e.title=r.join("\n")),s=r[0]||""}else s=t[n.id];r.push(Xs("td",e,s))}let o=[];"function"==typeof u?(o=u(t),Array.isArray(o)||(o=[o])):Array.isArray(u)&&(o=u);for(const e of o)r.push(Xs("td.table-row-links",e));p.push(Xs("tr",{onclick:e=>{["INPUT","BUTTON","A"].includes(e.target.nodeName)?e.redraw=!1:s.delete(n)||s.add(n)}},r))}p.length||p.push(Xs("tr.empty",Xs("td",{colspan:h.length},"No records")));const m=[];null!=n?m.push(`${f.length}/${n}`):m.push(`${f.length}`),m.push(Xs("button",{title:"Show more records",onclick:r,disabled:!t.length||f.length>=Math.min(200,n)},"More")),a&&m.push(Xs("a.download-csv",{href:a,download:""},"Download"));const g=Xs("tfoot",Xs("tr",Xs("td",{colspan:h.length},m))),v=[Xs("table.table.highlight",Xs("thead",Xs("tr",h)),Xs("tbody",p),g)];return d.length&&v.push(Xs("div.actions-bar",d)),v}(s,o,a,l,t,c,n,f,i,d,h)}}};class ho{constructor(e,t){this.callback=t,this.element=null,this.hideTimeout=null,this.visible=!1,this.default=null,this.selection=null,this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.display="block",this.container.style.opacity="0",this.container.className=e}attach(e){e.setAttribute("autocomplete","off"),e.addEventListener("focus",(()=>{this.element=e,this.update(),this.reposition()})),e.addEventListener("blur",(()=>{this.element===e&&this.visible&&this.hide()})),e.addEventListener("keydown",(t=>{this.element===e&&("Escape"===t.key?this.visible&&this.hide():"Enter"===t.key?null!=this.default&&(e.value=this.default,t.stopImmediatePropagation(),e.dispatchEvent(new InputEvent("input")),this.update()):"ArrowDown"===t.key?(t.preventDefault(),null==this.selection?this.selection=0:++this.selection,this.update()):"ArrowUp"===t.key&&(t.preventDefault(),--this.selection,this.update()))})),e.addEventListener("input",(()=>{this.element===e&&(this.selection=null,this.update())}))}reposition(){if(!this.element)return;const e=this.element.getBoundingClientRect();e.width?(this.container.style.left=`${e.left+window.scrollX}px`,this.container.style.width=`${e.width}px`,this.container.style.top=`${e.bottom+window.scrollY}px`):this.visible&&this.hide()}hide(){this.container.style.opacity="0",this.visible=!1,this.default=null,this.selection=null,clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout((()=>{for(this.hideTimeout=null;this.container.firstChild;)this.container.removeChild(this.container.firstChild);document.body.removeChild(this.container)}),500)}update(){const e=this.element;this.callback(e.value,(t=>{if(this.element!==e)return;if(this.default=null,!t.length)return void(this.visible&&this.hide());for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);let n;this.visible||(this.hideTimeout?(clearTimeout(this.hideTimeout),this.hideTimeout=null):(document.body.appendChild(this.container),window.getComputedStyle(this.container).opacity),this.container.style.opacity="1",this.visible=!0),null!=this.selection?(this.selection=(this.selection%t.length+t.length)%t.length,this.default=t[this.selection].value):this.default=t[0].value;for(const[r,s]of t.entries()){const t=document.createElement("div");s.tip&&(t.title=s.tip),t.classList.add("suggestion"),r===this.selection&&(t.classList.add("selected"),n=t);const o=document.createTextNode(s.value);t.appendChild(o),t.addEventListener("mousedown",(t=>{t.preventDefault(),e.value=s.value,e.dispatchEvent(new InputEvent("input")),this.element===e&&this.update()})),this.container.appendChild(t)}n&&(this.container.scrollTop=Math.min(this.container.scrollTop,n.offsetTop),this.container.scrollTop=Math.max(this.container.scrollTop,n.offsetTop+n.scrollHeight-this.container.clientHeight))}))}}const po={devices:{},faults:{Device:{parameter:["PARAM","device"],type:"string"},Channel:{parameter:["PARAM","channel"],type:"string"},Code:{parameter:["PARAM","code"],type:"string"},Retries:{parameter:["PARAM","retries"],type:"number"},Timestamp:{parameter:["PARAM","timestamp"],type:"timestamp"}},presets:{ID:{parameter:["PARAM","_id"],type:"string"},Channel:{parameter:["PARAM","channel"],type:"string"},Weight:{parameter:["PARAM","weight"],type:"number"}},provisions:{ID:{parameter:["PARAM","_id"],type:"string"}},virtualParameters:{ID:{parameter:["PARAM","_id"],type:"string"}},files:{ID:{parameter:["PARAM","_id"],type:"string"},Type:{parameter:["PARAM","metadata.fileType"],type:"string"},OUI:{parameter:["PARAM","metadata.oui"],type:"string"},"Product class":{parameter:["PARAM","metadata.productClass"],type:"string"},Version:{parameter:["PARAM","metadata.version"],type:"string"}},permissions:{Role:{parameter:["PARAM","role"],type:"string"},Resource:{parameter:["PARAM","resource"],type:"string"},Access:{parameter:["PARAM","access"],type:"number"}},users:{Username:{parameter:["PARAM","_id"],type:"string"}}};for(const e of Object.values(Xt.ui.filters))po.devices[e.label]={parameter:e.parameter,type:(e.type||"").split(",").map((e=>e.trim()))};function mo(e,t){return["OR",["LIKE",e,t.toLowerCase()],["LIKE",e,t.toUpperCase()]]}function go(e){const t=function(e){return encodeURIComponent(e).replace(/[!~*'().]/g,(e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())).replace(/0x(?=[0-9A-Z]{2})/g,"0%78").replace(/%/g,"0x")}(e);return["IS NOT NULL",["PARAM",`Tags.${t}`]]}function vo(e,t){var n;let r;if(null===(n=po[e])||void 0===n?void 0:n[t]){const n=po[e][t],s="devices"===e?n.type:n.type.split(","),o=[];for(const e of s)switch(e.trim()){case"string":case"string-monocase":o.push("case insensitive string pattern");break;case"string-casesensitive":o.push("case sensitive string pattern");break;case"number":o.push("numeric value");break;case"timestamp":o.push("Unix timestamp or string in the form YYYY-MM-DDTHH:mm:ss.sssZ");break;case"mac":o.push("partial case insensitive MAC address");break;case"mac-wildcard":o.push("case insensitive MAC address");break;case"tag":o.push("case sensitive string")}o.length&&(r=`${t}: ${o.join(", ")}`)}return r}function wo(e,t,n){if(!po[e])return null;const r=po[e][t].type;n=n.trim();const s=["OR"];if(0===r.length||r.includes("number")){const r=function(e,t){let n="=";for(const e of["<>","=","<=","<",">=",">"])if(t.startsWith(e)){n=e,t=t.slice(e.length).trim();break}const r=parseInt(t);return r!==+t?null:[n,e,r]}(po[e][t].parameter,n);r&&s.push(r)}if(0===r.length||r.includes("string")){const r=function(e,t){return["LIKE",["FUNC","LOWER",e],t.toLowerCase()]}(po[e][t].parameter,n);r&&s.push(r)}if(0===r.length||r.includes("timestamp")){const r=function(e,t){let n="=";for(const e of["<>","=","<=","<",">=",">"])if(t.startsWith(e)){n=e,t=t.slice(e.length).trim();break}let r=parseInt(t);return r!==+t&&(r=Date.parse(t)),isNaN(r)?null:[n,e,r]}(po[e][t].parameter,n);r&&s.push(r)}if(r.includes("string-casesensitive")){const r=function(e,t){return["LIKE",e,t]}(po[e][t].parameter,n);r&&s.push(r)}if(r.includes("string-monocase")){const r=mo(po[e][t].parameter,n);r&&s.push(r)}if(r.includes("mac")){const r=function(e,t){return(t=t.replace(/[^a-f0-9]/gi,"").toLowerCase())?12===t.length?["OR",["=",e,t.replace(/(..)(?!$)/g,"$1:").toLowerCase()],["=",e,t.replace(/(..)(?!$)/g,"$1:").toUpperCase()]]:["OR",["LIKE",["FUNC","LOWER",e],`%${t.replace(/(..)(?!$)/g,"$1:")}%`],["LIKE",["FUNC","LOWER",e],`%${t.replace(/(.)(.)/g,"$1:$2")}%`]]:null}(po[e][t].parameter,n);r&&s.push(r)}if(r.includes("mac-wildcard")){const r=function(e,t){if(!/^[a-f0-9%]+$/i.test(t))return mo(e,t);const n=t.split("%").map((e=>[e.replace(/..(?=.)/gi,"$&:"),e.replace(/(.)(.)/gi,"$1:$2")])),r=new Set;for(let e=0;e<2**n.length;++e){const t=n.map(((t,n)=>t[e>>n&1])).join("%");/^[a-f0-9]:/i.test(t)||/:[a-f0-9]$/i.test(t)||(r.add(t.toLocaleLowerCase()),r.add(t.toUpperCase()))}if(!r.size)return mo(e,t);const s=[...r].map((t=>["LIKE",e,t]));return 1===s.length?s[0]:["OR",...s]}(po[e][t].parameter,n);r&&s.push(r)}if(r.includes("tag")){const e=go(n);e&&s.push(e)}return s.length<=1?null:2===s.length?s[1]:s}function yo(e,t){if(!Array.isArray(e))throw new Error("Left-hand operand must be a parameter");if("PARAM"!==e[0])throw new Error("Left-hand operand must be a parameter");if("string"!=typeof e[1])throw new Error("Left-hand operand must be a parameter");const n=e[1];if("devices"===t){if("DeviceID.ID"===n)return"_id";if("DeviceID"===n)return"_deviceId";if(n.startsWith("DeviceID."))return"_deviceId._"+n.slice(9);if("Events.Inform"===n)return"_lastInform";if("Events.Registered"===n)return"_registered";if("Events.0_BOOTSTRAP"===n)return"_lastBootstrap";if("Events.1_BOOT"===n)return"_lastBoot";if(!n.endsWith("._value")&&!n.startsWith("Tags."))return`${n}._value`}return n}function bo(e,t){if("devices"===t){if("_id"===e)return["string"];if("_lastInform"===e)return["date"];if("_registered"===e)return["date"];if("_lastBootstrap"===e)return["date"];if("_lastBoot"===e)return["date"];if(e.startsWith("_deviceId."))return["string"];if("Reboot._value"===e)return["date"];if("FactoryReset._value"===e)return["date"];if(e.endsWith("_timestamp"))return["date"];if(e.startsWith("Downloads.")){if(e.endsWith("Download._value"))return["date"];if(e.endsWith("Time._value"))return["date"];if(e.endsWith("Name._value"))return["string"];if(e.endsWith("Type._value"))return["string"]}if(e.endsWith("_value"))return["bool","number","date","string"]}else if("tasks"===t){if("_id"===e)return["oid"];if("timestamp"===e)return["date"];if("expiry"===e)return["date"];if("name"===e)return["string"];if("device"===e)return["string"]}else if("faults"===t){if("_id"===e)return["string"];if("timestamp"===e)return["date"];if("expiry"===e)return["date"];if("code"===e)return["string"];if("retries"===e)return["number"];if("channel"===e)return["string"];if("device"===e)return["string"];if("message"===e)return["string"]}else if("users"===t){if("_id"===e)return["string"];if("roles"===e)return["string"];if("password"===e)throw new Error("Cannot query restricted parameters");if("salt"===e)throw new Error("Cannot query restricted parameters")}else if("config"===t){if("_id"===e)return["string"];if("value"===e)return["string"]}else if("files"===t){if("_id"===e)return["string"];if("metadata.fileType"===e)return["string"];if("metadata.oui"===e)return["string"];if("metadata.productClass"===e)return["string"];if("metadata.version"===e)return["string"]}else if("permissions"===t){if("_id"===e)return["string"];if("role"===e)return["string"];if("resource"===e)return["devices"];if("access"===e)return["number"];if("filter"===e)return["string"];if("validate"===e)return["string"]}else if("presets"===t){if("_id"===e)return["string"];if("weight"===e)return["number"];if("channel"===e)return["string"];if("precondition"===e)return["string"];if(e.startsWith("events."))return["bool"]}else if("provisions"===t){if("_id"===e)return["string"];if("script"===e)return["string"]}else if("virtualParameters"===t){if("_id"===e)return["string"];if("script"===e)return["string"]}return"_id"===e?["oid","string"]:["bool","number","date","string"]}function Ao(e,t){const n=new Map;for(const r of e){const e=t(r);let s=n.get(e);s||n.set(e,s=[]),s.push(r)}return n.entries()}class xo{toString(){return JSON.stringify(this.toQuery(!0))}}class So extends xo{constructor(e,t){super(),this.parameter=e,this.value=t}toQuery(e){return e?{[this.parameter]:{$eq:this.value}}:{[this.parameter]:{$ne:this.value}}}}class Co extends xo{constructor(e,t,n,r){super(),this.parameter=e,this.op=t,this.value=n,this.type=r}toQuery(e){let t=this.value;return"date"===this.type&&"number"==typeof t&&(t={$date:new Date(t).toISOString()}),"oid"===this.type&&"string"==typeof t&&(t={$oid:t}),e?{[this.parameter]:{[this.op]:t}}:"$eq"===this.op?{[this.parameter]:{$ne:t}}:{[this.parameter]:{$not:{[this.op]:t}}}}}class Eo extends xo{constructor(e,t){super(),this.parameter=e,this.type=t}toQuery(e){return e?{[this.parameter]:{$type:this.type}}:{[this.parameter]:{$not:{$type:this.type}}}}}class ko extends xo{constructor(e,t,n,r){super(),this.parameter=e,this.caseSensitive=r,this.pattern=Dt(t,n)}toQuery(e){const t={"-":"\\-","/":"\\/","\\":"\\/","^":"\\^",$:"\\$","*":"\\*","+":"\\+","?":"\\?",".":"\\.","(":"\\(",")":"\\)","|":"\\|","[":"\\[","]":"\\]","{":"\\{","}":"\\}","\\%":".*","\\_":"."},n=this.pattern.map((e=>{var n;return null!==(n=t[e])&&void 0!==n?n:e}));n[0]=".*"===n[0]?"":"^"+n[0];const r=n.length-1;n[r]=[".*",""].includes(n[r])?"":n[r]+"$";const s=n.join(""),o=this.caseSensitive?"s":"is";return e?{[this.parameter]:{$regularExpression:{options:o,pattern:s}}}:{[this.parameter]:{$not:{$regularExpression:{options:o,pattern:s}}}}}}class Oo extends pr{constructor(e){super(),this.collection=e}getMinterms(e,t){const n=e.expression();if(!Array.isArray(n))throw new Error("Invalid query expression");if(null===t){const t=[];for(const n of e.getNullables()){const e=yo(n.operand.expression(),this.collection);if(e.startsWith("Tags.")&&"devices"===this.collection){const n=qs(e.slice(5)),r=new So("_tags",n);t.push([this.getVar(r)<<1]);continue}const r=new Co(e,"$eq",null,"");t.push([this.getVar(r)<<1^1])}return t}if([">","<","="].includes(n[0])){const e=yo(n[1],this.collection);let r,s=n[2];if("boolean"==typeof s)s=+s;else if("string"!=typeof s&&"number"!=typeof s)throw new Error("Right-hand operand must be a literal value");if(e.startsWith("Tags.")&&"devices"===this.collection&&"="===n[0]){const r=qs(e.slice(5)),o=new So("_tags",r);if("string"==typeof s&&(s=2),"="===n[0]){if(1===s!==t)return[]}else if(">"===n[0]){if(t&&s>=1||!t&&s<1)return[]}else if("<"===n[0]&&(t&&s<=1||!t&&s>1))return[];return[[this.getVar(o)<<1^1]]}"="===n[0]?r="$eq":">"===n[0]?r=t?"$gt":"$lte":"<"===n[0]&&(r=t?"$lt":"$gte");const o=new Set(bo(e,this.collection)),i=[];if("number"==typeof s)o.has("number")&&i.push(new Co(e,r,s,"number")),o.has("date")&&i.push(new Co(e,r,s,"date")),!o.has("bool")||0!==s&&1!==s||i.push(new Co(e,r,!!s,"bool"));else if("string"==typeof s&&(o.has("string")&&i.push(new Co(e,r,s,"string")),o.has("oid"))){const t=function(e,t){var n,r;const s=(null!==(r=null===(n=e.match(/^[0-9a-f]*/))||void 0===n?void 0:n[0])&&void 0!==r?r:"").slice(0,24);let o=tr("0x0"+s),i=0;e.length>s.length&&(i+=e.charCodeAt(s.length)),s.length<24&&(i-=48),i>0&&t&&o++,o<<=tr(4*(24-s.length)),i<0&&!t&&--o;const a=o.toString(16);return a.length>24||a.startsWith("-")?null:a.padStart(24,"0")}(s,"$lt"===r||"$lte"===r);!t||"$eq"===r&&t!==s||i.push(new Co(e,r,t,"oid"))}return"$eq"!==r||t?("number"==typeof s?(o.has("bool")&&(s>1&&("$lt"===r||"$lte"===r)||s<0&&("$gt"===r||"$gte"===r))&&i.push(new Co(e,"$gte",!1,"bool")),"$gt"!==r&&"$gte"!==r||(o.has("string")&&i.push(new Co(e,"$gte","","string")),o.has("oid")&&i.push(new Co(e,"$gte","000000000000000000000000","oid")))):"string"==typeof s&&("$lt"!==r&&"$lte"!==r||(o.has("bool")&&i.push(new Co(e,"$gte",!1,"bool")),o.has("number")&&(i.push(new Co(e,"$gte",0,"number")),i.push(new Co(e,"$lt",0,"number"))),o.has("date")&&(i.push(new Co(e,"$gte",0,"date")),i.push(new Co(e,"$lt",0,"date"))))),i.map((e=>[this.getVar(e)<<1^1]))):(i.push(new Co(e,"$eq",null,"")),[i.map((e=>this.getVar(e)<<1))])}if("LIKE"===n[0]){const e=n[2];if("string"!=typeof e)throw new Error("Right-hand operand of 'LIKE' must be a string");let r=n[1],s=!0;if(Array.isArray(r)&&"FUNC"===r[0]&&["UPPER","LOWER"].includes(r[1])){if("UPPER"===r[1]&&e!==e.toUpperCase())return t?[]:[[]];if("LOWER"===r[1]&&e!==e.toLowerCase())return t?[]:[[]];s=!1,r=r[2]}const o=yo(r,this.collection),i=new ko(o,e,n[3],s);if(t)return[[this.getVar(i)<<1^1]];const a=new Eo(o,"string");return[[this.getVar(i)<<1,this.getVar(a)<<1^1]]}throw new Error("Invalid query expression")}getDcSet(e){const t=[],n=new Set(e.flat().map((e=>e>>1))),r=Array.from(n).map((e=>this.getClause(e)));for(const[e,n]of Ao(r,(e=>e.parameter))){const r=n.filter((e=>e instanceof Co&&null!==e.value));for(const[n,s]of Ao(r,(e=>e.type))){const r=this.getVar(new Eo(e,n)),o=new Set(s.map((e=>e.value))),i=Array.from(o).sort(((e,t)=>e>t?1:-1));for(const[s,o]of i.entries()){const a=this.getVar(new Co(e,"$eq",o,n)),l=this.getVar(new Co(e,"$gt",o,n)),c=this.getVar(new Co(e,"$lt",o,n)),u=this.getVar(new Co(e,"$gte",o,n)),f=this.getVar(new Co(e,"$lte",o,n));if("bool"===n?!1===o?t.push([c<<1^1]):!0===o&&t.push([l<<1^1]):"string"===n?""===o&&t.push([c<<1^1]):"oid"===n&&(o<"000000000000000000000000"?t.push([f<<1^1]):"000000000000000000000000"===o?t.push([c<<1^1]):o>"ffffffffffffffffffffffff"?t.push([u<<1^1]):"ffffffffffffffffffffffff"===o&&t.push([l<<1^1])),t.push([c<<1^1,u<<1^1]),t.push([l<<1^1,u<<1^0]),t.push([a<<1^0,c<<1^0,f<<1^1]),t.push([a<<1^1,u<<1^0]),t.push([a<<1^1,l<<1^1]),0===s)t.push([r<<1^0,u<<1^1]),t.push([r<<1^0,c<<1^1]);else{const r=this.getVar(new Co(e,"$gt",i[s-1],n)),o=this.getVar(new Co(e,"$lte",i[s-1],n));t.push([r<<1^0,u<<1^1]),t.push([r<<1^0,o<<1^0,c<<1^1])}s===i.length-1&&t.push([r<<1^1,l<<1^0,f<<1^0])}}const s=n.filter((e=>e instanceof ko));if(s.length){const n=this.getVar(new Eo(e,"string"));for(let e=0;e<s.length;++e){const r=s[e];let o=r.pattern;t.push([this.getVar(r)<<1^1,n<<1^0]);for(let n=e+1;n<s.length;++n){const e=s[n];let i=e.pattern;r.caseSensitive&&e.caseSensitive||(o=o.map((e=>e.toLowerCase())),i=i.map((e=>e.toLowerCase()))),Ar(o,i)?t.push([this.getVar(r)<<1^1,this.getVar(e)<<1^1]):r.caseSensitive&&!e.caseSensitive||!br(o,i)?e.caseSensitive&&!r.caseSensitive||!br(i,o)||t.push([this.getVar(r)<<1^1,this.getVar(e)<<1^0]):t.push([this.getVar(r)<<1^0,this.getVar(e)<<1^1])}}}const o=this.getVar(new Co(e,"$eq",null,"")),i=bo(e,this.collection).map((t=>this.getVar(new Eo(e,t))));t.push([o<<1^0,...i.map((e=>e<<1^0))]);for(let e=0;e<i.length;++e){const n=i[e];t.push([n<<1^1,o<<1^1]);for(let r=e+1;r<i.length;++r){const e=i[r];t.push([n<<1^1,e<<1^1])}}"_id"===e&&t.push([o<<1^1])}return t}canRaise(e,t){if(!(1&e))return!0;const n=this.getClause(e>>1);if(n instanceof Co)for(const r of t){if(r===e)continue;const t=this.getClause(r>>1);if(t.parameter===n.parameter){if(!(1&r))return!1;if(t instanceof Eo)return!1}}return!0}toQuery(e){var t,n;const r=[];for(const s of e){const e={};e:for(const r of s){if(!s.length)return{};const o=!!(1&r),i=this.getClause(r>>1).toQuery(o);if(1!==Object.keys(i).length)throw new Error("Invalid query expression");const[a,l]=Object.entries(i)[0];if(Object.getPrototypeOf(l).constructor!==Object)throw new Error("Invalid query expression");const c=[e,...null!==(t=e.$and)&&void 0!==t?t:[]];for(const e of c){if(!(a in e)){e[a]=l;continue e}let t=l,n=e[a];if(t.$not&&n.$not&&(t=t.$not,n=n.$not),!Object.keys(t).some((e=>e in n))){Object.assign(n,t);continue e}}null!==(n=e.$and)&&void 0!==n||(e.$and=[]),e.$and.push({[a]:l})}r.push(e)}return 1===r.length?r[0]:{$or:r}}}const $o=Ht((e=>{const t=function(e){return po[e]?Object.keys(po[e]):[]}(e);return new ho("autocomplete",((n,r)=>{n=n.toLowerCase(),r(t.filter((e=>e.toLowerCase().includes(n))).map((t=>({value:`${t}: `,tip:vo(e,t)}))))}))}));function No(e,t){let n;if(/^[\s0-9a-zA-Z]+:/.test(t)){const e=t.split(":",1)[0],r=t.slice(e.length+1).trim();n=["FUNC","Q",e.trim(),r]}else n=Nt(t);return function(e,t){const n=gr.fromExpression(hr(e)),r=new Oo(t);n.true(r)}(kt(n,(t=>{if(Array.isArray(t)&&"FUNC"===t[0]){if("Q"===t[1])return wo(e,t[2],t[3]);if("NOW"===t[1])return Date.now()}return t})),e),n}function Po(e){return Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?`${e[2]}: ${e[3]}`:Pt(e)}function Do(e){if(!e)return[""];const t=[],n=Nt(e);if(Array.isArray(n)&&"AND"===n[0])for(const e of n.slice(1))t.push(Po(e));else t.push(Po(n));return t.push(""),t}const _o=e=>{let t=Do(e.attrs.filter),n=0,r=!1,s=e.attrs;function o(){r=!1,n=0,t=t.filter((e=>e));const e=t.map(((e,t)=>{try{return No(s.resource,e)}catch(e){n|=1<<t}return null}));t.push(""),n?ce.redraw():0===e.length?s.onChange(""):e.length>1?s.onChange(Pt(["AND",...e])):s.onChange(Pt(e[0]))}return{onupdate:e=>{$o(e.attrs.resource).reposition()},view:e=>(s.filter!==e.attrs.filter&&(n=0,t=Do(e.attrs.filter)),s=e.attrs,ce("div.filter",[ce("b","Filter"),...t.map(((s,i)=>ce("input",{type:"text",class:""+(n>>i&1?"error":""),value:s,oninput:e=>{e.redraw=!1,t[i]=e.target.value,r=!0},oncreate:t=>{const n=t.dom;$o(e.attrs.resource).attach(n),n.addEventListener("blur",(()=>{r&&o()})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&r&&o()}))}})))]))}},jo=Xt.ui.pageSize||10,Io=Ht(Nt),zo=Ht(JSON.parse),Mo=Ht((e=>{const t=function(e){const t=new Set;return kt(e,(e=>(_t(e)&&"PARAM"===e[0]&&t.add(e[1]),e))),Array.from(t)}(e);if(1===t.length){const e=Ft(t[0]);if("string"==typeof e)return e}return null})),Lo=Ht(((e,t)=>{const n={};for(const e of t)n[e.label]=Pt(e.parameter);return`api/devices.csv?${Xs.buildQueryString({filter:Pt(e),columns:JSON.stringify(n)})}`})),Ro=Ht((e=>kt(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wo("devices",e[2],e[3]):e))));function To(e){const t=[];return t.push(Xs("button.primary",{title:"Reboot selected devices",disabled:!e.size,onclick:()=>{es(...[...e].map((e=>({name:"reboot",device:e}))))}},"Reboot")),t.push(Xs("button.critical",{title:"Factory reset selected devices",disabled:!e.size,onclick:()=>{es(...[...e].map((e=>({name:"factoryReset",device:e}))))}},"Reset")),t.push(Xs("button.critical",{title:"Push a firmware or a config file",disabled:!e.size,onclick:()=>{os({name:"download",devices:[...e]})}},"Push file")),t.push(Xs("button.primary",{title:"Delete selected devices",disabled:!e.size,onclick:()=>{const t=Array.from(e);if(!confirm(`Deleting ${t.length} devices. Are you sure?`))return;let n=1;for(const e of t)++n,Br("devices",e).then((()=>{Zt("success",`${e}: Deleted`),0==--n&&Fr(Date.now())})).catch((t=>{Zt("error",`${e}: ${t.message}`),0==--n&&Fr(Date.now())}));0==--n&&Fr(Date.now())}},"Delete")),t.push(Xs("button.primary",{title:"Tag selected devices",disabled:!e.size,onclick:()=>{const t=Array.from(e),n=prompt(`Enter tag to assign to ${t.length} devices:`);if(!n)return;let r=1;for(const e of t)++r,qr(e,{[n]:!0}).then((()=>{Zt("success",`${e}: Tags updated`),0==--r&&Fr(Date.now())})).catch((t=>{Zt("error",`${e}: ${t.message}`),0==--r&&Fr(Date.now())}));0==--r&&Fr(Date.now())}},"Tag")),t.push(Xs("button.primary",{title:"Untag selected devices",disabled:!e.size,onclick:()=>{const t=Array.from(e),n=prompt(`Enter tag to unassign from ${t.length} devices:`);if(!n)return;let r=1;for(const e of t)++r,qr(e,{[n]:!1}).then((()=>{Zt("success",`${e}: Tags updated`),0==--r&&Fr(Date.now())})).catch((t=>{Zt("error",`${e}: ${t.message}`),0==--r&&Fr(Date.now())}));0==--r&&Fr(Date.now())}},"Untag")),t}const Uo=Object.freeze({__proto__:null,init:function(e){return new Promise(((t,n)=>{if(!window.authorizer.hasAccess("devices",2))return void n(new Error("You are not authorized to view this page"));const r=e.hasOwnProperty("filter")?""+e.filter:"",s=e.hasOwnProperty("sort")?""+e.sort:"",o=Object.values(Xt.ui.index);o.length||o.push({label:"ID",parameter:["PARAM","DeviceID.ID"]}),t({filter:r,indexParameters:o,sort:s})}))},component:()=>({view:e=>{document.title="Devices - Coral Application";const t=e.attrs.indexParameters;const n=e.attrs.sort?zo(e.attrs.sort):{},r={};for(let e=0;e<t.length;e++){const s=t[e];if(s.unsortable)continue;const o=Mo(s.parameter);o&&(r[e]=n[o]||0)}let s=!e.attrs.filter||Io(e.attrs.filter);s=Ro(s);const o=Tr("devices",s,{limit:e.state.showCount||jo,sort:n}),i=Mr("devices",s),a=Lo(s,t),l={};l.attributes=t,l.data=o.value,l.total=i.value,l.showMoreCallback=function(){e.state.showCount=(e.state.showCount||jo)+jo,Xs.redraw()},l.sortAttributes=r,l.onSortChange=function(n){const r={};for(const e of n){r[Mo(t[Math.abs(e)-1].parameter)]=Math.sign(e)}const s={sort:JSON.stringify(r)};e.attrs.filter&&(s.filter=e.attrs.filter),Xs.route.set("/devices",s)},l.downloadUrl=a,l.valueCallback=(e,t)=>Xs.context({device:t,parameter:e.parameter},e.type||"parameter",e),l.recordActionsCallback=e=>Xs("a",{href:`#!/devices/${encodeURIComponent(e["DeviceID.ID"].value[0])}`},"Show"),window.authorizer.hasAccess("devices",3)&&(l.actionsCallback=To);const c={resource:"devices",filter:e.attrs.filter,onChange:function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),Xs.route.set("/devices",n)}};return[Xs("h1","Listing Devices"),Xs(_o,c),Xs("loading",{queries:[o,i]},Xs(fo,l))]}})});const Fo=Object.freeze({__proto__:null,init:function(e){return window.authorizer.hasAccess("devices",2)?Promise.resolve({deviceId:e.id,deviceFilter:["=",["PARAM","DeviceID.ID"],e.id]}):Promise.reject(new Error("You are not authorized to view this page"))},component:()=>({view:e=>{document.title=`${e.attrs.deviceId} - Devices - Coral Application`;const t=Tr("devices",e.attrs.deviceFilter);if(!t.value.length)return t.fulfilling?Xs("loading",{queries:[t]},Xs("div",{style:"height: 100px;"})):Xs("p.error",`No such device ${e.attrs.deviceId}`);const n=Xt.ui.device,r=[];for(const e of Object.values(n))r.push(Xs.context({device:t.value[0],deviceQuery:t},e.type,e));return[Xs("h1",e.attrs.deviceId),r]}})}),Vo=()=>({view:function(e){return document.title="Error! - Coral Application",Xs("p.error",e.attrs.error)}}),Wo=Xt.ui.pageSize||10,qo=Ht(Nt),Bo=Ht(JSON.parse),Jo=[{id:"device",label:"Device"},{id:"channel",label:"Channel"},{id:"code",label:"Code"},{id:"message",label:"Message"},{id:"detail",label:"Detail"},{id:"retries",label:"Retries"},{id:"timestamp",label:"Timestamp"}],Ko=Ht((e=>{const t={};for(const e of Jo)t[e.label]="timestamp"===e.id?`DATE_STRING(${e.id})`:e.id;return`api/faults.csv?${Xs.buildQueryString({filter:Pt(e),columns:JSON.stringify(t)})}`})),Ho=Ht((e=>kt(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wo("faults",e[2],e[3]):e))));const Qo=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("faults",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Faults - Coral Application";const t=e.attrs.sort?Bo(e.attrs.sort):{},n={};for(let e=0;e<Jo.length;e++){const r=Jo[e];"detail"!==r.id&&(n[e]=t[r.id]||0)}let r=!e.attrs.filter||qo(e.attrs.filter);r=Ho(r);const s=Tr("faults",r,{limit:e.state.showCount||Wo,sort:t}),o=Mr("faults",r),i=Ko(r),a={};a.attributes=Jo,a.data=s.value,a.valueCallback=(e,t)=>{if("device"===e.id){const e=`#!/devices/${encodeURIComponent(t.device)}`;return Xs("a",{href:e},t.device)}return"message"===e.id?Xs("long-text",{text:t.message}):"detail"===e.id?Xs("long-text",{text:Ls(t.detail)}):"timestamp"===e.id?new Date(t.timestamp).toLocaleString():t[e.id]},a.total=o.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Wo)+Wo,Xs.redraw()},a.sortAttributes=n,a.onSortChange=function(t){const n={};for(const e of t)n[Jo[Math.abs(e)-1].id]=Math.sign(e);const r={sort:JSON.stringify(n)};e.attrs.filter&&(r.filter=e.attrs.filter),Xs.route.set("/faults",r)},a.downloadUrl=i,window.authorizer.hasAccess("faults",3)&&(a.actionsCallback=e=>Xs("button.primary",{disabled:0===e.size,title:"Delete selected faults",onclick:t=>{t.redraw=!1,t.target.disabled=!0,confirm(`Deleting ${e.size} faults. Are you sure?`)&&Promise.all(Array.from(e).map((e=>Br("faults",e)))).then((e=>{Zt("success",`${e.length} faults deleted`),Fr(Date.now())})).catch((e=>{Zt("error",e.message),Fr(Date.now())}))}},"Delete"));const l={resource:"faults",filter:e.attrs.filter,onChange:function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),Xs.route.set("/faults",n)}};return[Xs("h1","Listing Faults"),Xs(_o,l),Xs("loading",{queries:[s,o]},Xs(fo,a))]}})});let Yo,Zo,Go;function Xo(){Go||(Go=Zt("error","Error loading JS resource, please reload the page",{Reload:()=>{window.location.reload()}}))}function ei(){return Yo?Promise.resolve():new Promise(((e,t)=>{const n=[import("./codemirror-74604dfd.js").then((function(e){return e.c})),import("./codemirror-74604dfd.js").then((function(e){return e.j})),import("./codemirror-74604dfd.js").then((function(e){return e.y}))];Promise.all(n).then((t=>{Yo=t[0].default,e()})).catch((e=>{Xo(),t(e)}))}))}const ti=()=>({view:e=>Xs("textarea",{name:e.attrs.id,value:e.attrs.value,oncreate:t=>{const n=Yo.fromTextArea(t.dom,{mode:e.attrs.mode,lineNumbers:!0,readOnly:e.attrs.readOnly,extraKeys:{"Ctrl-Enter":()=>{e.attrs.onSubmit&&e.attrs.onSubmit(t.dom)},"Cmd-Enter":()=>{e.attrs.onSubmit&&e.attrs.onSubmit(t.dom)}}});e.attrs.onChange&&n.on("change",(t=>{e.attrs.onChange(t.getValue())})),e.attrs.focus&&n.focus(),e.attrs.onReady&&e.attrs.onReady(n)}})}),ni={presets:"preset",provisions:"provision",virtualParameters:"virtual parameter",files:"file",users:"user",permissions:"permission"};function ri(e,t,n){if("combo"===t.type){let r="",s=t.options;null!=e.object[t.id]&&(s.includes(e.object[t.id])||(s=s.concat([e.object[t.id]])),r=e.object[t.id]);const o=[Xs("option",{value:""},"")];for(const e of s)o.push(Xs("option",{value:e},e));return Xs("select",{name:t.id,value:r,oncreate:n?e=>{e.dom.focus()}:null,onchange:n=>{e.object[t.id]=n.target.value,e.modified=!0,n.redraw=!1}},o)}if("multi"===t.type){const r=Array.from(new Set(t.options.concat(e.object[t.id]||[]))),s=new Set(e.object[t.id]),o=r.map((r=>{const i=`${t.id}-${r}`;return Xs("tr",[Xs("td",Xs("input",{type:"checkbox",id:i,value:r,oncreate:e=>{n&&!o.length&&e.dom.focus(),s.has(r)&&(e.dom.checked=!0)},onchange:n=>{n.target.checked?s.add(r):s.delete(r),e.object[t.id]=Array.from(s),e.modified=!0,n.redraw=!1}})),Xs("td",r)])}));return Xs("table",o)}if("code"===t.type){const n={id:t.id,value:e.object[t.id],mode:"javascript",onSubmit:e=>{e.form.querySelector("button[type=submit]").click()},onChange:n=>{e.object[t.id]=n,e.modified=!0}};return Xs(ti,n)}if("file"===t.type)return Xs("input",{type:"file",name:t.id,oncreate:n?e=>{e.dom.focus()}:null,onchange:n=>{e.object[t.id]=n.target.files,e.modified=!0,n.redraw=!1}});if("textarea"===t.type)return Xs("textarea",{name:t.id,value:e.object[t.id],readonly:"_id"===t.id&&!e.isNew,cols:t.cols||80,rows:t.rows||4,style:"resize: none;",oncreate:n?e=>{const t=e.dom;t.focus(),t.setSelectionRange(t.value.length,t.value.length)}:null,oninput:n=>{e.object[t.id]=n.target.value,e.modified=!0,n.redraw=!1},onkeypress:e=>{if(e.redraw=!1,13===e.which&&!e.shiftKey){return e.target.form.querySelector("button[type=submit]").click(),!1}return!0}});let r=null;return t.options&&(r=function(e){const t="datalist"+e.reduce(((e,t)=>e^function(e){let t=0;for(let n=0;n<e.length;++n)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}(t)),0);if(!ws.has(t)){const n=ce("datalist",{id:t},e.map((e=>ce("option",{value:e}))));ws.set(t,n)}return t}(t.options)),Xs("input",{type:"password"===t.type?"password":"text",name:t.id,list:r,autocomplete:r?"off":null,disabled:"_id"===t.id&&!e.isNew,value:e.object[t.id],oncreate:n?e=>{e.dom.focus()}:null,oninput:n=>{e.object[t.id]=n.target.value,e.modified=!0,n.redraw=!1}})}const si=()=>({view:e=>{const t=e.attrs.actionHandler,n=e.attrs.attributes,r=e.attrs.resource,s=e.attrs.base||{};e.state.current||(e.state.current={isNew:!s._id,object:Object.assign({},s),modified:!1});const o=e.state.current,i=[];let a=!1;for(const e of n){let t=!1;a||!o.isNew&&"_id"===e.id||(t=a=!0),i.push(Xs("p",Xs("label",{for:e.id},e.label||e.id),Xs("br"),ri(o,e,t)))}const l=Xs("button.primary",{type:"submit"},"Save"),c=[l];o.isNew||c.push(Xs("button.primary",{type:"button",title:`Delete ${ni[r]||r}`,onclick:e=>{e.redraw=!1,e.target.disabled=!0,t("delete",o.object).finally((()=>{e.target.disabled=!1}))}},"Delete")),i.push(Xs(".actions-bar",c));const u=[Xs("h1",`${o.isNew?"New":"Editing"} ${ni[r]||r}`),Xs("form",{onsubmit:e=>{e.redraw=!1,e.preventDefault(),l.dom.disabled=!0,t("save",o.object).finally((()=>{l.dom.disabled=!1}))}},i)];return Xs("div.put-form",u)}}),oi=Xt.ui.pageSize||10,ii=Ht(Nt),ai=Ht(JSON.parse),li=[{id:"_id",label:"Name"},{id:"channel",label:"Channel"},{id:"weight",label:"Weight"},{id:"schedule",label:"Schedule"},{id:"events",label:"Events"},{id:"precondition",label:"Precondition",type:"textarea"},{id:"provision",label:"Provision",type:"combo"},{id:"provisionArgs",label:"Arguments",type:"textarea"}],ci=Ht((e=>kt(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wo("presets",e[2],e[3]):e))));function ui(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){const e=o._id;delete o._id;const t={};if(e||(t._id="ID can not be empty"),o.provision||(t.provision="Provision not selected"),Object.keys(t).length)return void r(t);if(o.precondition)try{o.precondition=Pt(ii(o.precondition))}catch(e){return void r({precondition:"Precondition must be valid expression"})}Kr("presets",e).then((t=>t&&n?(Fr(Date.now()),void r({_id:"Preset already exists"})):t||n?void Jr("presets",e,o).then((()=>{Zt("success","Preset "+(t?"updated":"created")),Fr(Date.now()),r(null)})).catch(s):(Fr(Date.now()),void r({_id:"Preset does not exist"})))).catch(s)}else"delete"===e?Br("presets",o._id).then((()=>{Zt("success","Preset deleted"),Fr(Date.now()),r(null)})).catch((e=>{s(e),Fr(Date.now())})):s(new Error("Undefined action"))}))}const fi={resource:"presets",attributes:li},di=Ht((e=>{const t={};for(const e of li)t[e.label]=e.id;return`api/presets.csv?${Xs.buildQueryString({filter:Pt(e),columns:JSON.stringify(t)})}`}));const hi=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("presets",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Presets - Coral Application";const t=e.attrs.sort?ai(e.attrs.sort):{},n={};for(let e=0;e<li.length;e++){const r=li[e];"events"!==r.id&&"precondition"!==r.id&&"provision"!==r.id&&"provisionArgs"!==r.id&&(n[e]=t[r.id]||0)}let r=!e.attrs.filter||ii(e.attrs.filter);r=ci(r);const s=Tr("presets",r,{limit:e.state.showCount||oi,sort:t}),o=Mr("presets",r),i=new Set,a=new Set(["refresh","value","tag","reboot","reset","download","instances"]),l=Tr("provisions",!0);if(l.fulfilled)for(const e of l.value)i.add(e._id),a.add(e._id);li.find((e=>"provision"===e.id)).options=Array.from(a);const c=di(r),u={};u.attributes=li,u.data=s.value,u.total=o.value,u.showMoreCallback=function(){e.state.showCount=(e.state.showCount||oi)+oi,Xs.redraw()},u.sortAttributes=n,u.onSortChange=function(t){const n={};for(const e of t)n[li[Math.abs(e)-1].id]=Math.sign(e);const r={sort:JSON.stringify(n)};e.attrs.filter&&(r.filter=e.attrs.filter),Xs.route.set("/admin/presets",r)},u.downloadUrl=c,u.valueCallback=(e,t)=>{if("precondition"===e.id){let e="#!/devices";return t.precondition.length&&(e+=`?${Xs.buildQueryString({filter:t.precondition})}`),Xs("a",{href:e,title:t.precondition},t.precondition)}return"provision"===e.id&&i.has(t[e.id])?Xs("a",{href:`#!/admin/provisions?${Xs.buildQueryString({filter:`Q("ID", "${t.provision}")`})}`},t.provision):t[e.id]},u.recordActionsCallback=e=>[Xs("a",{onclick:()=>{let t=null;const n=Xs(si,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{ui(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)Zt("error",e);else vs(t);r()})).catch((e=>{Zt("error",e.message),r()}))}))},fi));t=()=>e.provision?n:Xs("div",{style:"margin:20px"},"This UI only supports presets with a single 'provision' configuration. If this preset was originally created from the old UI (genieacs-gui), you must edit it there."),gs(t,(()=>{var e;return!(null===(e=n.state)||void 0===e?void 0:e.current.modified)||confirm("You have unsaved changes. Close anyway?")}))}},"Show")],window.authorizer.hasAccess("presets",3)&&(u.actionsCallback=e=>[Xs("button.primary",{title:"Create New Preset",onclick:()=>{let e=null;const t=Xs(si,Object.assign({actionHandler:(t,n)=>new Promise((r=>{ui(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)Zt("error",e);else vs(e);r()})).catch((e=>{Zt("error",e.message),r()}))}))},fi));e=()=>t,gs(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),Xs("button.primary",{title:"Delete selected presets",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} presets. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>Br("presets",e)))).then((e=>{Zt("success",`${e.length} presets deleted`),Fr(Date.now())})).catch((e=>{Zt("error",e.message),Fr(Date.now())})))}},"Delete")]);const f={resource:"presets",filter:e.attrs.filter,onChange:function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),Xs.route.set("/admin/presets",n)}};return[Xs("h1","Listing Presets"),Xs(_o,f),Xs("loading",{queries:[s,o]},Xs(fo,u))]}})}),pi=Xt.ui.pageSize||10,mi=Ht(Nt),gi=Ht(JSON.parse),vi=[{id:"_id",label:"Name"},{id:"script",label:"Script",type:"code"}],wi=Ht((e=>kt(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wo("provisions",e[2],e[3]):e))));function yi(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){const e=o._id;if(delete o._id,!e)return void r({_id:"ID can not be empty"});Kr("provisions",e).then((t=>t&&n?(Fr(Date.now()),void r({_id:"Provision already exists"})):t||n?void Jr("provisions",e,o).then((()=>{Zt("success","Provision "+(t?"updated":"created")),Fr(Date.now()),r(null)})).catch((e=>{400===e.code&&e.response?s(new Error(e.response)):s(e)})):(Fr(Date.now()),void r({_id:"Provision does not exist"})))).catch(s)}else"delete"===e?Br("provisions",o._id).then((()=>{Zt("success","Provision deleted"),Fr(Date.now()),r(null)})).catch((e=>{Fr(Date.now()),s(e)})):s(new Error("Undefined action"))}))}const bi={resource:"provisions",attributes:vi},Ai=Ht((e=>{const t={};for(const e of vi)t[e.label]=e.id;return`api/provisions.csv?${Xs.buildQueryString({filter:Pt(e),columns:JSON.stringify(t)})}`}));const xi=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("provisions",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return new Promise(((e,r)=>{ei().then((()=>{e({filter:n,sort:t})})).catch(r)}))},component:()=>({view:e=>{document.title="Provisions - Coral Application";const t=e.attrs.sort?gi(e.attrs.sort):{},n={};for(let e=0;e<vi.length;e++)n[e]=t[vi[e].id]||0;let r=!e.attrs.filter||mi(e.attrs.filter);r=wi(r);const s=Tr("provisions",r,{limit:e.state.showCount||pi,sort:t}),o=Mr("provisions",r),i=Ai(r),a={};a.attributes=vi,a.data=s.value,a.total=o.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||pi)+pi,Xs.redraw()},a.sortAttributes=n,a.onSortChange=function(t){const n={};for(const e of t)n[vi[Math.abs(e)-1].id]=Math.sign(e);const r={sort:JSON.stringify(n)};e.attrs.filter&&(r.filter=e.attrs.filter),Xs.route.set("/admin/provisions",r)},a.downloadUrl=i,a.recordActionsCallback=e=>[Xs("a",{onclick:()=>{let t=null;const n=Xs(si,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{yi(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)Zt("error",e);else vs(t);r()})).catch((e=>{Zt("error",e.message),r()}))}))},bi));t=()=>n,gs(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"Show")],window.authorizer.hasAccess("provisions",3)&&(a.actionsCallback=e=>[Xs("button.primary",{title:"Create New Provision",onclick:()=>{let e=null;const t=Xs(si,Object.assign({actionHandler:(t,n)=>new Promise((r=>{yi(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)Zt("error",e);else vs(e);r()})).catch((e=>{Zt("error",e.message),r()}))}))},bi));e=()=>t,gs(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),Xs("button.primary",{title:"Delete Selected Provisions",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} provisions. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>Br("provisions",e)))).then((e=>{Zt("success",`${e.length} provisions deleted`),Fr(Date.now())})).catch((e=>{Zt("error",e.message),Fr(Date.now())})))}},"Delete")]);const l={resource:"provisions",filter:e.attrs.filter,onChange:function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),Xs.route.set("/admin/provisions",n)}};return[Xs("h1","Listing Provisions"),Xs(_o,l),Xs("loading",{queries:[s,o]},Xs(fo,a))]}})}),Si=Xt.ui.pageSize||10,Ci=Ht(Nt),Ei=Ht(JSON.parse),ki=[{id:"_id",label:"Name"},{id:"script",label:"Script",type:"code"}],Oi=Ht((e=>kt(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wo("virtualParameters",e[2],e[3]):e))));function $i(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){const e=o._id;if(delete o._id,!e)return void r({_id:"ID can not be empty"});Kr("virtualParameters",e).then((t=>t&&n?(Fr(Date.now()),void r({_id:"Virtual parameter already exists"})):t||n?void Jr("virtualParameters",e,o).then((()=>{Zt("success","Virtual parameter "+(t?"updated":"created")),Fr(Date.now()),r(null)})).catch((e=>{400===e.code&&e.response?s(new Error(e.response)):s(e)})):(Fr(Date.now()),void r({_id:"Virtual parameter does not exist"})))).catch(s)}else"delete"===e?Br("virtualParameters",o._id).then((()=>{Zt("success","Virtual parameter deleted"),Fr(Date.now()),r(null)})).catch((e=>{Fr(Date.now()),s(e)})):s(new Error("Undefined action"))}))}const Ni={resource:"virtualParameters",attributes:ki},Pi=Ht((e=>{const t={};for(const e of ki)t[e.label]=e.id;return`api/virtualParameters.csv?${Xs.buildQueryString({filter:Pt(e),columns:JSON.stringify(t)})}`}));const Di=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("virtualParameters",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return new Promise(((e,r)=>{ei().then((()=>{e({filter:n,sort:t})})).catch(r)}))},component:()=>({view:e=>{document.title="Virtual Parameters - Coral Application";const t=e.attrs.sort?Ei(e.attrs.sort):{},n={};for(let e=0;e<ki.length;e++)n[e]=t[ki[e].id]||0;let r=!e.attrs.filter||Ci(e.attrs.filter);r=Oi(r);const s=Tr("virtualParameters",r,{limit:e.state.showCount||Si,sort:t}),o=Mr("virtualParameters",r),i=Pi(r),a={};a.attributes=ki,a.data=s.value,a.total=o.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Si)+Si,Xs.redraw()},a.sortAttributes=n,a.onSortChange=function(t){const n={};for(const e of t)n[ki[Math.abs(e)-1].id]=Math.sign(e);const r={sort:JSON.stringify(n)};e.attrs.filter&&(r.filter=e.attrs.filter),Xs.route.set("/admin/virtualParameters",r)},a.downloadUrl=i,a.recordActionsCallback=e=>[Xs("a",{onclick:()=>{let t=null;const n=Xs(si,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{$i(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)Zt("error",e);else vs(t);r()})).catch((e=>{Zt("error",e.message),r()}))}))},Ni));t=()=>n,gs(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"Show")],window.authorizer.hasAccess("virtualParameters",3)&&(a.actionsCallback=e=>[Xs("button.primary",{title:"Create new virtual parameter",onclick:()=>{let e=null;const t=Xs(si,Object.assign({actionHandler:(t,n)=>new Promise((r=>{$i(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)Zt("error",e);else vs(e);r()})).catch((e=>{Zt("error",e.message),r()}))}))},Ni));e=()=>t,gs(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),Xs("button.primary",{title:"Delete selected virtual parameters",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} virtual parameters. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>Br("virtualParameters",e)))).then((e=>{Zt("success",`${e.length} virtual parameters deleted`),Fr(Date.now())})).catch((e=>{Zt("error",e.message),Fr(Date.now())})))}},"Delete")]);const l={resource:"virtualParameters",filter:e.attrs.filter,onChange:function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),Xs.route.set("/admin/virtualParameters",n)}};return[Xs("h1","Listing Virtual Parameters"),Xs(_o,l),Xs("loading",{queries:[s,o]},Xs(fo,a))]}})}),_i=Xt.ui.pageSize||10,ji=Ht(Nt),Ii=Ht(JSON.parse),zi=[{id:"_id",label:"Name"},{id:"metadata.fileType",label:"Type",options:["1 Firmware Upgrade Image","2 Web Content","3 Vendor Configuration File","4 Tone File","5 Ringer File"]},{id:"metadata.oui",label:"OUI"},{id:"metadata.productClass",label:"Product Class"},{id:"metadata.version",label:"Version"}],Mi={resource:"files",attributes:zi.slice(1).concat([{id:"file",label:"File",type:"file"}])},Li=Ht((e=>kt(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wo("files",e[2],e[3]):e))));const Ri=Ht((e=>{const t={};for(const e of zi)t[e.label]=e.id;return`api/files.csv?${Xs.buildQueryString({filter:Pt(e),columns:JSON.stringify(t)})}`}));const Ti=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("files",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Files - Coral Application";const t=e.attrs.sort?Ii(e.attrs.sort):{},n={};for(let e=0;e<zi.length;e++)n[e]=t[zi[e].id]||0;let r=!e.attrs.filter||ji(e.attrs.filter);r=Li(r);const s=Tr("files",r,{limit:e.state.showCount||_i,sort:t}),o=Mr("files",r),i=Ri(r),a={};a.attributes=zi,a.data=s.value,a.total=o.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||_i)+_i,Xs.redraw()},a.sortAttributes=n,a.onSortChange=function(t){const n={};for(const e of t)n[zi[Math.abs(e)-1].id]=Math.sign(e);const r={sort:JSON.stringify(n)};e.attrs.filter&&(r.filter=e.attrs.filter),Xs.route.set("/admin/files",r)},a.downloadUrl=i,a.recordActionsCallback=e=>[Xs("a",{href:"api/blob/files/"+e._id},"Download")],window.authorizer.hasAccess("files",3)&&(a.actionsCallback=e=>[Xs("button.secondary",{title:"Create new file",onclick:()=>{let e=null;const t=new AbortController;let n=-1;const r=Xs(si,Object.assign({actionHandler:async(r,s)=>{var o;if("save"!==r)throw new Error("Undefined action");const i=null===(o=s.file)||void 0===o?void 0:o[0],a={"metadata-fileType":s["metadata.fileType"]||"","metadata-oui":s["metadata.oui"]||"","metadata-productclass":s["metadata.productClass"]||"","metadata-version":s["metadata.version"]||""};if(!i)return void Zt("error","File not selected");if(await Kr("files",i.name))return Fr(Date.now()),void Zt("error","File already exists");const l=e=>{n=e.loaded/e.total,Xs.redraw()};n=0;try{await function(e,t,n,r){return Ir({method:"PUT",headers:t=Object.assign({"Content-Type":"application/octet-stream"},t),url:`api/files/${encodeURIComponent(e.name)}`,serialize:e=>e,body:e,config:e=>{r&&e.upload.addEventListener("progress",r),n&&(n.aborted&&e.abort(),n.addEventListener("abort",(()=>e.abort())))}})}(i,a,t.signal,l),Fr(Date.now()),Zt("success","File created"),vs(e)}catch(e){Zt("error",e.message)}n=-1}},Mi));e=()=>n<0?[null,r]:[Xs("div.progress",Xs("div.progress-bar",{style:`width: ${Math.trunc(100*n)}%`})),r],gs(e,(()=>!(r.state.current.modified&&!confirm("You have unsaved changes. Close anyway?"))&&(t.abort(),!0)))}},"New"),Xs("button.secondary",{title:"Delete selected files",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} files. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>Br("files",e)))).then((e=>{Zt("success",`${e.length} files deleted`),Fr(Date.now())})).catch((e=>{Zt("error",e.message),Fr(Date.now())})))}},"Delete")]);const l={resource:"files",filter:e.attrs.filter,onChange:function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),Xs.route.set("/admin/files",n)}};return[Xs("h1","Listing Files"),Xs(_o,l),Xs("loading",{queries:[s,o]},Xs(fo,a))]}})});function Ui(e){let t=1;if(null==e||"object"!=typeof e)return t;if(Array.isArray(e)){for(const n of e)t+=Ui(n);return t}const n=Object.entries(e).map((([e,t])=>[e,Ui(t)]));n.sort(((e,t)=>e[1]!==t[1]?e[1]-t[1]:t[0]>e[0]?-1:1));for(const[r,s]of n){t+=s;const n=e[r];delete e[r],e[r]=n}return t}function Fi(e){e.sort(((e,t)=>e._id>t._id?1:e._id<t._id?-1:0));const t={};for(const n of e){const e=n._id.split(".");let r=t;for(;e.length>1;){const t=e.shift();null!=r[t]&&"object"==typeof r[t]||(r[t]={}),r=r[t]}r[e[0]]=n.value}const n=function(e){if(null==e||"object"!=typeof e)return e;if(Object.keys(e).length<=300){let t=[];for(const n of Object.keys(e)){const e=Math.floor(+n);if(!(e>=0&&e<300&&String(e)===n)){t=[];break}{const n=Math.floor(e/30);t[n]||(t[n]=0),t[n]|=1<<e%30}}let n=0;for(;t.length&&1073741823===(n=t.shift()););if(n&&(~n&n+1)===n+1){const t=[];for(let n=0;n<Object.keys(e).length;n++)t[n]=e[n];e=t}}for(const[t,r]of Object.entries(e))e[t]=n(r);return e},r=n(t);return Ui(r),r}function Vi(e,t){return new Promise(((n,r)=>{try{let s=Zo.parse(t,{schema:"failsafe"});if(s){const t={};let n=t;e.forEach(((t,r)=>{r<e.length-1?(n[t]={},n=n[t]):n[t]=s})),s=function(e){const t={},n=(e,r)=>{for(const[s,o]of Object.entries(e)){const e=r?`${r}.${s}`:s;void 0!==o&&(null===o||"object"!=typeof o?t[e]=o:n(o,e))}};return null!==e&&"object"==typeof e&&n(e,""),t}(t)}else s={};for(const e of Object.values(s))Nt(e);(function(e="%"){const t=Pt(["LIKE",["PARAM","_id"],e]);return Ir({method:"GET",url:`api/config/?${ce.buildQueryString({filter:t})}`,background:!0})})(`${e.join(".")}.%`).then((e=>{const t={};for(const n of e)t[n._id]=n.value;const o=function(e,t){const n={add:[],remove:[]};for(const[r,s]of Object.entries(t))s&&e[r]!==s&&n.add.push({_id:r,value:s});for(const r of Object.keys(e))t[r]||n.remove.push(r);return n}(t,s);if(!o.add.length&&!o.remove.length)return void n(null);const i=[];for(const e of o.add)i.push(Jr("config",e._id,e));for(const e of o.remove)i.push(Br("config",e));Promise.all(i).then((()=>{n(null)})).catch(r)})).catch(r)}catch(e){n({config:e.message})}}))}const Wi=()=>({view:e=>{const t=e.attrs.prefix.split("."),n=e.attrs.name,r=e.attrs.data;let s;if(""===t[t.length-1]&&t.pop(),r.length){s=Fi(r);for(const e of t)s=s[e]}const o=s&&Object.values(s).length?Zo.stringify(s,{schema:"failsafe"}):"",i=Xs(ti,{id:`${n}-ui-config`,value:o,mode:"yaml",focus:!0,onSubmit:e=>{e.form.querySelector("button[type=submit]").click()},onChange:t=>{e.state.updatedYaml=t,e.state.modified=!0}}),a=Xs("button.primary",{type:"submit"},"Save");return Xs("div.put-form",[Xs("h1",`Editing ${n}`),Xs("form",{onsubmit:n=>{n.redraw=!1,n.preventDefault(),null==e.state.updatedYaml&&(e.state.updatedYaml=o),Vi(t,e.state.updatedYaml).then(e.attrs.onUpdate).catch(e.attrs.onError)}},[i,Xs(".actions-bar",[a])])])}});function qi(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){let e=o._id||"";delete o._id;const t=/^[0-9a-zA-Z_.-]+$/;if(e=e.trim(),!e.match(t))return void r({_id:"Invalid ID"});try{o.value=Pt(Nt(o.value||""))}catch(e){return void r({value:"Config value must be valid expression"})}Kr("config",e).then((t=>t&&n?(Fr(Date.now()),void r({_id:"Config already exists"})):t||n?void Jr("config",e,o).then((()=>{Zt("success","Config "+(t?"updated":"created")),Fr(Date.now()),r(null)})).catch(s):(Fr(Date.now()),void r({_id:"Config does not exist"})))).catch(s)}else"delete"===e?Br("config",o._id).then((()=>{Zt("success","Config deleted"),Fr(Date.now()),r(null)})).catch((e=>{Fr(Date.now()),s(e)})):s(new Error("Undefined action"))}))}const Bi={resource:"config",attributes:[{id:"_id",label:"Key"},{id:"value",label:"Value",type:"textarea"}]};function Ji(e,t){const n=e.value.sort(((e,t)=>e._id<t._id?-1:1));let r;if(t){const e=t.split(" ").filter((e=>e));e.length&&(r=new RegExp(e.map((e=>e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"))).join(".*"),"i"))}const s=[];for(const e of n){const t={};!r||r.test(e._id)||r.test(e.value)||(t.style="display: none;");const n=Xs("button",{title:"Edit config value",onclick:()=>{let t=null;const n=Xs(si,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{qi(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)Zt("error",e);else vs(t);r()})).catch((e=>{Zt("error",e.message),r()}))}))},Bi));t=()=>n,gs(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},Yr("edit")),o=Xs("button",{title:"Delete config",onclick:()=>{confirm(`Deleting ${e._id} config. Are you sure?`)&&qi("delete",e).catch((e=>{throw e}))}},Yr("remove"));s.push(Xs("tr",t,Xs("td.left",Xs("long-text",{text:e._id})),Xs("td.right",Xs("span",[Xs("long-text",{text:`${e.value}`}),n,o]))))}return s.length||s.push(Xs("tr.empty",Xs("td",{colspan:2},"No config"))),Xs("table",Xs("tbody",s))}const Ki=Object.freeze({__proto__:null,init:function(){return window.authorizer.hasAccess("config",2)?new Promise(((e,t)=>{Promise.all([ei(),Zo?Promise.resolve():new Promise(((e,t)=>{import("./yaml-f0926a8c.js").then((function(e){return e.i})).then((t=>{Zo=t,e()})).catch((e=>{Xo(),t(e)}))}))]).then((()=>{e({})})).catch(t)})):Promise.reject(new Error("You are not authorized to view this page"))},component:()=>({view:e=>{document.title="Config - Coral Application";const t=Xs("input",{type:"text",placeholder:"Search config",oninput:t=>{e.state.searchString=t.target.value,t.redraw=!1,clearTimeout(e.state.timeout),e.state.timeout=setTimeout(Xs.redraw,250)}}),n=Tr("config",!0);let r;const s=[];if(window.authorizer.hasAccess("config",3)){r=Xs("button.primary",{title:"Create new config",onclick:()=>{let e=null;const t=Xs(si,Object.assign({actionHandler:(t,n)=>new Promise((r=>{qi(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)Zt("error",e);else vs(e);r(null)})).catch((e=>{Zt("error",e.message),r()}))}))},Bi));e=()=>t,gs(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New config");const e=[{name:"overview",prefix:"ui.overview.groups.",data:[]},{name:"charts",prefix:"ui.overview.charts.",data:[]},{name:"filters",prefix:"ui.filters.",data:[]},{name:"index page",prefix:"ui.index.",data:[]},{name:"device page",prefix:"ui.device.",data:[]}];if(n.fulfilled)for(const t of n.value)for(const n of e)if(t._id.startsWith(n.prefix)){n.data.push(t);break}for(const t of e){const e={prefix:t.prefix,name:t.name,data:t.data};s.push(Xs("button",{onclick:()=>{let n=null;const r=Xs(Wi,Object.assign({onUpdate:e=>{const r=e?Object.values(e):[];if(r.length)for(const e of r)Zt("error",e);else Zt("success",`${t.name.replace(/^[a-z]/,t.name[0].toUpperCase())} config updated`),vs(n);Fr(Date.now())},onError:e=>{Zt("error",e.message),Fr(Date.now()),vs(n)}},e));n=()=>r,gs(n,(()=>!r.state.modified||confirm("You have unsaved changes. Close anyway?")))}},`Edit ${t.name}`))}}return[Xs("h1","Listing Config"),Xs("loading",{queries:[n]},Xs(".all-parameters",t,Xs(".parameter-list",{style:"height: 400px"},Ji(n,e.state.searchString)),Xs(".actions-bar",[r].concat(s))))]}})}),Hi=Xt.ui.pageSize||10,Qi=Ht(Nt),Yi=Ht(JSON.parse),Zi=[{id:"role",label:"Role"},{id:"resource",label:"Resource",type:"combo",options:["config","devices","faults","files","permissions","users","presets","provisions","virtualParameters"]},{id:"filter",label:"Filter",type:"textarea"},{id:"access",label:"Access",type:"combo",options:["1: count","2: read","3: write"]},{id:"validate",label:"Validate",type:"textarea"}],Gi=Ht((e=>kt(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wo("permissions",e[2],e[3]):e))));function Xi(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){if(!o.role)return void r({role:"Role can not be empty"});if(!o.resource)return void r({resource:"Resource can not be empty"});if(!o.access)return void r({access:"Access can not be empty"});if("3: write"===o.access)o.access=3;else if("2: read"===o.access)o.access=2;else{if("1: count"!==o.access)return void r({access:"Invalid access level"});o.access=1}if(o.filter)try{o.filter=Pt(Qi(o.filter))}catch(e){return void r({filter:"Filter must be valid expression"})}if(o.validate)try{o.validate=Pt(Qi(o.validate))}catch(e){return void r({validate:"Validate must be valid expression"})}const e=`${o.role}:${o.resource}:${o.access}`;Kr("permissions",e).then((t=>t&&n?(Fr(Date.now()),void r({_id:"Permission already exists"})):t||n?void Jr("permissions",e,o).then((()=>{Zt("success","Permission "+(t?"updated":"created")),Fr(Date.now()),r(null)})).catch(s):(Fr(Date.now()),void r({_id:"Permission does not exist"})))).catch(s)}else"delete"===e?Br("permissions",o._id).then((()=>{Zt("success","Permission deleted"),Fr(Date.now()),r(null)})).catch((e=>{Fr(Date.now()),s(e)})):s(new Error("Undefined action"))}))}const ea={resource:"permissions",attributes:Zi},ta=Ht((e=>{const t={};for(const e of Zi)t[e.label]=e.id;return`api/permissions.csv?${Xs.buildQueryString({filter:Pt(e),columns:JSON.stringify(t)})}`}));const na=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("permissions",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Permissions - Coral Application";const t=e.attrs.sort?Yi(e.attrs.sort):{},n={};for(let e=0;e<Zi.length;e++){const r=Zi[e];"filter"!==r.id&&"validate"!==r.id&&(n[e]=t[r.id]||0)}let r=!e.attrs.filter||Qi(e.attrs.filter);r=Gi(r);const s=Tr("permissions",r,{limit:e.state.showCount||Hi,sort:t}),o=Mr("permissions",r),i=ta(r),a={};a.attributes=Zi,a.data=s.value,a.total=o.value,a.valueCallback=(e,t)=>{if("access"===e.id){const e=t.access;return 1===e?"1: count":2===e?"2: read":3===e?"3: write":e}return t[e.id]},a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Hi)+Hi,Xs.redraw()},a.sortAttributes=n,a.onSortChange=function(t){const n={};for(const e of t)n[Zi[Math.abs(e)-1].id]=Math.sign(e);const r={sort:JSON.stringify(n)};e.attrs.filter&&(r.filter=e.attrs.filter),Xs.route.set("/admin/permissions",r)},a.downloadUrl=i,window.authorizer.hasAccess("permissions",3)&&(a.recordActionsCallback=e=>{const t=e.access;return 1===t&&(e.access="1: count"),2===t&&(e.access="2: read"),3===t&&(e.access="3: write"),[Xs("a",{onclick:()=>{let t=null;const n=Xs(si,Object.assign({base:e,oncreate:e=>{e.dom.querySelector("input[name='role']").disabled=!0,e.dom.querySelector("select[name='access']").disabled=!0,e.dom.querySelector("select[name='resource']").disabled=!0},actionHandler:(e,n)=>new Promise((r=>{Xi(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)Zt("error",e);else vs(t);r()})).catch((e=>{Zt("error",e.message),r()}))}))},ea));t=()=>n,gs(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"Show")]},a.actionsCallback=e=>[Xs("button.primary",{title:"Create new permission",onclick:()=>{let e=null;const t=Xs(si,Object.assign({actionHandler:(t,n)=>new Promise((r=>{Xi(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)Zt("error",e);else vs(e);r()})).catch((e=>{Zt("error",e.message),r()}))}))},ea));e=()=>t,gs(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),Xs("button.primary",{title:"Delete selected permissions",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} permissions. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>Br("permissions",e)))).then((e=>{Zt("success",`${e.length} permissions deleted`),Fr(Date.now())})).catch((e=>{Zt("error",e.message),Fr(Date.now())})))}},"Delete")]);const l={resource:"permissions",filter:e.attrs.filter,onChange:function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),Xs.route.set("/admin/permissions",n)}};return[Xs("h1","Listing Permissions"),Xs(_o,l),Xs("loading",{queries:[s,o]},Xs(fo,a))]}})}),ra=Xt.ui.pageSize||10,sa=Ht(Nt),oa=Ht(JSON.parse),ia=[{id:"_id",label:"Username"},{id:"roles",label:"Roles",type:"multi",options:[]}],aa=Ht((e=>kt(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wo("users",e[2],e[3]):e))));function la(e,t,n){return new Promise(((r,s)=>{const o=Object.assign({},t);if("save"===e){const e=o._id,t=o.password,i=o.confirm;if(delete o._id,delete o.password,delete o.confirm,!e)return void r({_id:"ID can not be empty"});if(n){if(!t)return void r({password:"Password can not be empty"});if(t!==i)return void r({confirm:"Confirm password doesn't match password"})}if(!Array.isArray(o.roles)||!o.roles.length)return void r({roles:"Role(s) must be selected"});o.roles=o.roles.join(","),Kr("users",e).then((i=>i&&n?(Fr(Date.now()),void r({_id:"User already exists"})):i||n?void Jr("users",e,o).then((()=>{n?Qr(e,t).then((()=>{Zt("success","User created"),Fr(Date.now()),r(null)})).catch(s):(Zt("success","User updated"),Fr(Date.now()),r(null))})).catch(s):(Fr(Date.now()),void r({_id:"User does not exist"})))).catch(s)}else"delete"===e?Br("users",o._id).then((()=>{Zt("success","User deleted"),Fr(Date.now()),r(null)})).catch((e=>{Fr(Date.now()),s(e)})):s(new Error("Undefined action"))}))}const ca=Ht((e=>{const t={};for(const e of ia)t[e.label]=e.id;return`api/users.csv?${Xs.buildQueryString({filter:Pt(e),columns:JSON.stringify(t)})}`}));const ua=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("users",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Users - Coral Application";const t=e.attrs.sort?oa(e.attrs.sort):{},n={};for(let e=0;e<ia.length;e++){"roles"!==ia[e].id&&(n[e]=t[ia[e].id]||0)}let r=!e.attrs.filter||sa(e.attrs.filter);r=aa(r);const s=Tr("users",r,{limit:e.state.showCount||ra,sort:t}),o=Mr("users",r),i=Tr("permissions",!0);if(i.fulfilled)for(const e of ia)"roles"===e.id&&(e.options=[...new Set(i.value.map((e=>e.role)))]);const a=ca(r),l=window.authorizer.hasAccess("users",3),c={};if(c.attributes=ia,c.data=s.value,c.total=o.value,c.showMoreCallback=function(){e.state.showCount=(e.state.showCount||ra)+ra,Xs.redraw()},c.sortAttributes=n,c.onSortChange=function(t){const n={};for(const e of t)n[ia[Math.abs(e)-1].id]=Math.sign(e);const r={sort:JSON.stringify(n)};e.attrs.filter&&(r.filter=e.attrs.filter),Xs.route.set("/admin/users",r)},c.downloadUrl=a,c.recordActionsCallback=e=>[Xs("a",{onclick:()=>{let t=null;const n=Xs(si,Object.assign({base:{_id:e._id,roles:e.roles.split(",")},actionHandler:(e,n)=>new Promise((r=>{la(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)Zt("error",e);else vs(t);r()})).catch((e=>{Zt("error",e.message),r()}))}))},{resource:"users",attributes:ia}));t=()=>{const r=[n];if(l){r.push(Xs("hr"));const n={noAuth:!0,username:e._id,onPasswordChange:()=>{vs(t),Xs.redraw()}};r.push(Xs(ro,n))}return r},gs(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"Show")],l){const e={resource:"users",attributes:[ia[0],{id:"password",label:"Password",type:"password"},{id:"confirm",label:"Confirm password",type:"password"},ia[1]]};c.actionsCallback=t=>[Xs("button.primary",{title:"Create New User",onclick:()=>{let t=null;const n=Xs(si,Object.assign({actionHandler:(e,n)=>new Promise((r=>{la(e,n,!0).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)Zt("error",e);else vs(t);r()})).catch((e=>{Zt("error",e.message),r()}))}))},e));t=()=>n,gs(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),Xs("button.primary",{title:"Delete selected users",disabled:!t.size,onclick:e=>{confirm(`Deleting ${t.size} users. Are you sure?`)&&(e.redraw=!1,e.target.disabled=!0,Promise.all(Array.from(t).map((e=>Br("users",e)))).then((e=>{Zt("success",`${e.length} users deleted`),Fr(Date.now())})).catch((e=>{Zt("error",e.message),Fr(Date.now())})))}},"Delete")]}const u={resource:"users",filter:e.attrs.filter,onChange:function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),Xs.route.set("/admin/users",n)}};return[Xs("h1","Listing Users"),Xs(_o,u),Xs("loading",{queries:[s,o]},Xs(fo,c))]}})});window.authorizer=new class{constructor(e){this.permissionSets=e,this.validatorCache=new WeakMap,this.hasAccessCache=new Map,this.getFilterCache=new Map}hasAccess(e,t){const n=`${e}-${t}`;if(this.hasAccessCache.has(n))return this.hasAccessCache.get(n);let r=!1;for(const n of this.permissionSets)for(const s of n)if(s[e]&&s[e].access>=t){r=!0;break}return this.hasAccessCache.set(n,r),r}getFilter(e,t){const n=`${e}-${t}`;if(this.getFilterCache.has(n))return this.getFilterCache.get(n);let r=null;for(const n of this.permissionSets)for(const s of n)s[e]&&s[e].access>=t&&(r=Wt(r,s[e].filter));return this.getFilterCache.set(n,r),r}getValidator(e,t){if(this.validatorCache.has(t))return this.validatorCache.get(t);const n=[];for(const t of this.permissionSets)for(const r of t)r[e]&&r[e].access>=3&&r[e].validate&&n.push(r[e].validate);const r=(r,s,o)=>{if(!n.length)return!1;const i={mutationType:r,mutation:s,resourceType:e,object:t,options:o},a=Ft(n.length>1?["OR",n]:n[0],(e=>{const t=e.split(".",1)[0];e=e.slice(t.length+1);let n=null;if(["mutation","options"].includes(t)){n=i[t];for(const t of e.split("."))if(n=null!=n&&"object"!=typeof n?null:n[t],null==n)break}else i[t]&&(n=e?i[t][e]:i[t]);return n}),Date.now());return!Array.isArray(a)&&!!a};return this.validatorCache.set(t,r),r}getPermissionSets(){return this.permissionSets}}(window.permissionSets);const fa=["presets","provisions","virtualParameters","files","config","users","permissions"];let da;function ha(e,t){const n={render:()=>{const n=Date.now();let r;r=(null==da?void 0:da.error)?ce(Vo,da):ce(no(t.component),da);const s={};return s.page=e,s.oncreate=s.onupdate=()=>{!function(e){const t=[];for(const[n,r]of Object.entries(_r))for(const[s,o]of r.count)if(Dr.accessed.get(o)>=e){if(!(Dr.fulfilling.has(o)||Nr<=Dr.fulfilled.get(o))){Dr.fulfilling.add(o);let e=Dr.filter.get(o);e=zr(e),t.push(Ir({method:"HEAD",url:`api/${n}/?`+ce.buildQueryString({filter:Cr(e)}),extract:e=>{if(403===e.status)throw new Error("Not authorized");if(!e.status)throw new Error("Server is unreachable");if(200!==e.status)throw new Error(`Unexpected response status code ${e.status}`);return+e.getResponseHeader("x-total-count")},background:!1}).then((e=>{Dr.value.set(o,e),Dr.fulfilled.set(o,Nr),Dr.fulfilling.delete(o)})))}}else r.count.delete(s);const n={};for(const[r,s]of Object.entries(_r))for(const[o,i]of s.fetch)if(Dr.accessed.get(i)>=e){if(!(Dr.fulfilling.has(i)||Nr<=Dr.fulfilled.get(i))){Dr.fulfilling.add(i),n[r]=n[r]||[],n[r].push(i);const e=Dr.limit.get(i),s=Dr.sort.get(i);if(e){let n=Dr.filter.get(i);n=zr(n),t.push(Ir({method:"GET",url:`api/${r}/?`+ce.buildQueryString({filter:Cr(n),limit:1,skip:e-1,sort:JSON.stringify(s),projection:Object.keys(s).join(",")}),background:!0}).then((e=>{if(e.length){const t=Object.keys(s).reduce(((t,n)=>(null!=e[0][n]&&("object"==typeof e[0][n]?null!=e[0][n].value&&(t[n]=e[0][n].value[0]):t[n]=e[0][n]),t)),{});Dr.bookmark.set(i,t)}else Dr.bookmark.delete(i)})))}}}else s.fetch.delete(o);Promise.all(t).then((()=>{let e=!1;const t=[];for(const[r,s]of Object.entries(n)){let n=null;for(const e of s){let t=Dr.filter.get(e);t=Er(t,null,Nr+Pr);const r=Dr.bookmark.get(e),s=Dr.sort.get(e);r&&(t=Lr(t,s,r)),n=Wt(n,t)}const[o,i]=xr(_r[r].combinedFilter,n);if(!i){for(const t of s){let n=Dr.filter.get(t);n=Er(n,null,Nr+Pr);const s=Dr.limit.get(t),o=Dr.bookmark.get(t),i=Dr.sort.get(t);o&&(n=Lr(n,i,o)),Dr.value.set(t,Rr(r,n,i,s)),Dr.fulfilled.set(t,Nr),Dr.fulfilling.delete(t),e=!0}continue}let a=new Set;_r[r].combinedFilter||(a=new Set(_r[r].objects.keys()));const l=i;_r[r].combinedFilter=o,t.push(Ir({method:"GET",url:`api/${r}/?`+ce.buildQueryString({filter:Cr(l)}),background:!1}).then((e=>{for(const t of e){const e="devices"===r?t["DeviceID.ID"].value[0]:t._id;_r[r].objects.set(e,t),a.delete(e)}for(const e of a){const t=_r[r].objects.get(e);Ft(l,t,Nr+Pr)&&_r[r].objects.delete(e)}for(const e of s){let t=Dr.filter.get(e);t=zr(t);const n=Dr.limit.get(e),s=Dr.bookmark.get(e),o=Dr.sort.get(e);s&&(t=Lr(t,o,s)),Dr.value.set(e,Rr(r,t,o,n)),Dr.fulfilled.set(e,Nr),Dr.fulfilling.delete(e)}})))}return e&&ce.redraw(),Promise.all(t)})).catch((e=>{Zt("error",e.message)}))}(n)},ce(As,s,r)},onmatch:null};return n.onmatch=(e,n)=>(Fr(Date.now()),t.init?new Promise((r=>{t.init(e).then((e=>{e?(da=e,r()):ce.route.set("/")})).catch((e=>{!window.username&&e.message.indexOf("authorized")>=0&&(Zt("error",e.message),ce.route.set("/login",{continue:n})),da={error:e.message},r()}))})):(da=null,null)),n}ce.route(document.body,"/overview",{"/wizard":ha("wizard",xs),"/login":ha("login",so),"/overview":ha("overview",uo),"/devices":ha("devices",Uo),"/devices/:id":ha("devices",Fo),"/faults":ha("faults",Qo),"/admin":{onmatch:()=>{for(const e of fa)if(window.authorizer.hasAccess(e,2))return ce.route.set(`/admin/${e}`),null;return null}},"/admin/presets":ha("presets",hi),"/admin/provisions":ha("provisions",xi),"/admin/virtualParameters":ha("virtualParameters",Di),"/admin/files":ha("files",Ti),"/admin/config":ha("config",Ki),"/admin/users":ha("users",ua),"/admin/permissions":ha("permissions",na)});export{n as c};
//# sourceMappingURL=app.js.map
